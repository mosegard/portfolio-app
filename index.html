<!-- /*
 * PORTFOLIO MASTER - DATA SCHEMA & LOGIC GUIDE
 * ============================================
 * This application tracks portfolio performance (Danish Tax Compliance)
 * and manages bank balances across multiple currencies.
 *
 * INTENDED USE:
 * - Tracks realized gains/losses (Stock Realization Principle).
 * - Tracks unrealized gains for ETFs (Inventory Principle/Lagerbeskatning).
 * - Generates accurate Rubrik 66/38/345 figures for SKAT.
 * - Simulates bank account balances in their native currency.
 *
 * LIMITATIONS:
 * - Stocks & ETFs must use separate Types due to differing Danish tax rules.
 * - Corporate Actions (Spin-offs, Mergers) require manual cost-basis adjustment.
 *
 * CSV COLUMN DEFINITIONS (Strict Rules):
 * -------------------------------------------------------------------------
 * 1. Date        (DD-MM-YYYY) : Transaction date.
 * * 2. Type        (Enum)       : 
 * - 'Stock'    : Standard equity (Realization Tax).
 * - 'ETF'      : Exchange Traded Fund (Inventory Tax).
 * - 'Dividend' : Payout from a holding.
 * - 'Cash'     : Deposit/Withdrawal/Transfer/Interest.
 *
 * 3. Ticker      (String)     : Asset Symbol (e.g., 'NOVO-B', 'AAPL'). 
 * - REQUIRED for: Stock, ETF, Dividend.
 * - EMPTY for: Cash.
 *
 * 4. Qty         (Number)     : 
 * - Trades     : Number of shares (e.g., 10).
 * - Div/Cash   : The Gross Payout Amount (e.g., 100 USD).
 *
 * 5. Price       (Number)     : 
 * - Trades     : Price per share in 'Currency' (e.g., 150.50).
 * - Div/Cash   : LEAVE BLANK. (Logic treats this as '1').
 *
 * 6. Currency    (String)     : The currency of the 'Price' or 'Qty' (e.g., 'USD').
 * * 7. FxRate      (Number)     : The multiplier to convert Asset Currency -> DKK.
 * - SKAT requires the actual rate used on the transaction date.
 * - If Asset is DKK, this is 1. If USD, approx 7.5.
 *
 * 8. Commission  (Number)     : Trading fees (Kurtage) paid to the bank.
 * - USED FOR: Stock/ETF trades.
 * - CURRENCY: **Always the ACCOUNT'S currency.**
 * (e.g., If DKK Account, enter fees in DKK).
 *
 * 9. Withheld Tax (Number)    : Tax taken at source (Kildeskat/Udbytteskat).
 * - USED FOR: Dividends.
 * - CURRENCY: **Always the ACCOUNT'S currency.**
 * (Enter the DKK value deducted from your balance).
 *
 * 10. Account    (String)     : The Bank Account ID. 
 * - Determines the 'Balance' currency.
 * - Determines the currency of 'Commission' and 'Withheld Tax'.
 *
 * 11. Note       (String)     : Optional text description.
 */ -->


<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Portefølje</title>
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#f8fafc">
    <link rel="manifest" href="manifest.json" />
    <link rel="apple-touch-icon" href="icon.svg">
    <link rel="icon" type="image/svg+xml" href="icon.svg">
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/Recharts.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/da.js"></script>

    <style>
        body {
            background-color: #f8fafc;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            min-height: 100vh;
            overflow: auto;
        }

        .custom-scrollbar::-webkit-scrollbar {
            height: 6px;
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .input-base {
            transition: all 0.2s;
            outline: none;
            background: transparent;
        }

        .input-base:focus {
            background: white;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }

        .sticky-col-date {
            position: sticky;
            left: 0;
            z-index: 20;
        }

        .sticky-col-action {
            position: sticky;
            right: 0;
            z-index: 20;
        }

        /* Anonymity Blur Overlay */
        .anonymity-blur-overlay {
            position: fixed;
            inset: 0;
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(18px) brightness(1.08);
            transition: opacity 0.3s;
        }

        .anonymity-blur-icon {
            background: rgba(255, 255, 255, 0.85);
            border-radius: 50%;
            box-shadow: 0 2px 16px 0 rgba(0, 0, 0, 0.10);
            padding: 32px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: box-shadow 0.2s;
        }

        .anonymity-blur-icon:hover {
            box-shadow: 0 4px 32px 0 rgba(59, 130, 246, 0.15);
        }

        .anonymity-blur-icon i {
            font-size: 3rem;
            color: #2563eb;
        }

        .anonymity-blur-icon span {
            margin-top: 12px;
            font-size: 1rem;
            color: #2563eb;
            font-weight: 600;
        }

        .card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            border: 1px solid #e5e7eb;
            padding: 20px;
        }

        .nav-item {
            cursor: pointer;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            color: #4b5563;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.15s;
        }

        .nav-item:hover {
            background-color: #f3f4f6;
            color: #111827;
        }

        .nav-item.active {
            background-color: #eff6ff;
            color: #1d4ed8;
        }

        .sub-nav-item {
            cursor: pointer;
            padding: 6px 12px 6px 36px;
            font-size: 13px;
            color: #6b7280;
            border-radius: 6px;
            transition: all 0.15s;
            display: block;
        }

        .sub-nav-item:hover {
            color: #111827;
            background-color: #f9fafb;
        }

        .sub-nav-item.active {
            color: #1d4ed8;
            font-weight: 600;
            background-color: #eff6ff;
        }

        /* Disable hover effects on touch devices */
        body.touch-device .nav-item:hover,
        body.touch-device .sub-nav-item:hover,
        body.touch-device .card:hover,
        body.touch-device [class*="hover:"] {
            /* Remove hover styles for touch devices */
            background: inherit !important;
            color: inherit !important;
            border-color: inherit !important;
            box-shadow: none !important;
        }
    </style>
</head>

<body>

    <script>
        // Add 'touch-device' class to body if touch is supported
        if ('ontouchstart' in window || navigator.maxTouchPoints > 0) {
            document.addEventListener('DOMContentLoaded', function () {
                document.body.classList.add('touch-device');
            });
        }
    </script>
    <div id="root" class="h-full"></div>

    <script type="text/babel">
        const { useState, useMemo, useEffect, Component } = React;

        // --- CRASH HANDLER ---
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) {
                    return (
                        <div className="p-6 text-red-900 bg-red-50 h-screen flex flex-col items-center justify-center">
                            <h1 className="text-2xl font-bold mb-2">App Crashed</h1>
                            <div className="bg-white p-4 border border-red-200 rounded text-xs font-mono mb-4 w-full overflow-auto">
                                {this.state.error && this.state.error.toString()}
                            </div>
                            <button onClick={() => { localStorage.clear(); window.location.reload(); }} className="px-6 py-3 bg-red-600 text-white rounded-lg font-bold shadow">
                                Reset App & Clear Cache
                            </button>
                        </div>
                    );
                }
                return this.props.children;
            }
        }
        const { AreaChart, Area, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid, ReferenceLine, ReferenceArea, ComposedChart, Scatter } = Recharts;
        // --- UTILS ---
        const MONTHS_DK = ['jan', 'feb', 'mar', 'apr', 'maj', 'jun', 'jul', 'aug', 'sep', 'okt', 'nov', 'dec'];
        const CSV_COLUMNS = ['Date', 'Type', 'Ticker', 'Qty', 'Price', 'Currency', 'FxRate', 'Commission', 'Withheld Tax', 'Account', 'Note'];
        const TYPE_OPTIONS = ['Stock', 'ETF', 'Cash', 'Dividend', 'Option'];
        const CURRENCY_OPTIONS = ['DKK', 'USD', 'EUR', 'NOK', 'SEK', 'GBP'];

        const TAX_LIMITS = {
            '2026': 79400,
            '2025': 67500,
            '2024': 61000,
            '2023': 58900,
            '2022': 57200,
            '2021': 56500,
            '2020': 55300,
            '2019': 54000,
            '2018': 52900,
            '2017': 51700
        };

        const calculateDanishTax = (amount, limit) => {
            if (amount <= 0) return 0;
            if (amount <= limit) return amount * 0.27;
            return (limit * 0.27) + ((amount - limit) * 0.42);
        };

        const toPrettyDate = (danishDate) => {
            if (!danishDate || danishDate.length < 8) return danishDate;
            const [d, m, y] = danishDate.split('/');
            if (!d || !m || !y) return danishDate;

            const mName = MONTHS_DK[parseInt(m, 10) - 1];
            // Ensure day is zero-padded (e.g. "6" -> "06")
            const dPad = d.toString().padStart(2, '0');
            return `${dPad}-${mName}-${y}`;
        };

        const toIso = (danishDate) => {
            if (!danishDate || danishDate.length < 10) return '';
            const [d, m, y] = danishDate.split('/');
            if (!d || !m || !y) return '';
            return `${y}-${m}-${d}`;
        };

        // NEW: Convert YYYY-MM-DD (ISO from input) -> DD/MM/YYYY (Danish for storage)
        const fromIso = (isoDate) => {
            if (!isoDate) return '';
            const [y, m, d] = isoDate.split('-');
            return `${d}/${m}/${y}`;
        };

        const parseDanishNumber = (str) => {
            if (str == null || str === '') return 0;
            if (typeof str === 'number') return str;

            const s = String(str).trim();

            // If it contains a dot but NO comma, assume it's a standard JS/US number 
            // (This handles data coming back from GitHub Sync)
            if (s.includes('.') && !s.includes(',')) {
                const val = parseFloat(s);
                return isNaN(val) ? 0 : val;
            }

            // Otherwise, apply strict Danish Logic (Dots = Thousands, Comma = Decimal)
            const norm = s.replace(/\./g, '').replace(',', '.');
            const n = parseFloat(norm);
            return isNaN(n) ? 0 : n;
        };

        const parseDanishDate = (dateStr) => {
            if (!dateStr) return null;
            try {
                const parts = String(dateStr).trim().split(/[\/\.\s:]+/);
                if (parts.length < 3) return null;
                return new Date(parseInt(parts[2], 10), parseInt(parts[1], 10) - 1, parseInt(parts[0], 10));
            } catch { return null; }
        };

        const getLocalISO = (dateObj) => {
            if (!dateObj || isNaN(dateObj)) return '';
            const offset = dateObj.getTimezoneOffset() * 60000;
            return new Date(dateObj.getTime() - offset).toISOString().split('T')[0];
        };

        const formatDanishNumber = (val, decimals = 2) => {
            const n = parseDanishNumber(val);
            return new Intl.NumberFormat('da-DK', {
                minimumFractionDigits: 0,
                maximumFractionDigits: decimals
            }).format(n);
        };


        const formatCurrency = (val, currency = 'DKK') =>
            new Intl.NumberFormat('da-DK', { style: 'currency', currency }).format(val || 0);

        // Helper: Format currency with no decimals
        const formatCurrencyNoDecimals = (val, currency = 'DKK') =>
            new Intl.NumberFormat('da-DK', { style: 'currency', currency, minimumFractionDigits: 0, maximumFractionDigits: 0 }).format(val || 0);

        const normalizeDate = (rawStr) => {
            if (!rawStr) return '';
            const s = String(rawStr).trim();

            // 1. Split by any non-digit character (., -, /, space, :)
            const parts = s.split(/[^0-9]+/).filter(Boolean);

            // 2. If we have at least 3 parts (Day, Month, Year), reconstruct the date
            if (parts.length >= 3) {
                // Detection: If 1st part is 4 digits, assume ISO (YYYY-MM-DD) -> Convert to DD/MM/YYYY
                if (parts[0].length === 4) {
                    return `${parts[2]}/${parts[1]}/${parts[0]}`;
                }
                // Otherwise assume Danish/European (DD-MM-YYYY) -> Keep as DD/MM/YYYY
                // We intentionally ignore parts[3]+ (Time info)
                return `${parts[0]}/${parts[1]}/${parts[2]}`;
            }

            // Fallback
            return s;
        };

        const formatNumber2 = (val) => new Intl.NumberFormat('da-DK', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(parseDanishNumber(val) || 0);

        const displayDateToIso = (dStr) => {
            if (!dStr) return '';
            const parts = dStr.split('/');
            if (parts.length !== 3) return dStr;
            return `${parts[2]}-${parts[1]}-${parts[0]}`;
        };

        // --- IMPROVED CSV NORMALIZATION ---
        const determineType = (rawType, ticker, qty) => {
            const t = String(rawType || '').trim().toUpperCase();
            const typeMap = { 'STOCK': 'Stock', 'ETF': 'ETF', 'CASH': 'Cash', 'DIVIDEND': 'Dividend', 'OPTION': 'Option' };
            if (typeMap[t]) return typeMap[t];
            if (!t && ticker && parseDanishNumber(qty) !== 0) return 'Stock';
            return rawType || 'Cash';
        };

        const normalizeCurrency = (raw) => {
            const map = { 'DANISH KRONE': 'DKK', 'KR': 'DKK', '': 'DKK' };
            const up = String(raw || '').trim().toUpperCase();
            return map[up] || (CURRENCY_OPTIONS.includes(up) ? up : 'DKK');
        };

        const normalizeCsvRow = (row) => {
            // Legacy mapping (if loading old files, map Cost -> Commission by default)
            const legacyToNew = {
                'Dato': 'Date', 'Navn': 'Ticker', 'Antal': 'Qty', 'Kurs': 'Price',
                'Valuta': 'FxRate', 'Omkst./udbytteskat': 'Commission', // Map legacy cost to Commission
                'Konto': 'Account', 'Stock': 'Currency', 'Kilde': 'Note',
                'Cost': 'Commission' // Map English 'Cost' to 'Commission' for migration
            };

            const out = { ...row };
            Object.keys(legacyToNew).forEach((oldKey) => {
                if (out[oldKey] != null && out[legacyToNew[oldKey]] == null) {
                    out[legacyToNew[oldKey]] = out[oldKey];
                }
            });

            out['Date'] = normalizeDate(out['Date']);
            out['Ticker'] = String(out['Ticker'] || '').trim();
            out['Account'] = String(out['Account'] || '').trim();
            out['Note'] = String(out['Note'] || '').trim();

            const resolvedType = determineType(out['Type'], out['Ticker'], out['Qty']);
            out['Type'] = resolvedType;
            out['Currency'] = normalizeCurrency(out['Currency']);

            const rawFx = parseDanishNumber(out['FxRate']);
            out['FxRate'] = rawFx === 0 ? 1 : rawFx;

            // Price defaults to 1 for Cash/Dividend
            const priceDefault = (resolvedType === 'Cash' || resolvedType === 'Dividend') ? 1 : 0;
            out['Price'] = parseDanishNumber(out['Price'] || priceDefault);

            out['Qty'] = parseDanishNumber(out['Qty'] || 0);
            out['Commission'] = parseDanishNumber(out['Commission'] || 0);
            out['Withheld Tax'] = parseDanishNumber(out['Withheld Tax'] || 0);

            // If it's a Dividend and someone used the legacy 'Cost' mapping, move Commission -> Tax
            if (resolvedType === 'Dividend' && out['Commission'] !== 0 && out['Withheld Tax'] === 0) {
                out['Withheld Tax'] = out['Commission'];
                out['Commission'] = 0;
            }

            return out;
        };

        const normalizeAllRows = (rows) => rows.map(normalizeCsvRow);

        // --- VALIDATION HELPER ---
        const validateData = (rows) => {
            const errors = [];
            const validTypes = ['STOCK', 'ETF', 'CASH', 'DIVIDEND', 'OPTION', ''];

            rows.forEach((row, index) => {
                // Check 1: Valid Type
                const type = (row['Type'] || '').trim().toUpperCase();
                if (!validTypes.includes(type)) {
                    errors.push(`Row ${index + 1}: Invalid Type '${row['Type']}'`);
                }

                // Check 2: Valid Date
                const date = parseDanishDate(row['Date']);
                if (!date && row['Date']) {
                    errors.push(`Row ${index + 1}: Invalid Date '${row['Date']}'`);
                }

                // Check 3: Required fields for Trades AND Dividends
                if ((type === 'STOCK' || type === 'ETF' || type === 'DIVIDEND') && !row['Ticker']) {
                    errors.push(`Row ${index + 1}: ${type} missing Ticker symbol`);
                }

                // Check 4: Critical FxRate for non-DKK assets (Trades & Dividends)
                const cur = String(row['Currency'] || 'DKK').toUpperCase();
                const fx = row['FxRate'];

                // Logic: If it's foreign currency (not DKK) AND rate is missing or 1...
                if (cur !== 'DKK' && (!fx || fx === 1)) {
                    // ...and it's a relevant type (Stock, ETF, or Dividend)
                    if (['STOCK', 'ETF', 'DIVIDEND'].includes(type)) {
                        errors.push(`Row ${index + 1}: Critical — ${cur} ${row['Type']} has invalid FxRate (1.00). Tax report will be wrong.`);
                    }
                }
            });
            return errors;
        };

        // GitHub API
        function utf8_to_b64(str) { return window.btoa(unescape(encodeURIComponent(str))); }
        function b64_to_utf8(str) { return decodeURIComponent(escape(window.atob(str))); }

        // --- LOGIC ---
        function rowsToTransactions(rows) {
            const txs = [];
            rows.forEach((row, index) => {
                const date = parseDanishDate(row['Date']);
                if (!date) return;

                const typeRaw = (row['Type'] || '').trim();
                if (typeRaw.toUpperCase() === 'OPTION') return;

                const qty = row['Qty'];
                const source = (row['Note'] || '').toLowerCase();
                const ticker = (row['Ticker'] || '').toString().trim();
                let account = (row['Account'] || '').toString().trim();
                if (!account) account = '(Unspecified)';

                let txType = 'UNKNOWN';
                let assetCategory = 'Stock'; // Default

                // Trust the CSV 'Type' column (case-insensitive)
                if (typeRaw.toUpperCase() === 'ETF') {
                    assetCategory = 'ETF';
                    txType = qty >= 0 ? 'BUY' : 'SELL';
                }
                else if (typeRaw.toUpperCase() === 'STOCK') {
                    assetCategory = 'Stock';
                    txType = qty >= 0 ? 'BUY' : 'SELL';
                }
                else if (typeRaw.toUpperCase() === 'CASH') {
                    assetCategory = 'Cash';
                    if (source.includes('udbytte') || source.includes('dividend')) txType = 'DIVIDEND';
                    else if (source.includes('interest') || source.includes('rente')) txType = 'INTEREST';
                    else txType = 'TRANSFER';
                } else if (typeRaw.toUpperCase() === 'DIVIDEND') {
                    assetCategory = 'Cash';
                    txType = 'DIVIDEND';
                } else {
                    // Fallback for implicit types
                    if (ticker && qty !== 0 && ticker !== 'DKK') txType = qty >= 0 ? 'BUY' : 'SELL';
                }

                txs.push({
                    id: index,
                    raw: row,
                    date,
                    type: txType,
                    assetType: assetCategory,
                    ticker,
                    qty,
                    price: row['Price'],
                    fxRate: (row['FxRate'] || 1),
                    commission: row['Commission'],
                    tax: row['Withheld Tax'],
                    currency: row['Currency'],
                    account
                });
            });

            // Stable sort
            // Enhanced Sort: Date -> Buys First -> Original Order
            txs.sort((a, b) => {
                // 1. Date (Earliest first)
                const dateDiff = a.date - b.date;
                if (dateDiff !== 0) return dateDiff;

                // 2. Same Date? Process BUYS (positive Qty) before SELLS (negative Qty)
                // This ensures the Cost Basis pool is filled before we draw from it.
                if (a.qty >= 0 && b.qty < 0) return -1;
                if (a.qty < 0 && b.qty >= 0) return 1;

                // 3. Fallback to CSV order
                return a.id - b.id;
            });
            return txs;
        }

        // -- NUMBER INPUT COMPONENT ---
        const NumberInput = ({ row, fieldKey, rawKey, setRows, extraClass = "", title = "" }) => {
            // Safety check: If row is missing, don't render input to prevent crash
            if (!row) return null;

            // 1. Determine Value: Use the "Raw" buffer if user is typing, otherwise format the stored number
            const displayValue = row[rawKey] !== undefined
                ? row[rawKey]
                : formatDanishNumber(row[fieldKey], 10);

            // 2. Handle Change: Update the buffer (allow text like "10,")
            const handleChange = (e) => {
                const newVal = e.target.value;
                setRows(prev => {
                    const n = [...prev];
                    // Ensure the row exists before writing
                    if (n[row._idx]) {
                        n[row._idx] = { ...n[row._idx], [rawKey]: newVal };
                    }
                    return n;
                });
            };

            // 3. Handle Blur: Parse the buffer into a real number and clean up
            const handleBlur = () => {
                setRows(prev => {
                    const n = [...prev];
                    if (n[row._idx] && n[row._idx][rawKey] !== undefined) {
                        n[row._idx][fieldKey] = parseDanishNumber(n[row._idx][rawKey]);
                        // Remove the "Raw" key so we switch back to formatted view
                        delete n[row._idx][rawKey];
                    }
                    return n;
                });
            };

            // 4. Handle Enter Key: Blur and move focus
            const handleKeyDown = (e) => {
                if (e.key === 'Enter') {
                    e.target.blur();
                    // Simple navigation to next input in the row
                    const currentRow = e.target.closest('tr');
                    if (currentRow) {
                        const inputs = Array.from(currentRow.querySelectorAll('input, select'));
                        const index = inputs.indexOf(e.target);
                        const nextInput = e.shiftKey ? inputs[index - 1] : inputs[index + 1];
                        if (nextInput) nextInput.focus();
                    }
                }
            };

            return (
                <input
                    inputMode="decimal"
                    className={`w-16 input-base p-1 rounded text-right font-mono ${extraClass}`}
                    title={title}
                    value={displayValue}
                    onChange={handleChange}
                    onBlur={handleBlur}
                    onKeyDown={handleKeyDown}
                />
            );
        };

        // --- CUSTOM DATE PICKER COMPONENT ---
        const FlatpickrDate = ({ value, onChange, onKeyDown }) => {
            const inputRef = React.useRef(null);
            const fpRef = React.useRef(null);

            React.useEffect(() => {
                if (inputRef.current) {
                    // Initialize Flatpickr
                    fpRef.current = flatpickr(inputRef.current, {
                        defaultDate: value,      // Initial value (dd/mm/yyyy)
                        dateFormat: "d/m/Y",     // Format data is stored in
                        altInput: true,          // Enable the "Pretty" display input
                        altFormat: "d-M-Y",      // Format user sees: 06-apr-2020
                        locale: "da",            // Danish locale (months in lowercase)
                        allowInput: true,        // Allow manual typing
                        onChange: (selectedDates, dateStr) => {
                            // dateStr comes back in 'dateFormat' (d/m/Y), which is exactly what our app needs
                            onChange(dateStr);
                        }
                    });
                }
                return () => {
                    // Cleanup
                    if (fpRef.current) fpRef.current.destroy();
                };
            }, []); // Run once on mount

            // Sync external value changes if row is updated elsewhere
            React.useEffect(() => {
                if (fpRef.current && value) {
                    fpRef.current.setDate(value, false); // false = do not trigger onChange
                }
            }, [value]);

            return <input ref={inputRef} className="w-24 input-base p-1 rounded font-mono cursor-pointer" onKeyDown={onKeyDown} />;
        };

        // --- MODAL PORTAL (renders overlays at document.body to avoid layout shifts) ---
        const ModalPortal = ({ children, onBackdropClick, backdropClassName = "fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm" }) => {
            const elRef = React.useRef(null);
            if (!elRef.current) elRef.current = document.createElement('div');
            React.useEffect(() => {
                const el = elRef.current;
                document.body.appendChild(el);
                return () => { try { document.body.removeChild(el); } catch { } };
            }, []);
            return ReactDOM.createPortal(
                <div className={backdropClassName} onClick={(e) => { e.stopPropagation(); if (onBackdropClick) onBackdropClick(e); }}>
                    {children}
                </div>,
                elRef.current
            );
        };

        // --- APP COMPONENT ---

        function App() {
            const [lastUpdate, setLastUpdate] = useState(null);
            // State for Top Movers Modal
            const [showMoversModal, setShowMoversModal] = useState(false);
            const [config, setConfig] = useState({
                askAccount: '',
                currencies: {},
                hidden: []
            });
            const [rows, setRows] = useState([]);
            const [view, setView] = useState('dashboard');
            const [filterAccount, setFilterAccount] = useState('All');
            const [taxYear, setTaxYear] = useState(new Date().getFullYear().toString());
            const [mobileNavOpen, setMobileNavOpen] = useState(false);

            const [marketData, setMarketData] = useState(() => JSON.parse(localStorage.getItem('marketDataCache') || '{}'));
            // --- Anonymity Setting ---
            const [settings, setSettings] = useState(() => {
                let s = { proxyUrl: 'https://corsproxy.io/?', married: true, anonymityBlur: true, benchmarkTicker: '' };
                try {
                    const stored = JSON.parse(localStorage.getItem('portfolio_settings') || '{}');
                    s = { ...s, ...stored };
                } catch { }
                // If anonymityBlur is undefined, default to true
                if (typeof s.anonymityBlur === 'undefined') s.anonymityBlur = true;
                return s;
            });
            const [loading, setLoading] = useState(false);

            const [ghConfig, setGhConfig] = useState({ owner: '', repo: 'portfolio', path: 'portfolio-data.csv', token: '' });
            const [showSettings, setShowSettings] = useState(false);
            const [statusMsg, setStatusMsg] = useState('');
            const [fileSha, setFileSha] = useState(null);
            const [schemaErrors, setSchemaErrors] = useState([]);

            const [filters, setFilters] = useState({});
            const [splitParams, setSplitParams] = useState({ ticker: '', num: 2, den: 1, dateIso: '', startDateIso: '', endDateIso: '' });
            const [graphRange, setGraphRange] = useState('ALL'); // '1M', 'YTD', 'ALL'
            // Dashboard chart enhancements: custom zoom + selection + fullscreen
            const [customRange, setCustomRange] = useState({ startIso: '', endIso: '' });
            const [chartSelection, setChartSelection] = useState({ start: null, end: null, chart: null, dragging: false });
            const [fullscreenChart, setFullscreenChart] = useState(null); // 'growth' | 'value' | null
            const [selectedTickers, setSelectedTickers] = useState([]); // [] means All holdings; else compare selection

            // Track window size to ensure fullscreen charts re-render on resize
            const [winSize, setWinSize] = useState({ w: window.innerWidth, h: window.innerHeight });
            useEffect(() => {
                const onResize = () => setWinSize({ w: window.innerWidth, h: window.innerHeight });
                window.addEventListener('resize', onResize);
                return () => window.removeEventListener('resize', onResize);
            }, []);

            // Robust end drag: listen at window; disable text selection while dragging
            useEffect(() => {
                if (!chartSelection.dragging) return;
                const onWinMouseUp = () => {
                    setChartSelection(s => (s.start != null && s.end != null)
                        ? { ...s, dragging: false }
                        : { start: null, end: null, chart: null, dragging: false });
                };
                window.addEventListener('mouseup', onWinMouseUp);
                const prevSelect = document.body.style.userSelect;
                document.body.style.userSelect = 'none';
                return () => {
                    window.removeEventListener('mouseup', onWinMouseUp);
                    document.body.style.userSelect = prevSelect;
                };
            }, [chartSelection.dragging]);

            const [showGainModal, setShowGainModal] = useState(false);
            const [showLiquidationModal, setShowLiquidationModal] = useState(false);
            const [showAllocationModal, setShowAllocationModal] = useState(false);
            const [allocationMode, setAllocationMode] = useState('currency'); // 'currency' | 'country' | 'ticker'

            // --- Helpers: FX and Position Valuation ---
            const getFxRate = (cur) => {
                const C = (cur || '').toUpperCase();
                if (!C || C === 'DKK') return 1;
                const fxM = marketData[`${C}DKK=X`] || {};
                return (fxM.price ?? fxM.previousClose ?? 1);
            };

            const getPositionValue = (p) => {
                if (!p || Math.abs(p.qty) < 0.01) return 0;
                const m = marketData[p.ticker] || {};
                const price = m.price ?? m.previousClose ?? 0;
                const fxRate = getFxRate(p.cur);
                return p.qty * price * fxRate;
            };

            const getPositionValueWithPrev = (p) => {
                if (!p || Math.abs(p.qty) < 0.01) {
                    const fxRate = getFxRate(p?.cur);
                    return { val: 0, prevVal: 0, price: 0, prevClose: 0, fxRate };
                }
                const m = marketData[p.ticker] || {};
                const price = m.price ?? m.previousClose ?? 0;
                const prevClose = m.previousClose ?? price;
                const fxRate = getFxRate(p.cur);
                const val = p.qty * price * fxRate;
                const prevVal = p.qty * prevClose * fxRate;
                return { val, prevVal, price, prevClose, fxRate };
            };

            // --- Anonymity Blur State ---
            const [blurActive, setBlurActive] = useState(false);

            // Save settings to localStorage when changed
            useEffect(() => {
                try {
                    localStorage.setItem('portfolio_settings', JSON.stringify(settings));
                } catch { }
            }, [settings]);

            // Blur logic: listen for window blur/focus
            useEffect(() => {
                if (!settings.anonymityBlur) return;
                const onBlur = () => setBlurActive(true);
                window.addEventListener('blur', onBlur);
                return () => {
                    window.removeEventListener('blur', onBlur);
                };
            }, [settings.anonymityBlur]);

            // On mount, if window is not focused and setting is on, blur
            useEffect(() => {
                if (settings.anonymityBlur && document.hasFocus() === false) setBlurActive(true);
            }, [settings.anonymityBlur]);

            useEffect(() => {
                const saved = localStorage.getItem('gh_config');
                if (saved) setGhConfig(JSON.parse(saved));
            }, []);

            useEffect(() => {
                if (ghConfig.token && ghConfig.repo && rows.length === 0) loadFromGithub();
            }, [ghConfig]);

            useEffect(() => {
                try {
                    localStorage.setItem('marketDataCache', JSON.stringify(marketData));
                } catch (e) {
                    console.warn("Storage full: Could not cache market data.", e);
                    // Optional: If full, try to clear old data or just ignore
                }
            }, [marketData]);

            const txs = useMemo(() => rowsToTransactions(rows), [rows]);
            const uniqueTickers = useMemo(() => [...new Set(txs.map(t => t.ticker).filter(t => t && !['DKK', 'USD', 'EUR', 'GBP', 'SEK', 'NOK'].includes(t)))], [txs]);
            const accounts = useMemo(() => [...new Set(rows.map(r => r['Account']).filter(Boolean))].sort(), [rows]);
            const years = useMemo(() => {
                const yr = new Set(txs.map(t => t.date.getFullYear().toString()));
                yr.add(new Date().getFullYear().toString()); // Always include current year
                return [...yr].sort().reverse(); // Descending: most recent year first
            }, [txs]);

            const fetchMarketData = async (silent = false) => {
                if (!silent) setLoading(true);

                const now = Math.floor(Date.now() / 1000);

                // 1. Determine the Portfolio Start Date (The date of your very first trade ever)
                let globalStart = now - (2 * 365 * 24 * 60 * 60); // Default 2 years
                if (txs.length > 0) {
                    const firstTx = txs[0].date.getTime() / 1000;
                    globalStart = firstTx - (30 * 24 * 60 * 60); // Buffer 30 days
                }

                // Identify all tickers
                const usedCurrencies = [...new Set(txs.map(t => t.currency).filter(c => c && c !== 'DKK'))];
                const bench = settings.benchmarkTicker ? [settings.benchmarkTicker] : [];
                const allTickers = [...uniqueTickers, ...usedCurrencies.map(c => `${c}DKK=X`), ...bench];

                if (allTickers.length === 0) {
                    if (!silent) setLoading(false);
                    return;
                }

                const newMData = { ...marketData };

                await Promise.all(allTickers.map(async (ticker) => {
                    try {
                        // --- CORRECTED DATE LOGIC ---
                        // Default to Global Start (Crucial for Currencies like USDDKK=X)
                        let myStart = globalStart;

                        // Check if this is a specific Stock/ETF we traded
                        // (Currencies won't be in 'uniqueTickers', so they keep the global start)
                        if (uniqueTickers.includes(ticker)) {
                            const firstTx = txs.find(t => t.ticker === ticker);
                            if (firstTx) {
                                // For stocks, only fetch from the first purchase date to save space
                                myStart = (firstTx.date.getTime() / 1000) - (30 * 24 * 60 * 60);
                            }
                        }
                        // For benchmarks, use global start (already set)
                        // -----------------------------

                        const url = `https://query1.finance.yahoo.com/v8/finance/chart/${encodeURIComponent(ticker)}?period1=${Math.floor(myStart)}&period2=${now}&interval=1d&events=div`;
                        const res = await fetch(`${settings.proxyUrl}${encodeURIComponent(url)}`);
                        const json = await res.json();

                        if (json.chart?.result) {
                            const result = json.chart.result[0];
                            const meta = result.meta;
                            const quotes = result.indicators.quote[0];
                            const dates = result.timestamp;

                            // Compress: Round numbers to 2 decimals to save space
                            const cleanHistory = dates.map((t, i) => ({
                                date: new Date(t * 1000).toISOString().split('T')[0],
                                close: quotes.close[i] ? Number(quotes.close[i].toFixed(2)) : null
                            })).filter(x => x.close != null);

                            const livePrice = meta.regularMarketPrice;
                            let prevClose = livePrice;

                            if (cleanHistory.length >= 2) {
                                const lastCandle = cleanHistory[cleanHistory.length - 1];
                                const secondLastCandle = cleanHistory[cleanHistory.length - 2];
                                const isLastCandleToday = Math.abs(lastCandle.close - livePrice) / (livePrice || 1) < 0.0001;

                                if (isLastCandleToday) prevClose = secondLastCandle.close;
                                else prevClose = lastCandle.close;
                            } else if (cleanHistory.length === 1) {
                                prevClose = cleanHistory[0].close;
                            }

                            newMData[ticker] = {
                                ...newMData[ticker],
                                history: cleanHistory,
                                currency: meta.currency,
                                price: livePrice,
                                previousClose: prevClose,
                                lastTradeTime: meta.regularMarketTime,
                                lastUpdated: Date.now()
                            };
                        }
                    } catch (e) { console.warn("Fetch failed", ticker); }
                }));

                setMarketData(newMData);
                setLastUpdate(new Date());

                // Safe Save
                try {
                    localStorage.setItem('marketDataCache', JSON.stringify(newMData));
                } catch (e) {
                    console.warn("Storage full (QuotaExceeded). Cache not saved, but app will work.", e);
                }

                if (!silent) setLoading(false);
            };

            //  Auto-fetch on App Load (once tickers are known)
            useEffect(() => {
                // If we have tickers but no data yet (or it's been > 5 seconds since mount), fetch.
                if (uniqueTickers.length > 0 && !lastUpdate) {
                    fetchMarketData(false); // Show loading spinner for first load
                }
            }, [uniqueTickers.length]); // Runs when data is imported/loaded

            // Auto-refresh loop when on "Holdings" page
            useEffect(() => {
                let interval;
                if (view === 'holdings') {
                    // Fetch immediately if it's been more than 60s
                    if (lastUpdate && (Date.now() - lastUpdate.getTime() > 60000)) {
                        fetchMarketData(true);
                    }

                    // Set up 60s polling
                    interval = setInterval(() => {
                        fetchMarketData(true); // Silent update (background)
                    }, 60000);
                }
                return () => clearInterval(interval);
            }, [view, lastUpdate]); // Re-evaluates when view changes

            // --- MASTER CALCULATION ENGINE ---
            const calc = useMemo(() => {
                // =================================================================================
                // 1. INITIALIZATION
                // =================================================================================
                let portfolio = {};
                let totalValueGraph = [];
                let growthGraphData = [];
                const executionWarnings = [];

                // Track weighted average cost GLOBALLY for stocks (Realization Principle)
                const globalStockState = {};
                const yearIndex = {};

                const etfKeys = new Set();
                const askKeys = new Set();
                const keyInfo = {};
                const currencyMap = {};

                // --- HELPER: Tax Limits (Loud Failure) ---
                const getTaxLimit = (year) => {
                    if (TAX_LIMITS[year]) return TAX_LIMITS[year];
                    executionWarnings.push(`CRITICAL: Missing Tax Limit for year ${year}.`);
                    return 0;
                };

                // --- HELPER: Price Lookup (RESTORED FALLBACK) ---
                const getPrice = (t, dStr) => {
                    // 1. Try Market Data (Yahoo)
                    const m = marketData[t];
                    if (m?.history?.length) {
                        const hit = m.history.find(h => h.date === dStr);
                        if (hit) return hit.close;
                        const prev = m.history.filter(h => h.date < dStr);
                        if (prev.length) return prev[prev.length - 1].close;
                    }

                    // 2. Transaction Fallback (Restored)
                    // If no market data, use the last known transaction price.
                    // Iterate backwards for performance (txs is sorted by date)
                    for (let i = txs.length - 1; i >= 0; i--) {
                        const tx = txs[i];
                        // Only check this ticker, and ensure we don't look into the future relative to dStr
                        if (tx.ticker === t) {
                            const txDate = getLocalISO(tx.date);
                            if (txDate <= dStr) return tx.price;
                        }
                    }
                    return 0;
                };

                const getFx = (c, dStr) => {
                    if (!c || c === 'DKK') return 1;
                    const rate = getPrice(`${c}DKK=X`, dStr);
                    if (rate === 0) {
                        executionWarnings.push(`CRITICAL: Missing FX Rate for ${c} on ${dStr}.`);
                        return 1;
                    }
                    return rate;
                };

                // Init Reports
                const reports = {};
                const reportTemplate = () => ({
                    rubrik66: 0, rubrik38: 0, rubrik345: 0, rubrik61: 0, rubrik63: 0,
                    withheldTax: 0, askGain: 0, askTax: 0, paidTax: 0, paidAskTax: 0,
                    totalNormalTax: 0, breakdown: { stocks: [], etfs: [], dividends: [] },
                    utilizedLossNormal: 0, carriedLossNormal: 0,
                    utilizedLossAsk: 0, carriedLossAsk: 0
                });
                years.forEach(y => reports[y] = reportTemplate());

                const addToIndex = (y, key, tx) => {
                    if (!yearIndex[y]) yearIndex[y] = {};
                    if (!yearIndex[y][key]) yearIndex[y][key] = [];
                    yearIndex[y][key].push(tx);
                };

                // =================================================================================
                // 2. PASS 1: PROCESS TRANSACTIONS & REALIZATION
                // =================================================================================
                txs.forEach(tx => {
                    const y = tx.date.getFullYear().toString();
                    if (!reports[y]) reports[y] = reportTemplate();

                    const key = `${tx.ticker}_${tx.account}`;
                    const globalTickerKey = tx.ticker;
                    const isASK = tx.account === config.askAccount;
                    const isAssetETF = tx.assetType === 'ETF';

                    if (tx.assetType === 'Stock' || tx.assetType === 'ETF') {
                        addToIndex(y, key, tx);
                        if (!keyInfo[key]) {
                            keyInfo[key] = {
                                ticker: tx.ticker, account: tx.account, cur: tx.currency,
                                type: isAssetETF ? 'ETF' : 'Stock',
                                isInventory: isASK || isAssetETF
                            };
                            if (tx.currency) currencyMap[key] = tx.currency;
                            if (isASK) askKeys.add(key);
                            if (isAssetETF && !isASK) etfKeys.add(key);
                        }
                    }

                    if (!portfolio[key]) portfolio[key] = { ticker: tx.ticker, qty: 0, cost: 0, avg: 0, acc: tx.account, cur: tx.currency };
                    const pos = portfolio[key];

                    if (!isASK && !isAssetETF && !globalStockState[globalTickerKey]) {
                        globalStockState[globalTickerKey] = { totalQty: 0, totalCostDKK: 0, avgPriceDKK: 0 };
                    }
                    const glob = globalStockState[globalTickerKey];

                    const dStr = getLocalISO(tx.date);
                    const accCur = config.currencies[tx.account] || 'DKK';
                    const accFx = getFx(accCur, dStr);
                    const valDKK = Math.abs(tx.qty) * tx.price * tx.fxRate;
                    const commissionDKK = tx.commission * accFx;
                    const taxDKK = tx.tax * accFx;

                    if (tx.type === 'DIVIDEND') {
                        const amtDKK = tx.qty * (tx.price ?? 1) * tx.fxRate;
                        if (isASK) reports[y].askGain += amtDKK;
                        else {
                            if (tx.currency === 'DKK') reports[y].rubrik61 += amtDKK;
                            else reports[y].rubrik63 += amtDKK;
                            reports[y].withheldTax += (taxDKK || 0);
                            reports[y].breakdown.dividends.push({ date: dStr, ticker: tx.ticker, account: tx.account, amount: amtDKK, withheldTax: taxDKK || 0 });
                        }
                    }
                    else if (tx.qty < 0 && (tx.assetType === 'Cash' || tx.type === 'TRANSFER' || !tx.ticker)) {
                        const note = (tx.raw['Note'] || '').toLowerCase();
                        const yearMatch = note.match(/(?:skat|tax).*?(\d{4})/);
                        if (yearMatch) {
                            const targetYear = yearMatch[1];
                            if (reports[targetYear]) {
                                const amount = Math.abs(tx.qty * tx.fxRate);
                                if (tx.account === config.askAccount || note.includes('ask')) reports[targetYear].paidAskTax += amount;
                                else reports[targetYear].paidTax += amount;
                            }
                        }
                    }
                    else if (tx.type === 'BUY') {
                        pos.qty += tx.qty;
                        const totalCostDKK = valDKK + commissionDKK;

                        if (isASK || isAssetETF) {
                            pos.cost += totalCostDKK;
                            pos.avg = pos.qty ? pos.cost / pos.qty : 0;
                        } else {
                            glob.totalQty += tx.qty;
                            glob.totalCostDKK += totalCostDKK;
                            glob.avgPriceDKK = glob.totalQty ? glob.totalCostDKK / glob.totalQty : 0;
                        }
                    }
                    else if (tx.type === 'SELL') {
                        const proceeds = valDKK - commissionDKK;
                        const sellQty = Math.abs(tx.qty);
                        pos.qty -= sellQty;

                        if (isASK || isAssetETF) {
                            pos.cost -= (sellQty * pos.avg);
                        } else {
                            const costBasis = sellQty * glob.avgPriceDKK;
                            const gain = proceeds - costBasis;
                            glob.totalQty -= sellQty;
                            glob.totalCostDKK -= costBasis;
                            reports[y].rubrik66 += gain;
                            reports[y].breakdown.stocks.push({ date: dStr, ticker: tx.ticker, account: tx.account, qty: sellQty, gain, costBasis, proceeds });
                        }
                    }
                });

                // --- 2.5 SYNC STEP ---
                Object.values(portfolio).forEach(p => {
                    const pKey = `${p.ticker}_${p.acc}`;
                    if (!keyInfo[pKey]?.isInventory && globalStockState[p.ticker]) {
                        p.avg = globalStockState[p.ticker].avgPriceDKK;
                        p.cost = p.qty * p.avg;
                    }
                });

                // =================================================================================
                // 3. PASS 2: INVENTORY LOOP
                // =================================================================================
                const allYearsSorted = [...years].sort();
                const allInventoryKeys = new Set([...etfKeys, ...askKeys]);
                const runningQtyMap = {};
                allInventoryKeys.forEach(k => runningQtyMap[k] = 0);

                allYearsSorted.forEach(y => {
                    const primoDate = `${y}-01-01`;
                    const ultimoDate = `${y}-12-31`;

                    allInventoryKeys.forEach(key => {
                        const { ticker, account } = keyInfo[key];
                        const cur = currencyMap[key] || 'DKK';
                        const isAccountASK = account === config.askAccount;

                        const startQty = runningQtyMap[key];
                        const pricePrimo = getPrice(ticker, primoDate);
                        const fxPrimo = getFx(cur, primoDate);
                        const primoVal = startQty * pricePrimo * fxPrimo;

                        let flows = 0;
                        let yearTransactions = [];
                        const relevantTxs = (yearIndex[y] && yearIndex[y][key]) ? yearIndex[y][key] : [];

                        relevantTxs.forEach(tx => {
                            runningQtyMap[key] += tx.qty;
                            const dStr = getLocalISO(tx.date);
                            const valRaw = Math.abs(tx.qty * tx.price * tx.fxRate);
                            const accCur = config.currencies[tx.account] || 'DKK';
                            const costRaw = tx.commission * getFx(accCur, dStr);

                            if (tx.type === 'BUY') {
                                flows += (valRaw + costRaw);
                                yearTransactions.push({ date: dStr, type: 'Køb', qty: Math.abs(tx.qty), amount: valRaw + costRaw });
                            } else if (tx.type === 'SELL') {
                                flows -= (valRaw - costRaw);
                                yearTransactions.push({ date: dStr, type: 'Salg', qty: Math.abs(tx.qty), amount: valRaw - costRaw });
                            }
                        });

                        const endQty = runningQtyMap[key];
                        const priceUltimo = getPrice(ticker, ultimoDate);
                        const fxUltimo = getFx(cur, ultimoDate);
                        const ultimoVal = endQty * priceUltimo * fxUltimo;

                        const gain = ultimoVal - primoVal - flows;

                        if (primoVal !== 0 || ultimoVal !== 0 || flows !== 0) {
                            if (isAccountASK) reports[y].askGain += gain;
                            else {
                                reports[y].rubrik38 += gain;
                                reports[y].breakdown.etfs.push({ ticker, account, gain, primoQty: startQty, primoVal, ultimoQty: endQty, ultimoVal, netFlows: flows, transactions: yearTransactions });
                            }
                        }
                    });

                    reports[y].askTax = Math.max(0, reports[y].askGain * 0.17);
                    const r = reports[y];
                    const shareIncome = r.rubrik66 + r.rubrik38 + r.rubrik61 + r.rubrik63;
                    const limit = getTaxLimit(y) * (settings.married ? 2 : 1);
                    reports[y].totalNormalTax = calculateDanishTax(shareIncome, limit);
                    if (r.rubrik345 > 0) reports[y].totalNormalTax += r.rubrik345 * 0.42;
                });

                // =================================================================================
                // 4. PASS 3: LOSS CARRY FORWARD
                // =================================================================================
                let runningLossNormal = 0;
                let runningLossAsk = 0;

                allYearsSorted.forEach(y => {
                    const r = reports[y];
                    const shareIncomeRaw = r.rubrik66 + r.rubrik38 + r.rubrik61 + r.rubrik63;

                    if (shareIncomeRaw < 0) {
                        runningLossNormal += Math.abs(shareIncomeRaw);
                        r.carriedLossNormal = runningLossNormal;
                    } else {
                        if (runningLossNormal > 0) {
                            const used = Math.min(runningLossNormal, shareIncomeRaw);
                            r.utilizedLossNormal = used;
                            runningLossNormal -= used;
                        }
                        r.carriedLossNormal = runningLossNormal;
                    }

                    if (r.askGain < 0) {
                        runningLossAsk += Math.abs(r.askGain);
                        r.carriedLossAsk = runningLossAsk;
                    } else {
                        if (runningLossAsk > 0) {
                            const used = Math.min(runningLossAsk, r.askGain);
                            r.utilizedLossAsk = used;
                            runningLossAsk -= used;
                        }
                        r.carriedLossAsk = runningLossAsk;
                    }

                    const taxableShareIncome = Math.max(0, shareIncomeRaw - r.utilizedLossNormal);
                    const limit = getTaxLimit(y) * (settings.married ? 2 : 1);
                    r.totalNormalTax = calculateDanishTax(taxableShareIncome, limit);
                    if (r.rubrik345 > 0) r.totalNormalTax += r.rubrik345 * 0.42;

                    const taxableAsk = Math.max(0, r.askGain - r.utilizedLossAsk);
                    r.askTax = taxableAsk * 0.17;
                });

                // =================================================================================
                // 5. CURRENT VALUES & LIQUIDATION
                // =================================================================================
                let currentVal = 0;
                let costBasisTotal = 0;
                let unrealizedRubrik66Gain = 0;
                const todayStr = getLocalISO(new Date());
                const currentYear = new Date().getFullYear().toString();

                Object.values(portfolio).forEach(p => {
                    if (Math.abs(p.qty) < 0.01) return;
                    const price = getPrice(p.ticker, todayStr);
                    const fx = getFx(p.cur, todayStr);
                    const val = p.qty * price * fx;
                    currentVal += val;
                    costBasisTotal += (p.qty * p.avg);

                    const pKey = `${p.ticker}_${p.acc}`;
                    if (!keyInfo[pKey]?.isInventory) {
                        unrealizedRubrik66Gain += (val - (p.qty * p.avg));
                    }
                });

                const ytd = reports[currentYear] || reportTemplate();
                const liqAskGain = Math.max(0, (ytd.askGain || 0));
                const liquidationAskTax = Math.max(0, (Math.max(0, liqAskGain - (ytd.utilizedLossAsk || 0)) * 0.17) - (ytd.paidAskTax || 0));

                const totalRealizedYTD = (ytd.rubrik66 || 0) + (ytd.rubrik38 || 0) + (ytd.rubrik61 || 0) + (ytd.rubrik63 || 0);
                const hypoTotalIncome = totalRealizedYTD + unrealizedRubrik66Gain;
                const availableLoss = reports[parseInt(currentYear) - 1]?.carriedLossNormal || 0;
                const hypoTaxable = Math.max(0, hypoTotalIncome - availableLoss);
                const limit = getTaxLimit(currentYear) * (settings.married ? 2 : 1);

                let hypoTaxBill = calculateDanishTax(hypoTaxable, limit);
                hypoTaxBill += ((ytd.rubrik345 || 0) * 0.42);

                const liquidationNormalTax = Math.max(0, hypoTaxBill - (ytd.totalNormalTax || 0));
                const currentTax = liquidationAskTax + liquidationNormalTax;

                // =================================================================================
                // 6. GRAPHS (MODIFIED DIETZ)
                // =================================================================================
                let yearlyStats = [];
                const holdingGraphsByTicker = {};
                if (txs.length > 0) {
                    const timeTxs = [...txs].sort((a, b) => a.date - b.date);
                    let d = new Date(timeTxs[0].date);
                    const now = new Date();
                    const historyPortfolio = {};
                    let txCursor = 0;
                    let twrMultiplier = 1.0;
                    let prevDayValue = 0;

                    totalValueGraph.push({ date: getLocalISO(d), value: 0, invested: 0 });
                    growthGraphData.push({ date: getLocalISO(d), value: 0 });

                    while (d <= now) {
                        const dStr = getLocalISO(d);
                        let dayInvestedFlow = 0; // For Dietz (Return %) calc only
                        const holdingDayFlow = {}; // Per-ticker daily flows

                        while (txCursor < timeTxs.length && timeTxs[txCursor].date <= d) {
                            const tx = timeTxs[txCursor];
                            const key = `${tx.ticker}_${tx.account}`;
                            const accCur = config.currencies[tx.account] || 'DKK';
                            const accFx = getFx(accCur, dStr);

                            if (tx.assetType === 'Stock' || tx.assetType === 'ETF') {
                                if (!historyPortfolio[key]) historyPortfolio[key] = { qty: 0, cost: 0, cur: tx.currency, ticker: tx.ticker };
                                const p = historyPortfolio[key];
                                const tradeValDKK = (Math.abs(tx.qty) * tx.price * tx.fxRate);
                                const commDKK = (tx.commission * accFx);

                                if (tx.type === 'BUY') {
                                    // 1. Update Dietz Flow (Portfolio + Ticker)
                                    dayInvestedFlow += (tradeValDKK + commDKK);
                                    holdingDayFlow[tx.ticker] = (holdingDayFlow[tx.ticker] || 0) + (tradeValDKK + commDKK);

                                    // 2. Update Holdings
                                    p.qty += tx.qty;

                                    // 3. Update Historic Cost (Add purchase price + comm)
                                    p.cost += (tradeValDKK + commDKK);
                                } else if (tx.type === 'SELL') {
                                    // 1. Update Dietz Flow (Portfolio + Ticker)
                                    dayInvestedFlow -= (tradeValDKK - commDKK);
                                    holdingDayFlow[tx.ticker] = (holdingDayFlow[tx.ticker] || 0) - (tradeValDKK - commDKK);

                                    // 2. Update Historic Cost (Remove proportional cost of shares sold)
                                    // If we have 10 shares costing 1000, avg is 100. If we sell 2, we remove 200 cost.
                                    if (p.qty > 0) {
                                        const avgCost = p.cost / p.qty;
                                        const soldQty = Math.abs(tx.qty);
                                        p.cost -= (avgCost * soldQty);
                                    }

                                    // 3. Update Holdings
                                    p.qty -= Math.abs(tx.qty);
                                }
                            } else if (tx.type === 'DIVIDEND') {
                                const divValDKK = (tx.qty * (tx.price ?? 1) * tx.fxRate);
                                const taxDKK = (tx.tax * accFx);
                                dayInvestedFlow -= (divValDKK - taxDKK);
                            }
                            txCursor++;
                        }

                        let dayAssetValue = 0;
                        let dayInvestedSum = 0; // The sum of Cost Basis for currently held shares
                        const perTickerDayValue = {};
                        const perTickerInvested = {};

                        for (const key in historyPortfolio) {
                            const p = historyPortfolio[key];
                            if (Math.abs(p.qty) > 0.0001) {
                                const price = getPrice(p.ticker, dStr);
                                const fx = getFx(p.cur, dStr);
                                if (price) {
                                    const posVal = (p.qty * price * fx);
                                    dayAssetValue += posVal;
                                    const tkr = p.ticker;
                                    perTickerDayValue[tkr] = (perTickerDayValue[tkr] || 0) + posVal;
                                }

                                dayInvestedSum += p.cost;
                                const tkr2 = p.ticker;
                                perTickerInvested[tkr2] = (perTickerInvested[tkr2] || 0) + p.cost;
                            }
                        }

                        // MODIFIED DIETZ CALCULATION (0.5 Flow Weighting)
                        // This handles short-term RSU holds without spiking percentage returns
                        const adjustedStart = prevDayValue + (dayInvestedFlow * 0.5);
                        const dailyProfit = dayAssetValue - prevDayValue - dayInvestedFlow;

                        if (adjustedStart > 1) {
                            const dailyReturn = dailyProfit / adjustedStart;
                            twrMultiplier = twrMultiplier * (1 + dailyReturn);
                        }

                        prevDayValue = dayAssetValue;

                        if (twrMultiplier !== 1 || dayAssetValue > 0) {
                            totalValueGraph.push({ date: dStr, value: dayAssetValue, invested: dayInvestedSum });
                            growthGraphData.push({ date: dStr, value: (twrMultiplier - 1) * 100 });
                        }

                        // Update per-ticker series using Modified Dietz per holding
                        for (const tkr in perTickerDayValue) {
                            const curVal = perTickerDayValue[tkr] || 0;
                            const flow = holdingDayFlow[tkr] || 0;
                            if (!holdingGraphsByTicker[tkr]) {
                                holdingGraphsByTicker[tkr] = { twr: 1.0, prev: 0, value: [], growth: [] };
                            }
                            const h = holdingGraphsByTicker[tkr];
                            const adjustedStartH = h.prev + (flow * 0.5);
                            const dailyProfitH = curVal - h.prev - flow;
                            if (adjustedStartH > 1) {
                                const dailyReturnH = dailyProfitH / adjustedStartH;
                                h.twr = h.twr * (1 + dailyReturnH);
                            }
                            h.prev = curVal;
                            const inv = perTickerInvested[tkr] || 0;
                            h.value.push({ date: dStr, value: curVal, invested: inv });
                            h.growth.push({ date: dStr, value: (h.twr - 1) * 100 });
                        }
                        d.setDate(d.getDate() + 1);
                    }

                    // Yearly Stats Logic (Same as before)
                    if (totalValueGraph.length > 0) {
                        const firstYear = parseInt(totalValueGraph[0].date.slice(0, 4), 10);
                        const lastYear = parseInt(totalValueGraph[totalValueGraph.length - 1].date.slice(0, 4), 10);
                        const nearest = (target, dataset) => dataset.find(p => p.date >= target);

                        for (let y = lastYear; y >= firstYear; y--) {
                            const startNode = nearest(`${y}-01-01`, growthGraphData);
                            let endNode = nearest(`${y}-12-31`, growthGraphData);
                            if (y === new Date().getFullYear()) endNode = growthGraphData[growthGraphData.length - 1];
                            else if (!endNode) {
                                const yearData = growthGraphData.filter(p => p.date.startsWith(y.toString()));
                                if (yearData.length) endNode = yearData[yearData.length - 1];
                            }
                            let yearReturn = 0;
                            if (startNode && endNode) {
                                const startMult = 1 + (startNode.value / 100);
                                const endMult = 1 + (endNode.value / 100);
                                yearReturn = ((endMult / startMult) - 1) * 100;
                            }

                            let vStart = 0; let vEnd = 0;
                            const prevYearEnd = nearest(`${y - 1}-12-31`, totalValueGraph);
                            if (prevYearEnd) vStart = prevYearEnd.value;
                            else {
                                const prevYearData = totalValueGraph.filter(p => p.date.startsWith((y - 1).toString()));
                                if (prevYearData.length) vStart = prevYearData[prevYearData.length - 1].value;
                            }
                            const currYearEnd = nearest(`${y}-12-31`, totalValueGraph);
                            if (currYearEnd) vEnd = currYearEnd.value;
                            else if (y === new Date().getFullYear()) vEnd = totalValueGraph[totalValueGraph.length - 1].value;

                            let netInvested = 0;
                            let bankFlow = 0; let flowIn = 0; let flowOut = 0;

                            txs.forEach(tx => {
                                if (tx.date.getFullYear() === y) {
                                    const accCur = config.currencies[tx.account] || 'DKK';
                                    const accFx = getFx(accCur, getLocalISO(tx.date));
                                    if (tx.type === 'BUY') netInvested += (Math.abs(tx.qty) * tx.price * tx.fxRate) + (tx.commission * accFx);
                                    else if (tx.type === 'SELL') netInvested -= ((Math.abs(tx.qty) * tx.price * tx.fxRate) - (tx.commission * accFx));
                                    else if (tx.type === 'DIVIDEND') netInvested -= ((tx.qty * (tx.price ?? 1) * tx.fxRate) - (tx.tax * accFx));

                                    if (tx.assetType === 'Cash' && tx.type !== 'DIVIDEND' && tx.type !== 'INTEREST') {
                                        const val = (tx.qty * tx.fxRate);
                                        bankFlow += val;
                                        if (val > 0) flowIn += val; else flowOut += val;
                                    }
                                }
                            });

                            yearlyStats.push({
                                year: y,
                                return: yearReturn,
                                flow: bankFlow,
                                gainAbs: vEnd - vStart - netInvested,
                                breakdown: { in: flowIn, out: flowOut }
                            });
                        }
                    }
                }

                // =================================================================================
                // 7. LIFETIME / LIQUIDATION STATS
                // =================================================================================
                const historicalGain = Object.values(reports).reduce((acc, r) =>
                    acc + (r.rubrik66 || 0) + (r.rubrik38 || 0) + (r.rubrik345 || 0) + (r.rubrik61 || 0) + (r.rubrik63 || 0) + (r.askGain || 0), 0
                );

                const allTimeGain = historicalGain + unrealizedRubrik66Gain;

                // Summing CALCULATED Tax Liability
                const taxStats = Object.values(reports).reduce((acc, r) => ({
                    normalTaxBill: acc.normalTaxBill + (r.totalNormalTax || 0),
                    askTaxBill: acc.askTaxBill + (r.askTax || 0),
                    divWithheld: acc.divWithheld + (r.withheldTax || 0)
                }), { normalTaxBill: 0, askTaxBill: 0, divWithheld: 0 });

                const totalHistoricTaxCost = taxStats.normalTaxBill + taxStats.askTaxBill;
                const totalTaxBurden = totalHistoricTaxCost + currentTax;

                // Lifetime Net Flow
                const lifetimeNetInvested = yearlyStats.reduce((sum, y) => sum + (y.flow || 0), 0);

                // Effective Tax Rate
                const effectiveTaxRate = allTimeGain > 0 ? (totalTaxBurden / allTimeGain) * 100 : 0;

                // NEW: Structured Breakdown for the Modal
                const taxBreakdown = [
                    { label: 'Skat betalt af udbytte', val: taxStats.divWithheld, icon: 'ph-coins', color: 'text-green-600', bg: 'bg-green-50' },
                    { label: 'Skat af aktigevinster', val: Math.max(0, taxStats.normalTaxBill - taxStats.divWithheld), icon: 'ph-receipt', color: 'text-blue-600', bg: 'bg-blue-50' },
                    { label: 'ASK Skat', val: taxStats.askTaxBill, icon: 'ph-piggy-bank', color: 'text-teal-600', bg: 'bg-teal-50' },
                    { label: 'Urealiserede gevinster', val: currentTax, icon: 'ph-magic-wand', color: 'text-purple-600', bg: 'bg-purple-50', italic: true }
                ];

                const liquidation = {
                    netResult: currentVal - currentTax,
                    allTimeGain,
                    lifetimeNetInvested,
                    totalHistoricTaxCost,
                    totalTaxBurden,
                    effectiveTaxRate,
                    taxBreakdown
                };

                return {
                    portfolio, reports, totalValueGraph, growthGraphData,
                    currentVal, currentTax, costBasisTotal, liquidation,
                    liquidationNormalTax,
                    unrealizedStockGain: unrealizedRubrik66Gain, yearlyStats, warnings: executionWarnings,
                    holdingGraphsByTicker
                };


            }, [txs, marketData, settings]);

            // 2. HOLDINGS
            const renderHoldings = () => {
                let list = Object.values(calc.portfolio).filter(p => Math.abs(p.qty) > 0.01);

                // Sort by value (værdi) descending
                list = list.slice().sort((a, b) => {
                    const mA = marketData[a.ticker] || {};
                    const mB = marketData[b.ticker] || {};
                    const priceA = mA.price || 0;
                    const priceB = mB.price || 0;
                    const fxA = (marketData[`${a.cur}DKK=X`] || {}).price || 1;
                    const fxB = (marketData[`${b.cur}DKK=X`] || {}).price || 1;
                    const valA = a.qty * priceA * fxA;
                    const valB = b.qty * priceB * fxB;
                    return valB - valA;
                });

                const now = new Date();

                // --- CALCULATE TOTALS ---
                let totalVal = 0;
                let totalCost = 0;
                let totalUnrealized = 0;

                // Buckets for the "Total Day" row
                let dayGain_Active = 0;
                let prevVal_Active = 0;
                let activeCount = 0;

                let dayGain_All = 0;
                let prevVal_All = 0;

                list.forEach(p => {
                    const m = marketData[p.ticker] || {};
                    const { val, price, prevClose, fxRate } = getPositionValueWithPrev(p);

                    // 1. Calculate Value & Cost (Always Total)
                    const cost = p.qty * p.avg;
                    totalVal += val;
                    totalCost += cost;

                    // 2. Check if "Active Today"
                    const lastTrade = new Date((m.lastTradeTime || 0) * 1000);
                    const isToday = lastTrade.getDate() === now.getDate() &&
                        lastTrade.getMonth() === now.getMonth() &&
                        lastTrade.getFullYear() === now.getFullYear();

                    // 3. Calculate Day Gain for this specific stock
                    let dailyGainVal = 0;
                    if (price > 0 && prevClose > 0) {
                        const dailyDiff = price - prevClose;
                        dailyGainVal = dailyDiff * p.qty * fxRate;
                    }
                    const prevVal = val - dailyGainVal;

                    // 4. Add to "All" bucket (fallback for weekends)
                    dayGain_All += dailyGainVal;
                    prevVal_All += prevVal;

                    // 5. Add to "Active" bucket (if today)
                    if (isToday) {
                        activeCount++;
                        dayGain_Active += dailyGainVal;
                        prevVal_Active += prevVal;
                    }
                });

                totalUnrealized = totalVal - totalCost;
                const totalUnrealizedPct = totalCost > 0 ? (totalUnrealized / totalCost) * 100 : 0;

                // DECIDE WHICH TOTAL TO SHOW
                // If activeCount > 0, show ONLY active sum (Green/Red). 
                // Else show ALL sum (Grey) to indicate "Last known change".
                const showActiveTotal = activeCount > 0;
                const finalTotalDayGain = showActiveTotal ? dayGain_Active : dayGain_All;
                const finalTotalPrevVal = showActiveTotal ? prevVal_Active : prevVal_All;
                const finalTotalDayPct = finalTotalPrevVal > 0 ? (finalTotalDayGain / finalTotalPrevVal) * 100 : 0;

                return (
                    <div className="p-6 md:p-8 relative">
                        <div className="card">
                            <div className="overflow-x-auto">
                                <table className="w-full text-sm text-left">
                                    <thead className="bg-gray-50 text-xs uppercase text-gray-500">
                                        <tr>
                                            <th className="px-1 py-3 whitespace-nowrap">Ticker</th>
                                            <th className="px-1 py-3 text-right whitespace-nowrap hidden xl:table-cell">Antal</th>
                                            <th className="px-1 py-3 text-right whitespace-nowrap hidden sm:table-cell">Pris</th>
                                            <th className="px-1 py-3 text-right whitespace-nowrap">Dagsgevinst</th>
                                            <th className="px-1 py-3 text-right whitespace-nowrap">Dag %</th>
                                            <th className="px-1 py-3 text-right whitespace-nowrap hidden lg:table-cell">Værdi</th>
                                            <th className="px-1 py-3 text-right whitespace-nowrap">Gevinst/Tab</th>
                                            <th className="px-1 py-3 text-right whitespace-nowrap hidden sm:table-cell">%</th>
                                        </tr>
                                    </thead>

                                    {/* TOTALS ROW */}
                                    <tbody>
                                        <tr className="bg-gray-50 border-t-2 border-gray-300 font-bold text-gray-800">
                                            <td className="px-1 py-3 whitespace-nowrap flex items-center gap-2">
                                                Total
                                                {showActiveTotal && <span className="text-[9px] bg-blue-100 text-blue-800 px-1.5 rounded-full font-normal">Active</span>}
                                            </td>
                                            <td className="px-1 py-3 text-right whitespace-nowrap hidden xl:table-cell"></td>
                                            <td className="px-1 py-3 text-right whitespace-nowrap hidden sm:table-cell"></td>

                                            {/* Conditional Styling for Total Day Gain */}
                                            <td className={`px-1 py-3 text-right whitespace-nowrap ${!showActiveTotal ? 'text-gray-400' : (finalTotalDayGain >= 0 ? 'text-green-600' : 'text-red-600')
                                                }`}>
                                                {formatCurrency(finalTotalDayGain)}
                                            </td>
                                            <td className={`px-1 py-3 text-right whitespace-nowrap ${!showActiveTotal ? 'text-gray-400' : (finalTotalDayPct >= 0 ? 'text-green-600' : 'text-red-600')
                                                }`}>
                                                {formatNumber2(finalTotalDayPct)}%
                                            </td>

                                            <td className="px-1 py-3 text-right whitespace-nowrap hidden lg:table-cell">{formatCurrency(totalVal)}</td>
                                            <td className={`px-1 py-3 text-right whitespace-nowrap ${totalUnrealized >= 0 ? 'text-green-600' : 'text-red-600'}`}>{formatCurrency(totalUnrealized)}</td>
                                            <td className={`px-1 py-3 text-right whitespace-nowrap hidden sm:table-cell ${totalUnrealized >= 0 ? 'text-green-600' : 'text-red-600'}`}>{formatNumber2(totalUnrealizedPct)}%</td>
                                        </tr>
                                    </tbody>

                                    <tbody className="divide-y">
                                        {list.map(p => {
                                            const m = marketData[p.ticker] || {};
                                            const { val, price, prevClose, fxRate } = getPositionValueWithPrev(p);
                                            const gain = val - (p.qty * p.avg);
                                            const costBasis = (p.qty * p.avg);
                                            const pct = costBasis > 0 ? (gain / costBasis) * 100 : null;

                                            const lastTradeTime = m.lastTradeTime || 0;
                                            const lastTradeDate = new Date(lastTradeTime * 1000);
                                            const nowSec = Math.floor(Date.now() / 1000);
                                            const diffSeconds = nowSec - lastTradeTime;

                                            // Is this specific stock from today?
                                            const isStockToday = lastTradeDate.getDate() === now.getDate() &&
                                                lastTradeDate.getMonth() === now.getMonth() &&
                                                lastTradeDate.getFullYear() === now.getFullYear();

                                            // "Pulse" dot logic (active recently)
                                            const isMarketOpen = lastTradeTime > 0 && diffSeconds < 2700;

                                            let dailyGainVal = 0;
                                            let dailyPct = 0;
                                            let debugTitle = "No Data";

                                            if (price > 0 && prevClose > 0) {
                                                const dailyDiff = price - prevClose;
                                                dailyGainVal = dailyDiff * p.qty * fxRate;
                                                dailyPct = (dailyDiff / prevClose) * 100;
                                                debugTitle = `Live: ${price}\nPrev: ${prevClose}`;
                                            }

                                            return (
                                                <tr key={p.ticker + p.acc} className="hover:bg-gray-50">
                                                    { /* TICKER */}
                                                    <td className="px-1 py-3 font-medium text-gray-900 flex items-center gap-2 whitespace-nowrap">
                                                        <span
                                                            className={`w-2.5 h-2.5 rounded-full ${isMarketOpen ? 'bg-green-500 animate-pulse shadow-[0_0_5px_rgba(34,197,94,0.6)]' : 'bg-gray-300'}`}
                                                            title={isMarketOpen ? `Active (${Math.floor(diffSeconds / 60)}m ago)` : `Closed (${Math.floor(diffSeconds / 3600)}h ago)`}
                                                        ></span>
                                                        {p.ticker}
                                                    </td>

                                                    { /* Quantity */}
                                                    <td className="px-1 py-3 text-right whitespace-nowrap hidden xl:table-cell">{formatDanishNumber(p.qty, 10)}</td>

                                                    { /* Price */}
                                                    <td className="px-1 py-3 text-right font-mono font-medium text-blue-700 whitespace-nowrap hidden sm:table-cell">
                                                        {price > 0 ? <span>{formatNumber2(price)}</span> : <span className="text-red-300 text-xs">...</span>}
                                                    </td>

                                                    { /* Daily Gain (Greys out if not today) */}
                                                    <td className={`px-1 py-3 text-right font-medium whitespace-nowrap ${!isStockToday ? 'text-gray-400' : (dailyGainVal >= 0 ? 'text-green-600' : 'text-red-600')
                                                        }`}>
                                                        {price > 0 ? formatCurrency(dailyGainVal) : '-'}
                                                    </td>

                                                    { /* Daily % (Greys out if not today) */}
                                                    <td
                                                        className={`px-1 py-3 text-right border-b border-dotted border-gray-300 cursor-help whitespace-nowrap ${!isStockToday ? 'text-gray-400' : (dailyPct >= 0 ? 'text-green-600' : 'text-red-600')
                                                            }`}
                                                        title={debugTitle}
                                                    >
                                                        {price > 0 ? `${formatNumber2(dailyPct)}%` : '-'}
                                                    </td>

                                                    { /* Value */}
                                                    <td className="px-1 py-3 text-right font-bold whitespace-nowrap hidden lg:table-cell">{formatCurrency(val)}</td>
                                                    <td className={`px-1 py-3 text-right whitespace-nowrap ${gain >= 0 ? 'text-green-600' : 'text-red-600'}`}>{formatCurrency(gain)}</td>
                                                    <td className={`px-1 py-3 text-right whitespace-nowrap hidden sm:table-cell ${gain >= 0 ? 'text-green-600' : 'text-red-600'}`}>{pct === null ? '—' : `${formatNumber2(pct)}%`}</td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        {/* Last Update Indicator */}
                        <div className="absolute right-6 bottom-2 md:right-8 md:bottom-4 flex items-center gap-2 text-xs font-mono bg-gray-50 px-2 py-1 rounded border border-gray-100 shadow">
                            {loading ? (
                                <>
                                    <span className="w-2 h-2 rounded-full bg-blue-500 animate-ping"></span>
                                    <span className="text-blue-600 font-medium">Opdaterer...</span>
                                </>
                            ) : (
                                <span className="text-gray-400">
                                    Sidst opdateret: {lastUpdate ? lastUpdate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : 'Aldrig'}
                                </span>
                            )}
                        </div>
                    </div>
                );
            };

            // --- SPLIT DETECTIVE (Automated Scanner) ---
            const splitCandidates = useMemo(() => {
                const candidates = [];
                // Only look at "Buy" trades for Stocks/ETFs
                const buys = txs.filter(t => (t.type === 'BUY') && marketData[t.ticker] && marketData[t.ticker].history);

                buys.forEach(tx => {
                    const mData = marketData[tx.ticker];
                    const dStr = getLocalISO(tx.date);

                    // Find market close for that specific date (or closest before)
                    // We use the raw close price from Yahoo (which is split-adjusted)
                    const hit = mData.history.find(h => h.date === dStr) || mData.history.filter(h => h.date < dStr).pop();
                    if (!hit) return;

                    // Calculate Ratio: Your Price / Current Yahoo Historical Price
                    // Example: You paid 800. Yahoo says history is 80. Ratio is 10.
                    const ratio = tx.price / hit.close;

                    // Threshold: If deviation is significant (> 1.8x), it's likely a forward split
                    if (ratio > 1.8) {
                        const likelyRatio = Math.round(ratio); // e.g. 9.8 -> 10

                        // Check if we already have this ticker in the list to avoid duplicates
                        const exists = candidates.find(c => c.ticker === tx.ticker);

                        // Only add if it's a "clean" integer ratio (like 2, 3, 4, 10, 20) indicating a split
                        // or fairly close to one.
                        if (!exists && likelyRatio > 1) {
                            candidates.push({
                                ticker: tx.ticker,
                                date: dStr,
                                yourPrice: tx.price,
                                marketPrice: hit.close,
                                suggestedNum: likelyRatio,
                                suggestedDen: 1,
                                ratio: ratio
                            });
                        }
                    }
                });
                return candidates.sort((a, b) => b.ratio - a.ratio);
            }, [txs, marketData]);

            // --- VIEW RENDERERS ---
            const renderTaxReport = () => {
                // Ensure default values exist for new loss fields
                const r = calc.reports[taxYear] || {
                    rubrik66: 0, rubrik38: 0, rubrik345: 0, rubrik61: 0, rubrik63: 0, withheldTax: 0,
                    askGain: 0, askTax: 0, paidTax: 0, paidAskTax: 0, breakdown: { stocks: [], etfs: [], dividends: [] },
                    utilizedLossNormal: 0, carriedLossNormal: 0, utilizedLossAsk: 0, carriedLossAsk: 0
                };

                const currentYearStr = new Date().getFullYear().toString();
                const isCurrentYear = taxYear === currentYearStr;

                // --- 1. CALCULATIONS ---
                const shareIncome = (r.rubrik66 || 0) + (r.rubrik38 || 0) + (r.rubrik61 || 0) + (r.rubrik63 || 0);

                // Taxable Income = Gross Income - Utilized Loss
                const taxableIncome = Math.max(0, shareIncome - r.utilizedLossNormal);

                // Tax Limits (27% bracket limit)
                const limitBase = TAX_LIMITS[taxYear];
                const limitActual = limitBase * (settings.married ? 2 : 1);

                let taxBill = calculateDanishTax(taxableIncome, limitActual);

                // Capital Income Tax (Rubrik 345)
                const kapIncomeTax = (r.rubrik345 || 0) * 0.42;
                taxBill += kapIncomeTax;

                const taxToPay = Math.max(0, taxBill - (r.withheldTax || 0) - (r.paidTax || 0));
                const askTaxToPay = Math.max(0, (r.askTax || 0) - (r.paidAskTax || 0));

                // Progress Bar Calc
                const progressPct = Math.min(100, Math.max(0, (taxableIncome / limitActual) * 100));

                // --- Additional Planning Metrics (27% bracket & years to sell off) ---
                const unrealized = calc.unrealizedStockGain || 0;
                const remaining27Room = Math.max(0, limitActual - taxableIncome);
                const sellAt27Amount = Math.min(Math.max(0, unrealized), remaining27Room);
                const additionalTaxAt27 = sellAt27Amount * 0.27;
                const portionAt42Now = Math.max(0, unrealized - sellAt27Amount);
                const additionalTaxAt42 = portionAt42Now * 0.42;
                const optimalLiquidationTax = Math.max(0, unrealized) * 0.27; // Simplified: all realized under 27% over several years
                const yearsToSellAll = (() => {
                    if (unrealized <= 0) return 0;
                    if (remaining27Room >= unrealized) return 1; // all within this year's 27% bracket
                    const remainingAfterThisYear = unrealized - remaining27Room;
                    const extraYears = Math.ceil(remainingAfterThisYear / limitActual);
                    return 1 + extraYears; // current year + future years
                })();

                return (
                    <div className="p-6 md:p-8 space-y-6 max-w-6xl mx-auto animate-in fade-in duration-300">

                        {/* 1. SUMMARIES ROW */}
                        <div className="grid grid-cols-1 xl:grid-cols-2 gap-6">

                            {/* LEFT: NORMAL TAX (Frie Midler) */}
                            <div className="card flex flex-col h-full relative overflow-hidden">

                                {/* 1. Header & Hero Value */}
                                <div className="flex justify-between items-end mb-2">
                                    <div>
                                        <h3 className="font-bold text-lg text-gray-900 flex items-center gap-2">
                                            <i className="ph ph-briefcase text-blue-600"></i>Aktieindkomst
                                        </h3>
                                    </div>
                                    <div className="text-right">
                                        <div className={`text-xl font-bold leading-none ${taxableIncome >= 0 ? 'text-gray-900' : 'text-red-600'}`}>
                                            {formatCurrencyNoDecimals(taxableIncome)}
                                        </div>
                                    </div>
                                </div>
                                {/* 2. Minimalist Single-Line Bar */}
                                <div className="mb-8 flex items-center gap-3">
                                    {/* The Bar Track */}
                                    <div className="relative h-2.5 flex-1 bg-slate-100 rounded-full overflow-hidden">

                                        {/* Safe Zone (Blue) */}
                                        <div
                                            className="absolute top-0 left-0 h-full bg-blue-600 transition-all duration-500 ease-out"
                                            style={{
                                                width: `${Math.min(100, (Math.min(taxableIncome, limitActual) / Math.max(taxableIncome, limitActual)) * 100)}%`,
                                                zIndex: 2
                                            }}
                                        />

                                        {/* Danger Zone (Orange) - Appears if limit exceeded */}
                                        {taxableIncome > limitActual && (
                                            <div
                                                className="absolute top-0 left-0 h-full bg-orange-500 transition-all duration-500 ease-out"
                                                style={{
                                                    width: '100%',
                                                    // Visual trick: Clip the left side based on where the limit is
                                                    clipPath: `inset(0 0 0 ${Math.min(100, (limitActual / taxableIncome) * 100)}%)`
                                                }}
                                            />
                                        )}

                                        {/* Subtle white separator line to mark the 27/42 cut-off point */}
                                        <div
                                            className="absolute top-0 bottom-0 w-[2px] bg-white z-10 opacity-50 mix-blend-overlay"
                                            style={{
                                                left: `${taxableIncome > limitActual ? (limitActual / taxableIncome) * 100 : 100}%`
                                            }}
                                        />
                                    </div>

                                    {/* The Percentage Label */}
                                    <span className={`text-xs font-bold font-mono min-w-[3.5rem] text-right ${taxableIncome > limitActual ? 'text-orange-500' : 'text-blue-600'}`}>
                                        {taxableIncome > 0 ? ((taxBill / taxableIncome) * 100).toFixed(1) : '0.0'}%
                                    </span>
                                </div>

                                {/* 3. Rubrik List */}
                                <div className="space-y-3 mb-6 flex-1">
                                    {[
                                        { label: 'Gevinst/tab aktier', rubrik: '66', val: r.rubrik66 },
                                        { label: 'Gevinst/tab ETF', rubrik: '38', val: r.rubrik38 },
                                        { label: 'Udbytte (DK)', rubrik: '61', val: r.rubrik61 },
                                        { label: 'Udbytte (Udland)', rubrik: '63', val: r.rubrik63 },
                                    ].map((item, idx) => (
                                        <div key={idx} className="flex justify-between items-center text-sm border-b border-gray-50 pb-2 last:border-0">
                                            <div className="flex items-center gap-2">
                                                <span className="bg-gray-100 text-gray-600 font-mono text-[10px] font-bold px-1.5 py-0.5 rounded text-xs">
                                                    R{item.rubrik}
                                                </span>
                                                <span className="text-gray-600">{item.label}</span>
                                            </div>
                                            <span className={`font-mono font-medium ${item.val < 0 ? 'text-red-600' : 'text-gray-900'}`}>
                                                {item.val !== 0 ? formatCurrencyNoDecimals(item.val) : '—'}
                                            </span>
                                        </div>
                                    ))}

                                    {/* Utilized Loss */}
                                    {r.utilizedLossNormal > 0 && (
                                        <div className="flex justify-between items-center text-sm pt-2 text-green-700 bg-green-50 p-2 rounded border border-green-100">
                                            <div className="flex items-center gap-2">
                                                <i className="ph ph-arrow-u-down-left"></i>
                                                <span>Fradrag fra tidligere års tab</span>
                                            </div>
                                            <span className="font-mono font-bold">-{formatCurrencyNoDecimals(r.utilizedLossNormal)}</span>
                                        </div>
                                    )}

                                    {/* Carried Loss */}
                                    {r.carriedLossNormal > 0 && shareIncome < 0 && (
                                        <div className="flex justify-between items-center text-sm pt-2 text-gray-500 italic">
                                            <span>Tab til fremførsel (næste år)</span>
                                            <span className="font-mono">{formatCurrencyNoDecimals(r.carriedLossNormal)}</span>
                                        </div>
                                    )}

                                    {/* Capital Income */}
                                    {r.rubrik345 !== 0 && (
                                        <div className="flex justify-between items-center text-sm pt-2 mt-2 border-t border-gray-100 border-dashed">
                                            <div className="flex items-center gap-2">
                                                <span className="bg-purple-100 text-purple-700 font-mono text-[10px] font-bold px-1.5 py-0.5 rounded text-xs">R345</span>
                                                <span className="text-gray-600">Kapitalindkomst</span>
                                            </div>
                                            <span className="font-mono font-medium text-gray-900">{formatCurrencyNoDecimals(r.rubrik345)}</span>
                                        </div>
                                    )}
                                </div>

                                {/* 4. Summary Footer */}
                                <div className="bg-gray-50 -mx-5 -mb-5 p-5 border-t border-gray-100 rounded-b-xl mt-auto">
                                    <div className="space-y-1 text-sm mb-3">
                                        <div className="flex justify-between text-gray-500">
                                            <span>Beregnet skat</span>
                                            <span>{formatCurrencyNoDecimals(taxBill)}</span>
                                        </div>
                                        <div className="flex justify-between text-green-600">
                                            <span>Betalt udbytteskat</span>
                                            <span>-{formatCurrencyNoDecimals(r.withheldTax || 0)}</span>
                                        </div>
                                        {(r.paidTax || 0) > 0 && (
                                            <div className="flex justify-between text-green-600">
                                                <span>Allerede betalt</span>
                                                <span>-{formatCurrencyNoDecimals(r.paidTax)}</span>
                                            </div>
                                        )}
                                    </div>
                                    <div className="flex justify-between items-center pt-2 border-t border-gray-200">
                                        <span className="font-bold text-gray-900">Restskat</span>
                                        <span className={`font-bold text-xl ${taxToPay > 0 ? 'text-blue-600' : 'text-green-600'}`}>
                                            {formatCurrencyNoDecimals(taxToPay)}
                                        </span>
                                    </div>
                                </div>
                            </div>

                            {/* RIGHT: ASK (Aktiesparekonto) */}
                            <div className="card flex flex-col h-full">
                                {/* Header */}
                                <div className="flex justify-between items-start mb-6">
                                    <div>
                                        <h3 className="font-bold text-lg text-gray-900 flex items-center gap-2">
                                            <i className="ph ph-bank text-teal-600"></i> Aktiesparekonto
                                        </h3>
                                    </div>
                                    <div className="text-right">
                                        {/* Taxable ASK is Gain - Utilized Loss */}
                                        <div className={`text-xl font-bold ${r.askGain >= 0 ? 'text-gray-900' : 'text-red-600'}`}>{formatCurrencyNoDecimals(Math.max(0, r.askGain - r.utilizedLossAsk))}</div>
                                    </div>
                                </div>

                                {/* Body */}
                                <div className="flex-1">
                                    {r.askGain === 0 && r.askTax === 0 && r.utilizedLossAsk === 0 ? (
                                        <div className="flex flex-col items-center justify-center h-full pb-10 text-gray-400 text-sm italic">
                                            <i className="ph ph-prohibit text-2xl mb-2 text-gray-300"></i>
                                            Ingen aktivitet på ASK.
                                        </div>
                                    ) : (
                                        <div className="space-y-3 mb-6 mt-8">
                                            <div className="flex justify-between items-center text-sm border-b border-gray-50 pb-2">
                                                <div className="flex items-center gap-2">
                                                    <span className="bg-teal-50 text-teal-700 font-mono text-[10px] font-bold px-1.5 py-0.5 rounded text-xs">Lager</span>
                                                    <span className="text-gray-600">Gevinst/tab</span>
                                                </div>
                                                <span className="font-mono font-medium text-gray-900">{formatCurrencyNoDecimals(r.askGain)}</span>
                                            </div>

                                            {/* --- NEW: UTILIZED ASK LOSS --- */}
                                            {r.utilizedLossAsk > 0 && (
                                                <div className="flex justify-between items-center text-sm text-green-700 bg-green-50 p-2 rounded border border-green-100">
                                                    <div className="flex items-center gap-2">
                                                        <i className="ph ph-arrow-u-down-left"></i>
                                                        <span>Modregnet tab</span>
                                                    </div>
                                                    <span className="font-mono font-bold">-{formatCurrencyNoDecimals(r.utilizedLossAsk)}</span>
                                                </div>
                                            )}

                                            {/* --- NEW: CARRIED ASK LOSS --- */}
                                            {r.carriedLossAsk > 0 && r.askGain < 0 && (
                                                <div className="flex justify-between items-center text-sm text-gray-500 italic pb-2">
                                                    <span>Tab til fremførsel</span>
                                                    <span className="font-mono">{formatCurrencyNoDecimals(r.carriedLossAsk)}</span>
                                                </div>
                                            )}


                                        </div>
                                    )}
                                </div>

                                {/* Footer */}
                                <div className="bg-gray-50 -mx-5 -mb-5 p-5 border-t border-teal-100 rounded-b-xl mt-auto">
                                    <div className="space-y-1 text-sm mb-3">
                                        <div className="flex justify-between text-gray-500">
                                            <span>Beregnet skat</span>
                                            <span>{formatCurrencyNoDecimals(r.askTax)}</span>
                                        </div>
                                        {(r.paidAskTax || 0) > 0 && (
                                            <div className="flex justify-between text-green-600">
                                                <span>Allerede betalt</span>
                                                <span>-{formatCurrencyNoDecimals(r.paidAskTax)}</span>
                                            </div>
                                        )}
                                    </div>
                                    <div className="flex justify-between items-center pt-2 border-t border-gray-200">
                                        <span className="font-bold text-teal-900">Restskat</span>
                                        <span className="font-bold text-xl text-teal-700">{formatCurrencyNoDecimals(askTaxToPay)}</span>
                                    </div>


                                </div>
                            </div>
                        </div>

                        {/* Additional Tax if All Sold (Standalone) */}
                        {isCurrentYear && (
                            <div className="card">
                                <div className="mb-2 flex items-center justify-between">
                                    <h3 className="font-bold text-lg text-gray-900 flex items-center gap-2">
                                        <i className="ph ph-magic-wand text-purple-600"></i>
                                        Urealiserede gevinster
                                    </h3>
                                    <div className="text-right">
                                        <div className={`text-xl font-bold leading-none ${unrealized >= 0 ? 'text-gray-900' : 'text-red-600'}`}>
                                            {formatCurrencyNoDecimals(unrealized)}
                                        </div>
                                    </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    {/* Tile: Sell Everything Now */}
                                    <div className="p-4 rounded border border-gray-200 bg-white">
                                        <div className="text-xs font-bold text-gray-500 uppercase">Ekstra Skat</div>
                                        <div className="mt-1 text-2xl font-bold text-purple-700">{formatCurrencyNoDecimals(calc.liquidationNormalTax)}</div>
                                    </div>

                                    {/* Tile: Optimal Liquidation (27%) */}
                                    <div className="p-4 rounded border border-gray-200 bg-white">
                                        <div className="text-xs font-bold text-gray-500 uppercase">Ekstra skat - ved 27%</div>
                                        <div className="mt-1 text-2xl font-bold text-blue-700">{formatCurrencyNoDecimals(optimalLiquidationTax)}</div>
                                    </div>

                                    {/* Tile: Years to Complete */}
                                    <div className="p-4 rounded border border-gray-200 bg-white">
                                        <div className="text-xs font-bold text-gray-500 uppercase">År - ved 27%</div>
                                        <div className="mt-1 text-2xl font-bold text-gray-900">{yearsToSellAll}</div>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* 2. DETAILS SECTION (Full Width) */}
                        <div className="card">
                            <h3 className="font-bold text-lg mb-6 flex items-center gap-2">
                                <i className="ph ph-list-magnifying-glass"></i> Transaktionsdetaljer
                            </h3>

                            <div className="space-y-10">
                                {/* Stocks Table */}
                                <div>
                                    <h4 className="text-xs font-bold text-gray-500 uppercase mb-3 border-b border-gray-100 pb-2">Aktier (Realisationsprincip)</h4>
                                    {r.breakdown.stocks.length === 0 ? (
                                        <p className="text-sm text-gray-400 italic">Ingen realiserede aktiegevinster.</p>
                                    ) : (
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm text-left">
                                                <thead className="text-gray-500 bg-gray-50">
                                                    <tr>
                                                        <th className="py-2 px-3 rounded-l font-medium">Dato</th>
                                                        <th className="py-2 px-3 font-medium">Papir</th>
                                                        <th className="py-2 px-3 text-right font-medium">Antal</th>
                                                        <th className="py-2 px-3 text-right font-medium">Køb</th>
                                                        <th className="py-2 px-3 text-right font-medium">Salg</th>
                                                        <th className="py-2 px-3 rounded-r text-right font-medium">Gevinst</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-gray-100">
                                                    {r.breakdown.stocks.map((s, i) => (
                                                        <tr key={i} className="hover:bg-gray-50">
                                                            <td className="py-2 px-3 text-gray-500 whitespace-nowrap">{s.date}</td>
                                                            <td className="py-2 px-3 font-medium text-gray-900">{s.ticker} <span className="text-gray-400 font-normal text-xs ml-1">({s.account})</span></td>
                                                            <td className="py-2 px-3 text-right font-mono text-gray-600">{formatNumber2(s.qty)}</td>
                                                            <td className="py-2 px-3 text-right font-mono text-gray-600">{formatCurrency(s.costBasis)}</td>
                                                            <td className="py-2 px-3 text-right font-mono text-gray-600">{formatCurrency(s.proceeds)}</td>
                                                            <td className={`py-2 px-3 text-right font-mono font-bold ${s.gain >= 0 ? 'text-green-600' : 'text-red-600'}`}>
                                                                {formatCurrency(s.gain)}
                                                            </td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </div>

                                {/* Dividends Table */}
                                <div>
                                    <h4 className="text-xs font-bold text-gray-500 uppercase mb-3 border-b border-gray-100 pb-2">Udbytter</h4>
                                    {r.breakdown.dividends.length === 0 ? (
                                        <p className="text-sm text-gray-400 italic">Ingen udbytter.</p>
                                    ) : (
                                        <div className="overflow-x-auto">
                                            <table className="w-full text-sm text-left">
                                                <thead className="text-gray-500 bg-gray-50">
                                                    <tr>
                                                        <th className="py-2 px-3 rounded-l font-medium">Dato</th>
                                                        <th className="py-2 px-3 font-medium">Papir</th>
                                                        <th className="py-2 px-3 text-right font-medium">Brutto</th>
                                                        <th className="py-2 px-3 rounded-r text-right font-medium">Tilbageholdt Skat</th>
                                                    </tr>
                                                </thead>
                                                <tbody className="divide-y divide-gray-100">
                                                    {r.breakdown.dividends.map((d, i) => (
                                                        <tr key={i} className="hover:bg-gray-50">
                                                            <td className="py-2 px-3 text-gray-500 whitespace-nowrap">{d.date}</td>
                                                            <td className="py-2 px-3 font-medium text-gray-900">{d.ticker}</td>
                                                            <td className="py-2 px-3 text-right font-mono text-gray-900">{formatCurrency(d.amount)}</td>
                                                            <td className="py-2 px-3 text-right font-mono text-gray-500">{formatCurrency(d.withheldTax)}</td>
                                                        </tr>
                                                    ))}
                                                </tbody>
                                            </table>
                                        </div>
                                    )}
                                </div>

                                {/* ETF Table */}
                                <div>
                                    <h4 className="text-xs font-bold text-gray-500 uppercase mb-3 border-b border-gray-100 pb-2">ETF (Lagerbeskattet)</h4>
                                    {r.breakdown.etfs.length === 0 ? (
                                        <p className="text-sm text-gray-400 italic">Ingen ETF'er.</p>
                                    ) : (
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                            {r.breakdown.etfs.map((e, i) => (
                                                <div key={i} className="border border-gray-200 rounded p-3 hover:bg-gray-50">
                                                    <div className="flex justify-between items-center mb-2">
                                                        <span className="font-bold text-gray-900 text-sm">{e.ticker} <span className="font-normal text-gray-400 text-xs">({e.account})</span></span>
                                                        <span className={`font-mono font-bold text-sm ${e.gain >= 0 ? 'text-green-600' : 'text-red-600'}`}>{formatCurrency(e.gain)}</span>
                                                    </div>
                                                    <div className="text-[10px] text-gray-500 font-mono flex justify-between">
                                                        <span>Ultimo: {formatCurrencyNoDecimals(e.ultimoVal)}</span>
                                                        <span>Primo: {formatCurrencyNoDecimals(e.primoVal)}</span>
                                                        <span>Netto Køb: {formatCurrencyNoDecimals(e.netFlows)}</span>
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>

                            </div>
                        </div>
                    </div>
                );
            };

            // 1. DASHBOARD
            const renderDashboard = () => {

                const series = calc.totalValueGraph || [];

                // 1. FILTER DATA BASED ON RANGE
                const getFilteredData = (dataset, isGrowth = false) => {
                    if (dataset.length === 0) return [];
                    if (graphRange === 'ALL') return dataset;

                    // Custom zoom range
                    if (graphRange === 'CUSTOM' && customRange.startIso && customRange.endIso) {
                        const startIso = customRange.startIso <= customRange.endIso ? customRange.startIso : customRange.endIso;
                        const endIso = customRange.startIso <= customRange.endIso ? customRange.endIso : customRange.startIso;
                        let sliced = dataset.filter(d => d.date >= startIso && d.date <= endIso);
                        if (isGrowth && sliced.length > 0) {
                            const baseVal = sliced[0].value;
                            const baseMult = (baseVal / 100) + 1;
                            return sliced.map(d => {
                                const curMult = (d.value / 100) + 1;
                                const newVal = ((curMult / baseMult) - 1) * 100;
                                return { ...d, value: newVal };
                            });
                        }
                        return sliced;
                    }

                    const now = new Date();
                    let startDate = new Date();
                    let endDate = null;

                    if (graphRange === '1M') {
                        startDate.setMonth(now.getMonth() - 1);
                    } else if (graphRange === 'YTD') {
                        startDate = new Date(now.getFullYear(), 0, 1); // Jan 1st this year
                    } else if (!isNaN(Number(graphRange))) {
                        // Specific year selected
                        startDate = new Date(Number(graphRange), 0, 1);
                        endDate = new Date(Number(graphRange), 11, 31);
                    }

                    const isoStart = getLocalISO(startDate);
                    let sliced = dataset.filter(d => d.date >= isoStart);
                    if (endDate) {
                        const isoEnd = getLocalISO(endDate);
                        sliced = sliced.filter(d => d.date <= isoEnd);
                    }

                    // For Growth Graph: Re-base to 0% at start of period
                    if (isGrowth && sliced.length > 0) {
                        const baseVal = sliced[0].value;
                        // Convert % back to multiplier: 50% -> 1.5
                        const baseMult = (baseVal / 100) + 1;

                        return sliced.map(d => {
                            const curMult = (d.value / 100) + 1;
                            // Relative return: (Current / Base) - 1
                            const newVal = ((curMult / baseMult) - 1) * 100;
                            return { ...d, value: newVal };
                        });
                    }

                    return sliced;
                };

                const COLORS = ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#14b8a6', '#f43f5e', '#84cc16'];

                const isMulti = (selectedTickers || []).length > 1;
                const isSingle = (selectedTickers || []).length === 1;
                const sel = selectedTickers || [];

                const mergeByDate = (seriesMap) => {
                    const dateSet = new Set();
                    Object.values(seriesMap).forEach(arr => arr.forEach(d => dateSet.add(d.date)));
                    const dates = Array.from(dateSet).sort();
                    const maps = {};
                    Object.keys(seriesMap).forEach(t => { maps[t] = new Map(seriesMap[t].map(d => [d.date, d.value])); });
                    const latestCache = {};
                    const findLatest = (t, date) => {
                        const m = seriesMap[t];
                        if (!m || m.length === 0) return undefined;
                        // Simple linear search backwards; arrays are sorted by date
                        for (let i = m.length - 1; i >= 0; i--) { if (m[i].date <= date) return m[i].value; }
                        return undefined;
                    };
                    return dates.map(d => {
                        const row = { date: d };
                        Object.keys(seriesMap).forEach(t => {
                            const v = maps[t].get(d);
                            row[t] = (v !== undefined) ? v : findLatest(t, d);
                        });
                        return row;
                    });
                };

                const baseValue = isSingle ? (calc.holdingGraphsByTicker[sel[0]]?.value || []) : isMulti ? mergeByDate(Object.fromEntries(sel.map(t => [t, calc.holdingGraphsByTicker[t]?.value || []]))) : calc.totalValueGraph;
                const baseGrowth = isSingle ? (calc.holdingGraphsByTicker[sel[0]]?.growth || []) : isMulti ? mergeByDate(Object.fromEntries(sel.map(t => [t, calc.holdingGraphsByTicker[t]?.growth || []]))) : calc.growthGraphData;
                const displayValueData = getFilteredData(baseValue, false);
                const displayGrowthData = getFilteredData(baseGrowth, true);

                // Benchmark options (Yahoo Finance tickers)
                const BENCHMARKS = [
                    { label: 'Ingen', ticker: '' },
                    { label: 'All Country World', ticker: 'SPYY.DE' },
                    { label: 'Developed World', ticker: 'URTH' },
                    { label: 'Europe', ticker: 'XEU.TO' },
                    { label: 'S&P 500', ticker: '^GSPC' },
                    { label: 'NASDAQ 100', ticker: '^NDX' },
                    { label: 'Dow Jones', ticker: '^DJI' },
                    { label: 'DK C25', ticker: '^OMXC25' },
                    { label: 'Nvidia', ticker: 'NVDA' }
                ];
                const benchLabel = (BENCHMARKS.find(b => b.ticker === settings.benchmarkTicker) || BENCHMARKS[0]).label;

                // Build benchmark growth series aligned to displayGrowthData
                let mergedGrowthData = displayGrowthData;
                if (settings.benchmarkTicker) {
                    const hist = (marketData[settings.benchmarkTicker]?.history || []).slice();
                    if (hist.length > 0 && displayGrowthData.length > 0) {
                        // Create date->close map for fast lookup
                        const closeMap = new Map(hist.map(h => [h.date, h.close]));
                        // Determine base price: closest available on or before first display date
                        const startIso = displayGrowthData[0].date;
                        let basePrice = null;
                        // Try exact date, else search backwards in history
                        if (closeMap.has(startIso)) basePrice = closeMap.get(startIso);
                        if (basePrice == null) {
                            // find latest hist before startIso
                            let candidate = null;
                            for (let i = hist.length - 1; i >= 0; i--) {
                                if (hist[i].date <= startIso) { candidate = hist[i].close; break; }
                            }
                            basePrice = candidate ?? hist[0].close;
                        }
                        if (basePrice && basePrice > 0) {
                            // Compose merged growth data with benchmark % return
                            mergedGrowthData = displayGrowthData.map(d => {
                                // Find latest close on or before this date
                                let price = closeMap.get(d.date);
                                if (price == null) {
                                    // find latest before
                                    let p = null;
                                    for (let i = hist.length - 1; i >= 0; i--) {
                                        if (hist[i].date <= d.date) { p = hist[i].close; break; }
                                    }
                                    price = p ?? basePrice;
                                }
                                const benchRet = ((price / basePrice) - 1) * 100;
                                return { ...d, benchmark: benchRet };
                            });
                        }
                    }
                }

                const formatAxisDate = (dateStr) => {
                    if (!dateStr) return '';
                    // dateStr is "YYYY-MM-DD"
                    const [y, m, d] = dateStr.split('-');
                    const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'Maj', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dec'];
                    const monthName = monthNames[parseInt(m, 10) - 1];
                    const day = parseInt(d, 10); // Removes leading zero (01 -> 1)

                    // Logic: If range is ALL, show year. If 1M or YTD, hide year.
                    if (graphRange === 'ALL') {
                        return `${day}. ${monthName} ${y}`;
                    } else {
                        return `${day}. ${monthName}`;
                    }
                };

                // 2. CALCULATE TICKS & YEAR LINES
                // We only show Year Lines if we are in 'ALL' mode or have lots of data
                const showYearLines = graphRange === 'ALL';

                const firstDate = series.length ? series[0].date : null;
                const lastDate = series.length ? series[series.length - 1].date : null;
                const firstYear = firstDate ? parseInt(firstDate.slice(0, 4), 10) : null;
                const lastYear = lastDate ? parseInt(lastDate.slice(0, 4), 10) : null;

                let yearTicks = [];
                if (firstYear != null && lastYear != null) {
                    for (let y = firstYear + 1; y <= lastYear; y++) {
                        yearTicks.push(`${y}-01-01`);
                    }
                }

                // Range Selector Component (always dropdown)
                const RangeSelector = () => {
                    // Only show '1M', 'ALL' (as 'altid'), and years
                    const baseRanges = ['1M', 'ALL'];
                    const options = graphRange === 'CUSTOM' ? ['CUSTOM', ...baseRanges, ...years] : [...baseRanges, ...years];
                    const dropdownClass = "px-3 py-1 text-xs font-bold rounded-md bg-gray-100 border border-gray-200";
                    return (
                        <select
                            className={dropdownClass}
                            value={graphRange}
                            onChange={e => setGraphRange(e.target.value)}
                        >
                            {options.map(r => (
                                <option key={r} value={r}>
                                    {r === '1M' ? '1M' : r === 'ALL' ? 'Altid' : r === 'CUSTOM' ? 'ZOOM' : r}
                                </option>
                            ))}
                        </select>
                    );
                };

                const TickerSelector = () => {
                    const btnClass = "px-3 py-1 text-xs font-bold rounded-md bg-gray-100 border border-gray-200 flex items-center gap-1";
                    const tickers = uniqueTickers;
                    const [open, setOpen] = useState(false);
                    const [query, setQuery] = useState("");
                    const boxRef = React.useRef(null);
                    useEffect(() => {
                        if (!open) return;
                        const onClick = (e) => {
                            if (!boxRef.current) return;
                            if (!boxRef.current.contains(e.target)) setOpen(false);
                        };
                        window.addEventListener('mousedown', onClick);
                        return () => window.removeEventListener('mousedown', onClick);
                    }, [open]);

                    const selected = selectedTickers;
                    const label = selected.length === 0 ? 'Alle' : selected.length === 1 ? selected[0] : `${selected.length} valgt`;
                    const filtered = query
                        ? tickers.filter(t => t.toLowerCase().includes(query.toLowerCase()))
                        : tickers;

                    const toggleTicker = (t) => {
                        setSelectedTickers(prev => {
                            const has = prev.includes(t);
                            if (has) return prev.filter(x => x !== t);
                            return [...prev, t];
                        });
                    };

                    const clearAll = () => setSelectedTickers([]);

                    return (
                        <div className="relative" ref={boxRef}>
                            <button type="button" className={btnClass} onClick={() => setOpen(o => !o)} title="Vælg flere tickers">
                                <span>{label}</span>
                                <i className="ph ph-caret-down text-gray-500"></i>
                            </button>
                            {open && (
                                <div className="absolute top-full left-0 mt-1 z-40 w-56 bg-white border border-gray-200 rounded-md shadow-lg">
                                    <div className="p-2 border-b border-gray-100">
                                        <input
                                            type="text"
                                            className="w-full px-2 py-1 text-xs border border-gray-200 rounded-md"
                                            placeholder="Søg…"
                                            value={query}
                                            onChange={e => setQuery(e.target.value)}
                                        />
                                    </div>
                                    <div className="max-h-48 overflow-auto">
                                        <button className="w-full text-left px-3 py-2 text-xs hover:bg-gray-50 flex items-center gap-2" onClick={clearAll}>
                                            <input type="checkbox" readOnly checked={selected.length === 0} className="rounded" />
                                            <span>Alle</span>
                                        </button>
                                        {filtered.map((t, i) => (
                                            <button key={t} className="w-full text-left px-3 py-2 text-xs hover:bg-gray-50 flex items-center gap-2" onClick={() => toggleTicker(t)}>
                                                <input type="checkbox" readOnly checked={selected.includes(t)} className="rounded" />
                                                <span className="flex-1">{t}</span>
                                                <span className="inline-block w-2 h-2 rounded-full" style={{ backgroundColor: COLORS[i % COLORS.length] }}></span>
                                            </button>
                                        ))}
                                    </div>
                                    <div className="p-2 border-t border-gray-100 flex items-center justify-between">
                                        <button className="px-2 py-1 text-xs rounded-md border border-gray-200 hover:bg-gray-100" onClick={clearAll}>Nulstil</button>
                                        <button className="px-2 py-1 text-xs rounded-md bg-gray-800 text-white hover:bg-gray-700" onClick={() => setOpen(false)}>Færdig</button>
                                    </div>
                                </div>
                            )}
                        </div>
                    );
                };

                // 1. HELPER: Convert Date String (YYYY-MM-DD) to Unix Timestamp (number)
                const toUnix = (dateStr) => new Date(dateStr).getTime();

                // 2. PREPARE DATA: Convert date strings to numbers for the charts
                // We do this here so we don't mess up your original calculation logic
                const numericValueData = displayValueData.map(d => ({ ...d, date: toUnix(d.date) }));
                const numericGrowthData = mergedGrowthData.map(d => ({ ...d, date: toUnix(d.date) }));

                // 3. PREPARE TICKS: Convert your yearTicks to numbers
                const numericYearTicks = yearTicks.map(dateStr => toUnix(dateStr));

                // 3b. Prepare BUY/SELL markers from transactions mapped to chart domains

                // 4. FORMATTER: Handles the timestamp coming from the chart
                const formatAxisDateNumeric = (timestamp) => {
                    const date = new Date(timestamp);
                    // Convert back to YYYY-MM-DD to reuse your existing logic, or format directly here
                    const dateStr = date.toISOString().split('T')[0];
                    return formatAxisDate(dateStr);
                };

                const historicalGain = Object.values(calc.reports).reduce((acc, r) => acc + (r.rubrik66 || 0) + (r.rubrik38 || 0) + (r.rubrik345 || 0) + (r.rubrik61 || 0) + (r.rubrik63 || 0) + (r.askGain || 0), 0);
                const allTimeGain = historicalGain + (calc.unrealizedStockGain || 0);

                const currentYearReport = calc.reports[new Date().getFullYear().toString()] || {};

                // --- PREPARE BREAKDOWN DATA ---
                const bd = Object.values(calc.reports).reduce((acc, r) => ({
                    stocks: acc.stocks + (r.rubrik66 || 0),
                    etfs: acc.etfs + (r.rubrik38 || 0),
                    divs: acc.divs + (r.rubrik61 || 0) + (r.rubrik63 || 0),
                    capital: acc.capital + (r.rubrik345 || 0),
                    ask: acc.ask + (r.askGain || 0),
                }), { stocks: 0, etfs: 0, divs: 0, capital: 0, ask: 0 });

                const liq = calc.liquidation;
                const lifetimeNetInvested = calc.yearlyStats.reduce((sum, y) => sum + (y.flow || 0), 0);

                return (
                    <div className="p-6 md:p-8 space-y-8 animate-in fade-in duration-500 max-w-6xl mx-auto">

                        {/* --- VALUE ALLOCATION MODAL --- */}
                        {showAllocationModal && (
                            <ModalPortal onBackdropClick={() => setShowAllocationModal(false)}>
                                <div className="bg-white rounded-xl shadow-2xl max-w-md w-full overflow-hidden animate-in zoom-in-95 duration-200" onClick={e => e.stopPropagation()}>
                                    <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                                        <h3 className="font-bold text-gray-800 flex items-center gap-2">
                                            <i className="ph ph-wallet text-blue-600"></i> Værdi – Allokering
                                        </h3>
                                        <button onClick={() => setShowAllocationModal(false)} className="text-gray-400 hover:text-gray-700"><i className="ph ph-x text-lg"></i></button>
                                    </div>
                                    <div className="p-4 space-y-4">
                                        <div className="flex items-center gap-2">
                                            <button className={`px-3 py-1 rounded text-sm border ${allocationMode === 'currency' ? 'bg-blue-50 border-blue-300 text-blue-700' : 'bg-white border-gray-300 text-gray-700'}`} onClick={() => setAllocationMode('currency')}>Valuta</button>
                                            <button className={`px-3 py-1 rounded text-sm border ${allocationMode === 'country' ? 'bg-blue-50 border-blue-300 text-blue-700' : 'bg-white border-gray-300 text-gray-700'}`} onClick={() => setAllocationMode('country')}>Land</button>
                                            <button className={`px-3 py-1 rounded text-sm border ${allocationMode === 'ticker' ? 'bg-blue-50 border-blue-300 text-blue-700' : 'bg-white border-gray-300 text-gray-700'}`} onClick={() => setAllocationMode('ticker')}>Ticker</button>
                                        </div>

                                        {(() => {
                                            const mapCurrencyToCountry = (cur) => {
                                                const C = (cur || '').toUpperCase();
                                                if (C === 'DKK') return 'Danmark';
                                                if (C === 'USD') return 'USA';
                                                if (C === 'EUR') return 'Eurozone';
                                                if (C === 'GBP') return 'Storbritannien';
                                                if (C === 'SEK') return 'Sverige';
                                                if (C === 'NOK') return 'Norge';
                                                return C || 'Ukendt';
                                            };

                                            // Build allocation map
                                            const alloc = new Map();
                                            let total = 0;
                                            Object.values(calc.portfolio).forEach(p => {
                                                if (Math.abs(p.qty) < 0.01) return;
                                                const val = getPositionValue(p);
                                                total += val;
                                                let key = '';
                                                if (allocationMode === 'currency') key = p.cur || 'DKK';
                                                else if (allocationMode === 'country') key = mapCurrencyToCountry(p.cur);
                                                else key = p.ticker;
                                                alloc.set(key, (alloc.get(key) || 0) + val);
                                            });

                                            const items = Array.from(alloc.entries()).map(([label, val]) => ({ label, val })).sort((a, b) => b.val - a.val);

                                            if (items.length === 0) {
                                                return <div className="text-center text-gray-400 italic py-8">Ingen aktive beholdninger.</div>;
                                            }

                                            return (
                                                <div className="space-y-3">
                                                    {items.map((it, i) => {
                                                        const pct = total > 0 ? (it.val / total) * 100 : 0;
                                                        return (
                                                            <div key={i} className="space-y-1">
                                                                <div className="flex justify-between text-sm">
                                                                    <span className="text-gray-700 font-medium">{it.label}</span>
                                                                    <span className="font-mono text-gray-900">{formatCurrencyNoDecimals(it.val)} ({pct.toFixed(1)}%)</span>
                                                                </div>
                                                                <div className="h-2 bg-gray-100 rounded overflow-hidden">
                                                                    <div className="h-full bg-blue-500" style={{ width: `${pct.toFixed(1)}%` }}></div>
                                                                </div>
                                                            </div>
                                                        );
                                                    })}
                                                </div>
                                            );
                                        })()}
                                    </div>
                                </div>
                            </ModalPortal>
                        )}

                        {/* --- NEW: LIQUIDATION MODAL (Using Structured Breakdown) --- */}
                        {showLiquidationModal && (
                            <ModalPortal onBackdropClick={() => setShowLiquidationModal(false)}>
                                <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full overflow-hidden animate-in zoom-in-95 duration-200" onClick={e => e.stopPropagation()}>
                                    <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                                        <h3 className="font-bold text-gray-800 flex items-center gap-2">
                                            <i className="ph ph-money text-emerald-600"></i> Likvidationsværdi
                                        </h3>
                                        <button onClick={() => setShowLiquidationModal(false)} className="text-gray-400 hover:text-gray-700"><i className="ph ph-x text-lg"></i></button>
                                    </div>

                                    <div className="p-4 space-y-4">
                                        {/* 1. Net Cash Result */}
                                        <div className="text-center p-4 bg-emerald-50 rounded-xl border border-emerald-100">
                                            <div className="text-xs font-bold text-emerald-800 uppercase tracking-wide mb-1">Netto Udbetaling (Estimat)</div>
                                            <div className="text-3xl font-bold text-emerald-700 tracking-tight">
                                                {formatCurrencyNoDecimals(liq.netResult)}
                                            </div>
                                            <div className="text-[10px] text-emerald-600 mt-1">
                                                Værdi i dag minus estimeret restskat
                                            </div>
                                        </div>

                                        {/* 2. Tax Breakdown List */}
                                        <div className="space-y-3">
                                            <h4 className="text-xs font-bold text-gray-500 uppercase border-b border-gray-100 pb-1 mb-2">Skatteomkostninger</h4>

                                            {liq.taxBreakdown.map((item, i) => (
                                                <div key={i} className="flex justify-between items-center text-sm group">
                                                    <div className="flex items-center gap-3">
                                                        <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${item.bg} ${item.color}`}>
                                                            <i className={`ph ${item.icon}`}></i>
                                                        </div>
                                                        <span className={`text-gray-700 ${item.italic ? 'italic text-gray-500' : ''}`}>{item.label}</span>
                                                    </div>
                                                    <span className="font-mono font-medium text-gray-900">
                                                        -{formatCurrencyNoDecimals(item.val)}
                                                    </span>
                                                </div>
                                            ))}

                                            <div className="border-t border-gray-200 mt-4 pt-3 flex justify-between items-center">
                                                <span className="font-bold text-gray-900">Total Skattebyrde</span>
                                                <span className="font-bold text-lg text-red-600 font-mono">
                                                    -{formatCurrencyNoDecimals(liq.totalTaxBurden)}
                                                </span>
                                            </div>
                                        </div>

                                        {/* 3. Metrics */}
                                        <div className="grid grid-cols-2 gap-3 pt-2">
                                            <div className="bg-gray-50 p-2 rounded border border-gray-100">
                                                <div className="text-[10px] text-gray-500 uppercase">Effektiv Skat</div>
                                                <div className="text-lg font-bold text-gray-800">{liq.effectiveTaxRate.toFixed(1)}%</div>
                                            </div>
                                            <div className="bg-gray-50 p-2 rounded border border-gray-100">
                                                <div className="text-[10px] text-gray-500 uppercase">Netto Indskud</div>
                                                <div className="text-lg font-bold text-gray-800" title="Total indsat minus total hævet">
                                                    {formatCurrencyNoDecimals(liq.lifetimeNetInvested)}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </ModalPortal>
                        )}

                        {/* --- BREAKDOWN MODAL --- */}
                        {showGainModal && (
                            <ModalPortal onBackdropClick={() => setShowGainModal(false)}>
                                <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full overflow-hidden animate-in zoom-in-95 duration-200" onClick={e => e.stopPropagation()}>
                                    <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                                        <h3 className="font-bold text-gray-800 flex items-center gap-2">
                                            <i className="ph ph-chart-pie-slice text-blue-600"></i> Gevinstfordeling
                                        </h3>
                                        <button onClick={() => setShowGainModal(false)} className="text-gray-400 hover:text-gray-700"><i className="ph ph-x text-lg"></i></button>
                                    </div>
                                    <div className="p-4 space-y-3">
                                        {[
                                            { label: 'Realiseret Aktiegevinst', val: bd.stocks, icon: 'ph-trend-up', color: 'text-blue-600', bg: 'bg-blue-50' },
                                            { label: 'Lagerbeskattet (ETF)', val: bd.etfs, icon: 'ph-buildings', color: 'text-purple-600', bg: 'bg-purple-50' },
                                            { label: 'Udbytter', val: bd.divs, icon: 'ph-coins', color: 'text-green-600', bg: 'bg-green-50' },
                                            { label: 'Kapitalindkomst', val: bd.capital, icon: 'ph-bank', color: 'text-orange-600', bg: 'bg-orange-50' },
                                            { label: 'Aktiesparekonto', val: bd.ask, icon: 'ph-piggy-bank', color: 'text-teal-600', bg: 'bg-teal-50' },
                                            { label: 'Urealiseret (Aktier)', val: calc.unrealizedStockGain, icon: 'ph-hourglass', color: 'text-gray-600', bg: 'bg-gray-100', italic: true }
                                        ].map((item, i) => (
                                            <div key={i} className="flex justify-between items-center text-sm group">
                                                <div className="flex items-center gap-3">
                                                    <div className={`w-8 h-8 rounded-lg flex items-center justify-center ${item.bg} ${item.color}`}>
                                                        <i className={`ph ${item.icon}`}></i>
                                                    </div>
                                                    <span className={`text-gray-700 ${item.italic ? 'italic text-gray-500' : ''}`}>{item.label}</span>
                                                </div>
                                                <span className={`font-mono font-medium ${item.val >= 0 ? 'text-gray-900' : 'text-red-600'}`}>
                                                    {formatCurrencyNoDecimals(item.val)}
                                                </span>
                                            </div>
                                        ))}
                                        <div className="border-t border-gray-200 mt-4 pt-3 flex justify-between items-center">
                                            <span className="font-bold text-gray-900">Total</span>
                                            <span className={`font-bold text-lg ${allTimeGain >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>
                                                {formatCurrencyNoDecimals(allTimeGain)}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </ModalPortal>
                        )}

                        {/* --- FULLSCREEN CHART MODAL --- */}
                        {fullscreenChart && (
                            <ModalPortal onBackdropClick={() => setFullscreenChart(null)} backdropClassName="fixed inset-0 z-50 flex items-center justify-center p-0 bg-black/60">
                                <div className="w-screen h-screen bg-white flex flex-col" onClick={e => e.stopPropagation()}>
                                    <div className="h-12 px-4 border-b border-gray-200 flex items-center justify-between bg-gray-50">
                                        <div className="flex items-center gap-2">
                                            <i className="ph ph-arrows-in text-blue-600"></i>
                                            <span className="font-bold text-sm text-gray-800">{fullscreenChart === 'growth' ? 'Afkast (%)' : 'Porteføljens Værdi'}</span>
                                            {fullscreenChart === 'growth' && (!isMulti && settings.benchmarkTicker) && (() => {
                                                const last = numericGrowthData[numericGrowthData.length - 1];
                                                const diff = (last?.value ?? 0) - (last?.benchmark ?? 0);
                                                if (!isFinite(diff)) return null;
                                                return (
                                                    <span className={`ml-2 text-xs font-mono px-2 py-0.5 rounded ${diff >= 0 ? 'bg-emerald-50 text-emerald-700 border border-emerald-200' : 'bg-rose-50 text-rose-700 border border-rose-200'}`}>vs {benchLabel}: {diff >= 0 ? '+' : ''}{diff.toFixed(2)}%</span>
                                                );
                                            })()}
                                        </div>
                                        <div className="flex items-center gap-2">
                                            <RangeSelector />
                                            <TickerSelector />
                                            {/* Benchmark Selector */}
                                            <select
                                                className="px-3 py-1 text-xs font-bold rounded-md bg-gray-100 border border-gray-200"
                                                value={settings.benchmarkTicker}
                                                onChange={e => { setSettings(s => ({ ...s, benchmarkTicker: e.target.value })); fetchMarketData(true); }}
                                            >
                                                {BENCHMARKS.map(b => (<option key={b.ticker} value={b.ticker}>{b.label}</option>))}
                                            </select>
                                            <button className="px-2 py-1 text-xs rounded-md border border-gray-200 hover:bg-gray-100" onClick={() => setFullscreenChart(null)}>Luk</button>
                                        </div>
                                    </div>
                                    <div className={`flex-1 relative ${chartSelection.dragging ? 'select-none' : ''}`}>
                                        <ResponsiveContainer key={`${winSize.w}x${winSize.h}`} width="100%" height="100%">
                                            {fullscreenChart === 'growth' ? (
                                                <AreaChart data={numericGrowthData}
                                                    onMouseDown={(e) => { const se = e && e.sourceEvent; if (se && se.preventDefault) se.preventDefault(); if (e && e.activeLabel != null) setChartSelection({ start: e.activeLabel, end: null, chart: 'growth', dragging: true }); }}
                                                    onMouseMove={(e) => { if (chartSelection.dragging && chartSelection.chart === 'growth' && e && e.activeLabel != null) setChartSelection(s => ({ ...s, end: e.activeLabel })); }}
                                                    onMouseUp={() => { if (chartSelection.dragging && chartSelection.chart === 'growth' && chartSelection.start != null && chartSelection.end != null) setChartSelection(s => ({ ...s, dragging: false })); else setChartSelection({ start: null, end: null, chart: null, dragging: false }); }}
                                                    onMouseLeave={() => { setChartSelection(s => s.dragging ? (s.start != null && s.end != null) ? { ...s, dragging: false } : { start: null, end: null, chart: null, dragging: false } : s); }}
                                                >
                                                    <defs>
                                                        <linearGradient id="colorGrowthFs" x1="0" y1="0" x2="0" y2="1">
                                                            <stop offset="5%" stopColor="#10b981" stopOpacity={0.2} />
                                                            <stop offset="95%" stopColor="#10b981" stopOpacity={0} />
                                                        </linearGradient>
                                                    </defs>
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f3f4f6" />
                                                    <XAxis dataKey="date" type="number" domain={['dataMin', 'dataMax']} tickFormatter={formatAxisDateNumeric} ticks={graphRange === 'ALL' ? numericYearTicks : null} axisLine={false} tickLine={false} tick={{ fontSize: 12, fill: '#9ca3af' }} minTickGap={30} />
                                                    <YAxis width={60} axisLine={false} tickLine={false} tickFormatter={(v) => `${v.toFixed(0)}%`} tick={{ fontSize: 12, fill: '#9ca3af' }} />
                                                    <Tooltip formatter={(v) => `${v.toFixed(2)}%`} labelFormatter={formatAxisDateNumeric} />
                                                    <ReferenceLine y={0} stroke="#e5e7eb" strokeDasharray="3 3" />
                                                    {showYearLines && numericYearTicks.map(timestamp => (<ReferenceLine key={timestamp} x={timestamp} stroke="#e5e7eb" />))}
                                                    {(chartSelection.chart === 'growth' && chartSelection.start != null && chartSelection.end != null && !isMulti) && (
                                                        <ReferenceArea x1={Math.min(chartSelection.start, chartSelection.end)} x2={Math.max(chartSelection.start, chartSelection.end)} strokeOpacity={0.1} fill="#10b981" fillOpacity={0.1} />
                                                    )}
                                                    {isMulti
                                                        ? sel.map((t, i) => (
                                                            <Area key={`gfs-${t}`} type="monotone" dataKey={t} stroke={COLORS[i % COLORS.length]} strokeWidth={1} fill="none" isAnimationActive={false} />
                                                        ))
                                                        : <Area type="monotone" dataKey="value" stroke="#10b981" strokeWidth={1} fill="url(#colorGrowthFs)" isAnimationActive={false} />}
                                                    {(!isMulti && settings.benchmarkTicker) && (
                                                        <Area type="monotone" dataKey="benchmark" stroke="#f59e0b" strokeWidth={1} fill="none" isAnimationActive={false} />
                                                    )}
                                                    {/* Buy/Sell markers (fullscreen) */}
                                                </AreaChart>
                                            ) : (
                                                <AreaChart data={numericValueData}
                                                    onMouseDown={(e) => { const se = e && e.sourceEvent; if (se && se.preventDefault) se.preventDefault(); if (e && e.activeLabel != null) setChartSelection({ start: e.activeLabel, end: null, chart: 'value', dragging: true }); }}
                                                    onMouseMove={(e) => { if (chartSelection.dragging && chartSelection.chart === 'value' && e && e.activeLabel != null) setChartSelection(s => ({ ...s, end: e.activeLabel })); }}
                                                    onMouseUp={() => { if (chartSelection.dragging && chartSelection.chart === 'value' && chartSelection.start != null && chartSelection.end != null) setChartSelection(s => ({ ...s, dragging: false })); else setChartSelection({ start: null, end: null, chart: null, dragging: false }); }}
                                                    onMouseLeave={() => { setChartSelection(s => s.dragging ? (s.start != null && s.end != null) ? { ...s, dragging: false } : { start: null, end: null, chart: null, dragging: false } : s); }}
                                                >
                                                    <defs>
                                                        <linearGradient id="colorValFs" x1="0" y1="0" x2="0" y2="1">
                                                            <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.2} />
                                                            <stop offset="95%" stopColor="#3b82f6" stopOpacity={0} />
                                                        </linearGradient>
                                                    </defs>
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f3f4f6" />
                                                    <XAxis dataKey="date" type="number" domain={['dataMin', 'dataMax']} tickFormatter={formatAxisDateNumeric} ticks={graphRange === 'ALL' ? numericYearTicks : null} axisLine={false} tickLine={false} tick={{ fontSize: 12, fill: '#9ca3af' }} minTickGap={30} />
                                                    <YAxis width={60} axisLine={false} tickLine={false} domain={['dataMin', 'dataMax']} tickFormatter={(v) => `${(v / 1000).toFixed(0)}k`} tick={{ fontSize: 12, fill: '#9ca3af' }} />
                                                    <Tooltip formatter={(v) => formatCurrency(v)} labelFormatter={formatAxisDateNumeric} />
                                                    {showYearLines && numericYearTicks.map(timestamp => (<ReferenceLine key={timestamp} x={timestamp} stroke="#e5e7eb" />))}
                                                    {(chartSelection.chart === 'value' && chartSelection.start != null && chartSelection.end != null && !isMulti) && (
                                                        <ReferenceArea x1={Math.min(chartSelection.start, chartSelection.end)} x2={Math.max(chartSelection.start, chartSelection.end)} strokeOpacity={0.1} fill="#2563eb" fillOpacity={0.1} />
                                                    )}
                                                    {isMulti
                                                        ? sel.map((t, i) => (
                                                            <Area key={`vfs-${t}`} type="monotone" dataKey={t} stroke={COLORS[i % COLORS.length]} strokeWidth={1} fill="none" isAnimationActive={false} />
                                                        ))
                                                        : <>
                                                            <Area type="step" dataKey="invested" stroke="#9ca3af" strokeWidth={1} strokeDasharray="4 4" fill="none" isAnimationActive={false} />
                                                            <Area type="monotone" dataKey="value" stroke="#2563eb" strokeWidth={1} fill="url(#colorValFs)" isAnimationActive={false} />
                                                          </>}
                                                    {/* Buy/Sell markers (fullscreen) */}
                                                </AreaChart>
                                            )}
                                        </ResponsiveContainer>
                                        {/* Selection overlay in fullscreen */}
                                        {fullscreenChart === 'growth' && chartSelection.chart === 'growth' && chartSelection.start != null && chartSelection.end != null && !isMulti && (() => {
                                            const startTs = Math.min(chartSelection.start, chartSelection.end);
                                            const endTs = Math.max(chartSelection.start, chartSelection.end);
                                            const inRange = numericGrowthData.filter(d => d.date >= startTs && d.date <= endTs);
                                            if (inRange.length < 2) return null;
                                            const startVal = inRange[0].value;
                                            const endVal = inRange[inRange.length - 1].value;
                                            const abs = endVal - startVal;
                                            return (
                                                <div className="absolute top-4 right-4 bg-white/95 backdrop-blur rounded-md border border-gray-200 shadow-sm px-3 py-2 flex items-center gap-2">
                                                    <div className={`text-sm font-mono ${abs >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>{abs >= 0 ? '+' : ''}{abs.toFixed(2)}%</div>
                                                    <button className="text-xs px-2 py-1 rounded-md border border-gray-200 hover:bg-gray-100" onClick={() => {
                                                        const toIso = (ts) => new Date(ts).toISOString().split('T')[0];
                                                        setCustomRange({ startIso: toIso(startTs), endIso: toIso(endTs) });
                                                        setGraphRange('CUSTOM');
                                                        setChartSelection({ start: null, end: null, chart: null, dragging: false });
                                                    }}>Zoom ind</button>
                                                    <button className="text-xs px-2 py-1 rounded-md border border-gray-200 hover:bg-gray-100" onClick={() => setChartSelection({ start: null, end: null, chart: null, dragging: false })}>Ryd</button>
                                                </div>
                                            );
                                        })()}
                                        {fullscreenChart === 'value' && chartSelection.chart === 'value' && chartSelection.start != null && chartSelection.end != null && !isMulti && (() => {
                                            const startTs = Math.min(chartSelection.start, chartSelection.end);
                                            const endTs = Math.max(chartSelection.start, chartSelection.end);
                                            const inRange = numericValueData.filter(d => d.date >= startTs && d.date <= endTs);
                                            if (inRange.length < 2) return null;
                                            const startVal = inRange[0].value;
                                            const endVal = inRange[inRange.length - 1].value;
                                            const abs = endVal - startVal;
                                            const pct = startVal > 0 ? (abs / startVal) * 100 : 0;
                                            return (
                                                <div className="absolute top-4 right-4 bg-white/95 backdrop-blur rounded-md border border-gray-200 shadow-sm px-3 py-2 flex items-center gap-2">
                                                    <div className={`text-sm font-mono ${abs >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>{abs >= 0 ? '+' : ''}{formatCurrencyNoDecimals(abs)}</div>
                                                    <div className={`text-xs font-mono ${pct >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>({pct.toFixed(2)}%)</div>
                                                    <button className="text-xs px-2 py-1 rounded-md border border-gray-200 hover:bg-gray-100" onClick={() => {
                                                        const toIso = (ts) => new Date(ts).toISOString().split('T')[0];
                                                        setCustomRange({ startIso: toIso(startTs), endIso: toIso(endTs) });
                                                        setGraphRange('CUSTOM');
                                                        setChartSelection({ start: null, end: null, chart: null, dragging: false });
                                                    }}>Zoom ind</button>
                                                    <button className="text-xs px-2 py-1 rounded-md border border-gray-200 hover:bg-gray-100" onClick={() => setChartSelection({ start: null, end: null, chart: null, dragging: false })}>Ryd</button>
                                                </div>
                                            );
                                        })()}
                                    </div>
                                </div>
                            </ModalPortal>
                        )}

                        {/* 1. TOP CARDS */}
                        <div className="grid grid-cols-1 lg:grid-cols-2 2xl:grid-cols-4 gap-6">
                            {/* Value */}
                            <div className="bg-white rounded-lg p-5 border border-gray-200 shadow-sm flex flex-col justify-between min-w-0 cursor-pointer hover:bg-blue-50 hover:border-blue-300 transition-all group" onClick={() => setShowAllocationModal(true)}>
                                <div className="text-gray-500 text-xs font-bold uppercase tracking-wider flex items-center gap-1">
                                    <i className="ph ph-wallet"></i>Værdi
                                </div>
                                <div className="mt-2">
                                    <div className="text-3xl font-bold text-gray-900 tracking-tight break-words" style={{ wordBreak: 'break-word' }}>{formatCurrencyNoDecimals(calc.currentVal)}</div>
                                </div>
                            </div>
                            {/* Liquidation */}
                            <div
                                onClick={() => setShowLiquidationModal(true)}
                                className="bg-white rounded-lg p-5 border border-gray-200 shadow-sm flex flex-col justify-between min-w-0 cursor-pointer hover:bg-blue-50 hover:border-blue-300 transition-all group"
                            >
                                <div className="text-gray-500 text-xs font-bold uppercase tracking-wider flex items-center gap-1">
                                    <i className="ph ph-bank"></i>Værdi efter skat
                                </div>
                                <div className="mt-2 flex justify-between items-end">
                                    <div className="text-3xl font-bold text-gray-900 tracking-tight break-words">
                                        {formatCurrencyNoDecimals(calc.currentVal - calc.currentTax)}
                                    </div>
                                </div>
                            </div>
                            {/* All Time Gain */}
                            <div
                                onClick={() => setShowGainModal(true)}
                                className="bg-white rounded-lg p-5 border border-gray-200 shadow-sm flex flex-col justify-between min-w-0 cursor-pointer hover:bg-blue-50 hover:border-blue-300 transition-all group relative"
                            >
                                <div className="text-gray-500 text-xs font-bold uppercase tracking-wider flex items-center gap-1">
                                    <i className="ph ph-trend-up"></i>Samlet gevinst
                                </div>
                                <div className="mt-2 flex justify-between items-end">
                                    <div className={`text-3xl font-bold tracking-tight ${allTimeGain >= 0 ? 'text-emerald-600' : 'text-rose-600'} break-words`} style={{ wordBreak: 'break-word' }}>
                                        {formatCurrencyNoDecimals(allTimeGain)}
                                    </div>
                                </div>
                            </div>
                            {/* Today's Increase */}
                            <div className="bg-white rounded-lg p-5 border border-gray-200 shadow-sm flex flex-col justify-between min-w-0 cursor-pointer hover:bg-blue-50 hover:border-blue-300 transition-all group" onClick={() => setShowMoversModal(true)}>
                                {/* --- MOVERS MODAL --- */}
                                {showMoversModal && (
                                    <ModalPortal onBackdropClick={() => setShowMoversModal(false)}>
                                        <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full overflow-hidden animate-in zoom-in-95 duration-200" onClick={e => e.stopPropagation()}>
                                            <div className="p-4 border-b border-gray-100 flex justify-between items-center bg-gray-50">
                                                <h3 className="font-bold text-gray-800 flex items-center gap-2">
                                                    <i className="ph ph-arrow-up-right text-blue-600"></i> Top 3 bevægelser i dag
                                                </h3>
                                                <button onClick={() => setShowMoversModal(false)} className="text-gray-400 hover:text-gray-700"><i className="ph ph-x text-lg"></i></button>
                                            </div>
                                            <div className="p-4 space-y-3">
                                                {(() => {
                                                    if (!calc.portfolio || !marketData) return <div className="text-center text-gray-400 italic py-8">Ingen aktive bevægelser i dag.</div>;
                                                    const now = new Date();
                                                    // Merge tickers from different accounts by summing their values
                                                    const tickerMap = {};
                                                    Object.values(calc.portfolio).forEach(p => {
                                                        const m = marketData[p.ticker] || {};
                                                        const lastTrade = new Date((m.lastTradeTime || 0) * 1000);
                                                        const isToday = lastTrade.getDate() === now.getDate() &&
                                                            lastTrade.getMonth() === now.getMonth() &&
                                                            lastTrade.getFullYear() === now.getFullYear();
                                                        if (!isToday) return;
                                                        const { val, prevVal, price, prevClose, fxRate } = getPositionValueWithPrev(p);
                                                        const absMove = val - prevVal;
                                                        const pctMove = prevVal > 0 ? (absMove / prevVal) * 100 : 0;
                                                        if (!tickerMap[p.ticker]) {
                                                            tickerMap[p.ticker] = {
                                                                ticker: p.ticker,
                                                                absMove: 0,
                                                                val: 0,
                                                                prevVal: 0,
                                                                price,
                                                                prevClose,
                                                                fxRate,
                                                                totalPctMove: 0,
                                                                totalPrevVal: 0
                                                            };
                                                        }
                                                        tickerMap[p.ticker].absMove += absMove;
                                                        tickerMap[p.ticker].val += val;
                                                        tickerMap[p.ticker].prevVal += prevVal;
                                                        tickerMap[p.ticker].totalPrevVal += prevVal;
                                                    });
                                                    // Calculate pctMove for each merged ticker
                                                    Object.values(tickerMap).forEach(t => {
                                                        t.pctMove = t.totalPrevVal > 0 ? (t.absMove / t.totalPrevVal) * 100 : 0;
                                                    });
                                                    const movers = Object.values(tickerMap)
                                                        .sort((a, b) => Math.abs(b.absMove) - Math.abs(a.absMove))
                                                        .slice(0, 3);
                                                    if (movers.length === 0) return <div className="text-center text-gray-400 italic py-8">Ingen aktive bevægelser i dag.</div>;
                                                    return movers.map(m => (
                                                        <div key={m.ticker} className="flex justify-between items-center border-b last:border-0 border-gray-100 py-2">
                                                            <div className="flex flex-col">
                                                                <span className="font-bold text-gray-800 text-lg">{m.ticker}</span>
                                                                <span className="text-xs text-gray-500">{formatCurrencyNoDecimals(m.absMove)} ({m.pctMove >= 0 ? '+' : ''}{m.pctMove.toFixed(2)}%)</span>
                                                            </div>
                                                            <div className={`font-mono font-bold text-right ${m.absMove >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>{formatCurrencyNoDecimals(m.absMove)}</div>
                                                        </div>
                                                    ));
                                                })()}
                                            </div>
                                        </div>
                                    </ModalPortal>
                                )}
                                <div className="text-gray-500 text-xs font-bold uppercase tracking-wider flex items-center gap-1">
                                    <i className="ph ph-arrow-up-right"></i>Gevinst/Tab i dag
                                </div>
                                <div className="mt-2">
                                    {(() => {
                                        let todayGain = 0;
                                        let todayPct = 0;
                                        let activeCount = 0; // To track if anything is open

                                        if (calc.portfolio && marketData) {
                                            let totalVal = 0;
                                            let totalPrevVal = 0;
                                            const now = new Date();

                                            Object.values(calc.portfolio).forEach(p => {
                                                const m = marketData[p.ticker] || {};

                                                // 1. Check if active today
                                                const lastTrade = new Date((m.lastTradeTime || 0) * 1000);
                                                const isToday = lastTrade.getDate() === now.getDate() &&
                                                    lastTrade.getMonth() === now.getMonth() &&
                                                    lastTrade.getFullYear() === now.getFullYear();

                                                // 2. Only calculate if active today (or if we have no data, skip)
                                                if (isToday) {
                                                    activeCount++;
                                                    const { val, prevVal } = getPositionValueWithPrev(p);

                                                    totalVal += val;
                                                    totalPrevVal += prevVal;
                                                }
                                            });

                                            if (activeCount > 0) {
                                                todayGain = totalVal - totalPrevVal;
                                                todayPct = totalPrevVal > 0 ? (todayGain / totalPrevVal) * 100 : 0;
                                            }
                                        }

                                        return (
                                            <>
                                                <div className={`text-3xl font-bold tracking-tight ${activeCount === 0 ? 'text-gray-400' : (todayGain >= 0 ? 'text-emerald-600' : 'text-rose-600')} break-words`} style={{ wordBreak: 'break-word' }}>
                                                    {activeCount > 0 ? formatCurrencyNoDecimals(todayGain) : "0 kr."}
                                                    <span className={`text-lg font-bold ml-2 align-middle ${activeCount === 0 ? 'text-gray-400' : (todayPct >= 0 ? 'text-emerald-600' : 'text-rose-600')}`}>
                                                        {activeCount > 0 ? `${todayPct.toFixed(2)}%` : ""}
                                                    </span>
                                                </div>
                                            </>
                                        );
                                    })()}
                                </div>
                            </div>
                        </div>

                        {/* Performance by Year: Above graphs on small screens, right of graphs on large screens */}
                        <div className="block lg:hidden mt-8">
                            <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
                                <div className="p-4 border-b border-gray-100 bg-gray-50">
                                    <h3 className="font-bold text-gray-800 text-sm uppercase tracking-wide">Afkast pr. år</h3>
                                </div>
                                <div className="divide-y divide-gray-100">
                                    {calc.yearlyStats.map(stat => (
                                        <div key={stat.year} className="p-4 hover:bg-gray-50 transition-colors">
                                            <div className="flex justify-between items-center mb-1">
                                                <span className="font-bold text-gray-900 text-lg">{stat.year}</span>
                                                <span className={`font-bold text-lg ${stat.return >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>{stat.return > 0 ? '+' : ''}{stat.return.toFixed(2)}%</span>
                                            </div>
                                            {/* Gain Row */}
                                            <div className="flex justify-between items-center text-xs text-gray-500 mb-1">
                                                <span>Gevinst/Tab</span>
                                                <span className={`font-mono font-medium ${stat.gainAbs >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>{stat.gainAbs > 0 ? '+' : ''}{formatCurrencyNoDecimals(stat.gainAbs)}</span>
                                            </div>
                                            {/* Flow Row */}
                                            <div className="flex justify-between items-center text-xs text-gray-500">
                                                <span>Kapitalstrøm</span>
                                                <span className="font-mono font-medium cursor-help border-b border-dotted border-gray-300" title={`In: ${formatCurrencyNoDecimals(stat.breakdown.in)}\nOut: ${formatCurrencyNoDecimals(stat.breakdown.out)}`}>{stat.flow > 0 ? '+' : ''}{formatCurrencyNoDecimals(stat.flow)}</span>
                                            </div>
                                        </div>
                                    ))}
                                    {calc.yearlyStats.length === 0 && (
                                        <div className="p-8 text-center text-gray-400 italic">Ingen data tilgængelig</div>
                                    )}
                                </div>
                            </div>
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                            {/* LEFT: GRAPHS */}
                            <div className="lg:col-span-2 space-y-8">
                                {/* GROWTH GRAPH */}
                                <div className="bg-white p-4 rounded-xl border shadow-sm">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-bold text-gray-800 text-sm uppercase">Afkast (%)</h3>
                                        <div className="flex items-center gap-2">
                                            <RangeSelector />
                                            <TickerSelector />
                                            {/* Benchmark Selector */}
                                            <select
                                                className="px-3 py-1 text-xs font-bold rounded-md bg-gray-100 border border-gray-200"
                                                value={settings.benchmarkTicker}
                                                onChange={e => { setSettings(s => ({ ...s, benchmarkTicker: e.target.value })); fetchMarketData(true); }}
                                            >
                                                {BENCHMARKS.map(b => (<option key={b.ticker} value={b.ticker}>{b.label}</option>))}
                                            </select>
                                            {(!isMulti && settings.benchmarkTicker) && (() => {
                                                const last = numericGrowthData[numericGrowthData.length - 1];
                                                const diff = (last?.value ?? 0) - (last?.benchmark ?? 0);
                                                if (!isFinite(diff)) return null;
                                                return (
                                                    <span className={`text-xs font-mono px-2 py-0.5 rounded ${diff >= 0 ? 'bg-emerald-50 text-emerald-700 border border-emerald-200' : 'bg-rose-50 text-rose-700 border border-rose-200'}`}>vs {benchLabel}: {diff >= 0 ? '+' : ''}{diff.toFixed(2)}%</span>
                                                );
                                            })()}
                                            <button title="Fuld skærm"
                                                className="px-2 py-1 text-xs rounded-md border border-gray-200 hover:bg-gray-100"
                                                onClick={() => setFullscreenChart('growth')}
                                            >
                                                <i className="ph ph-arrows-out"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div className={`relative h-64 w-full ${chartSelection.dragging ? 'select-none' : ''}`}>
                                        <ResponsiveContainer width="100%" height="100%">
                                            {/* Use numericGrowthData */}
                                            <AreaChart data={numericGrowthData}
                                                onMouseDown={(e) => {
                                                    const se = e && e.sourceEvent; if (se && se.preventDefault) se.preventDefault();
                                                    if (e && e.activeLabel != null) {
                                                        setChartSelection({ start: e.activeLabel, end: null, chart: 'growth', dragging: true });
                                                    }
                                                }}
                                                onMouseMove={(e) => {
                                                    if (chartSelection.dragging && chartSelection.chart === 'growth' && e && e.activeLabel != null) {
                                                        setChartSelection(s => ({ ...s, end: e.activeLabel }));
                                                    }
                                                }}
                                                onMouseUp={() => {
                                                    if (chartSelection.dragging && chartSelection.chart === 'growth' && chartSelection.start != null && chartSelection.end != null) {
                                                        setChartSelection(s => ({ ...s, dragging: false }));
                                                    } else {
                                                        setChartSelection({ start: null, end: null, chart: null, dragging: false });
                                                    }
                                                }}
                                                onMouseLeave={() => {
                                                    setChartSelection(s => s.dragging
                                                        ? (s.start != null && s.end != null) ? { ...s, dragging: false } : { start: null, end: null, chart: null, dragging: false }
                                                        : s);
                                                }}
                                            >
                                                <defs>
                                                    <linearGradient id="colorGrowth" x1="0" y1="0" x2="0" y2="1">
                                                        <stop offset="5%" stopColor="#10b981" stopOpacity={0.2} />
                                                        <stop offset="95%" stopColor="#10b981" stopOpacity={0} />
                                                    </linearGradient>
                                                </defs>
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f3f4f6" />

                                                {/* XAXIS */}
                                                <XAxis
                                                    dataKey="date"
                                                    type="number"
                                                    domain={['dataMin', 'dataMax']}
                                                    tickFormatter={formatAxisDateNumeric}
                                                    ticks={graphRange === 'ALL' ? numericYearTicks : null}
                                                    axisLine={false}
                                                    tickLine={false}
                                                    tick={{ fontSize: 10, fill: '#9ca3af' }}
                                                    minTickGap={30}
                                                />

                                                <YAxis width={45} axisLine={false} tickLine={false} tickFormatter={(v) => `${v.toFixed(0)}%`} tick={{ fontSize: 10, fill: '#9ca3af' }} />

                                                {/* TOOLTIP */}
                                                <Tooltip formatter={(v) => `${v.toFixed(2)}%`} labelFormatter={formatAxisDateNumeric} />

                                                <ReferenceLine y={0} stroke="#e5e7eb" strokeDasharray="3 3" />

                                                {/* REFERENCE LINES */}
                                                {showYearLines && numericYearTicks.map(timestamp => (
                                                    <ReferenceLine key={timestamp} x={timestamp} stroke="#e5e7eb" />
                                                ))}

                                                {/* Selection area */}
                                                {(chartSelection.chart === 'growth' && chartSelection.start != null && chartSelection.end != null && !isMulti) && (
                                                    <ReferenceArea x1={Math.min(chartSelection.start, chartSelection.end)} x2={Math.max(chartSelection.start, chartSelection.end)} strokeOpacity={0.1} fill="#10b981" fillOpacity={0.1} />
                                                )}
                                                {isMulti
                                                    ? sel.map((t, i) => (
                                                        <Area key={`g-${t}`} type="monotone" dataKey={t} stroke={COLORS[i % COLORS.length]} strokeWidth={1} fill="none" isAnimationActive={false} />
                                                    ))
                                                    : <Area type="monotone" dataKey="value" stroke="#10b981" strokeWidth={1} fill="url(#colorGrowth)" isAnimationActive={false} />}
                                                {(!isMulti && settings.benchmarkTicker) && (
                                                    <Area type="monotone" dataKey="benchmark" stroke="#f59e0b" strokeWidth={1} fill="none" isAnimationActive={false} />
                                                )}
                                            </AreaChart>
                                        </ResponsiveContainer>
                                        {/* Selection overlay */}
                                        {(chartSelection.chart === 'growth' && chartSelection.start != null && chartSelection.end != null && !isMulti) && (() => {
                                            const startTs = Math.min(chartSelection.start, chartSelection.end);
                                            const endTs = Math.max(chartSelection.start, chartSelection.end);
                                            const inRange = numericGrowthData.filter(d => d.date >= startTs && d.date <= endTs);
                                            if (inRange.length < 2) return null;
                                            const startVal = inRange[0].value;
                                            const endVal = inRange[inRange.length - 1].value;
                                            const abs = endVal - startVal;
                                            return (
                                                <div className="absolute top-2 right-2 bg-white/95 backdrop-blur rounded-md border border-gray-200 shadow-sm px-3 py-2 flex items-center gap-2">
                                                    <div className={`text-sm font-mono ${abs >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>{abs >= 0 ? '+' : ''}{abs.toFixed(2)}%</div>
                                                    <button className="text-xs px-2 py-1 rounded-md border border-gray-200 hover:bg-gray-100" onClick={() => {
                                                        const toIso = (ts) => new Date(ts).toISOString().split('T')[0];
                                                        setCustomRange({ startIso: toIso(startTs), endIso: toIso(endTs) });
                                                        setGraphRange('CUSTOM');
                                                        setChartSelection({ start: null, end: null, chart: null, dragging: false });
                                                    }}>Zoom ind</button>
                                                    <button className="text-xs px-2 py-1 rounded-md border border-gray-200 hover:bg-gray-100" onClick={() => setChartSelection({ start: null, end: null, chart: null, dragging: false })}>Ryd</button>
                                                </div>
                                            );
                                        })()}
                                    </div>
                                </div>

                                {/* VALUE GRAPH */}
                                <div className="bg-white p-4 rounded-xl border shadow-sm">
                                    <div className="flex justify-between items-center mb-4">
                                        <h3 className="font-bold text-gray-800 text-sm uppercase">Porteføljens Værdi</h3>
                                        <div className="flex items-center gap-2">
                                            <RangeSelector />
                                            <TickerSelector />
                                            <button title="Fuld skærm"
                                                className="px-2 py-1 text-xs rounded-md border border-gray-200 hover:bg-gray-100"
                                                onClick={() => setFullscreenChart('value')}
                                            >
                                                <i className="ph ph-arrows-out"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div className={`relative h-64 w-full ${chartSelection.dragging ? 'select-none' : ''}`}>
                                        <ResponsiveContainer width="100%" height="100%">
                                            {/* Use numericValueData */}
                                            <AreaChart data={numericValueData}
                                                onMouseDown={(e) => {
                                                    const se = e && e.sourceEvent; if (se && se.preventDefault) se.preventDefault();
                                                    if (e && e.activeLabel != null) {
                                                        setChartSelection({ start: e.activeLabel, end: null, chart: 'value', dragging: true });
                                                    }
                                                }}
                                                onMouseMove={(e) => {
                                                    if (chartSelection.dragging && chartSelection.chart === 'value' && e && e.activeLabel != null) {
                                                        setChartSelection(s => ({ ...s, end: e.activeLabel }));
                                                    }
                                                }}
                                                onMouseUp={() => {
                                                    if (chartSelection.dragging && chartSelection.chart === 'value' && chartSelection.start != null && chartSelection.end != null) {
                                                        setChartSelection(s => ({ ...s, dragging: false }));
                                                    } else {
                                                        setChartSelection({ start: null, end: null, chart: null, dragging: false });
                                                    }
                                                }}
                                                onMouseLeave={() => {
                                                    setChartSelection(s => s.dragging
                                                        ? (s.start != null && s.end != null) ? { ...s, dragging: false } : { start: null, end: null, chart: null, dragging: false }
                                                        : s);
                                                }}
                                            >
                                                <defs>
                                                    <linearGradient id="colorVal" x1="0" y1="0" x2="0" y2="1">
                                                        <stop offset="5%" stopColor="#3b82f6" stopOpacity={0.2} />
                                                        <stop offset="95%" stopColor="#3b82f6" stopOpacity={0} />
                                                    </linearGradient>
                                                </defs>
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f3f4f6" />

                                                {/* XAXIS */}
                                                <XAxis
                                                    dataKey="date"
                                                    type="number"
                                                    domain={['dataMin', 'dataMax']}
                                                    tickFormatter={formatAxisDateNumeric}
                                                    ticks={graphRange === 'ALL' ? numericYearTicks : null}
                                                    axisLine={false}
                                                    tickLine={false}
                                                    tick={{ fontSize: 10, fill: '#9ca3af' }}
                                                    minTickGap={30}
                                                />

                                                <YAxis width={45} axisLine={false} tickLine={false} domain={['dataMin', 'dataMax']} tickFormatter={(v) => `${(v / 1000).toFixed(0)}k`} tick={{ fontSize: 10, fill: '#9ca3af' }} />

                                                {/* TOOLTIP */}
                                                <Tooltip formatter={(v) => formatCurrency(v)} labelFormatter={formatAxisDateNumeric} />

                                                {/* REFERENCE LINES */}
                                                {showYearLines && numericYearTicks.map(timestamp => (
                                                    <ReferenceLine key={timestamp} x={timestamp} stroke="#e5e7eb" />
                                                ))}
                                                {/* Selection area */}
                                                {(chartSelection.chart === 'value' && chartSelection.start != null && chartSelection.end != null && !isMulti) && (
                                                    <ReferenceArea x1={Math.min(chartSelection.start, chartSelection.end)} x2={Math.max(chartSelection.start, chartSelection.end)} strokeOpacity={0.1} fill="#2563eb" fillOpacity={0.1} />
                                                )}
                                                {isMulti
                                                    ? sel.map((t, i) => (
                                                        <Area key={`v-${t}`} type="monotone" dataKey={t} stroke={COLORS[i % COLORS.length]} strokeWidth={1} fill="none" isAnimationActive={false} />
                                                    ))
                                                    : <>
                                                        <Area
                                                            type="step"
                                                            dataKey="invested"
                                                            stroke="#9ca3af"
                                                            strokeWidth={1}
                                                            strokeDasharray="4 4"
                                                            fill="none"
                                                            isAnimationActive={false}
                                                        />
                                                        <Area type="monotone" dataKey="value" stroke="#2563eb" strokeWidth={1} fill="url(#colorVal)" isAnimationActive={false} />
                                                      </>}
                                                {/* Buy/Sell markers */}
                                            </AreaChart>
                                        </ResponsiveContainer>
                                        {/* Selection overlay */}
                                        {(chartSelection.chart === 'value' && chartSelection.start != null && chartSelection.end != null && !isMulti) && (() => {
                                            const startTs = Math.min(chartSelection.start, chartSelection.end);
                                            const endTs = Math.max(chartSelection.start, chartSelection.end);
                                            const inRange = numericValueData.filter(d => d.date >= startTs && d.date <= endTs);
                                            if (inRange.length < 2) return null;
                                            const startVal = inRange[0].value;
                                            const endVal = inRange[inRange.length - 1].value;
                                            const abs = endVal - startVal;
                                            const pct = startVal > 0 ? (abs / startVal) * 100 : 0;
                                            return (
                                                <div className="absolute top-2 right-2 bg-white/95 backdrop-blur rounded-md border border-gray-200 shadow-sm px-3 py-2 flex items-center gap-2">
                                                    <div className={`text-sm font-mono ${abs >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>{abs >= 0 ? '+' : ''}{formatCurrencyNoDecimals(abs)}</div>
                                                    <div className={`text-xs font-mono ${pct >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>({pct.toFixed(2)}%)</div>
                                                    <button className="text-xs px-2 py-1 rounded-md border border-gray-200 hover:bg-gray-100" onClick={() => {
                                                        const toIso = (ts) => new Date(ts).toISOString().split('T')[0];
                                                        setCustomRange({ startIso: toIso(startTs), endIso: toIso(endTs) });
                                                        setGraphRange('CUSTOM');
                                                        setChartSelection({ start: null, end: null, chart: null, dragging: false });
                                                    }}>Zoom ind</button>
                                                    <button className="text-xs px-2 py-1 rounded-md border border-gray-200 hover:bg-gray-100" onClick={() => setChartSelection({ start: null, end: null, chart: null, dragging: false })}>Ryd</button>
                                                </div>
                                            );
                                        })()}
                                    </div>
                                </div>


                            </div>
                            {/* RIGHT: STATS TABLE (only on large screens) */}
                            <div className="hidden lg:block">
                                <div className="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden sticky top-6">
                                    <div className="p-4 border-b border-gray-100 bg-gray-50">
                                        <h3 className="font-bold text-gray-800 text-sm uppercase tracking-wide">Afkast pr. år</h3>
                                    </div>
                                    <div className="divide-y divide-gray-100">
                                        {calc.yearlyStats.map(stat => (
                                            <div key={stat.year} className="p-4 hover:bg-gray-50 transition-colors">
                                                <div className="flex justify-between items-center mb-1">
                                                    <span className="font-bold text-gray-900 text-lg">{stat.year}</span>
                                                    <span className={`font-bold text-lg ${stat.return >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>{stat.return > 0 ? '+' : ''}{stat.return.toFixed(2)}%</span>
                                                </div>
                                                {/* Gain Row */}
                                                <div className="flex justify-between items-center text-xs text-gray-500 mb-1">
                                                    <span>Gevinst/Tab</span>
                                                    <span className={`font-mono font-medium ${stat.gainAbs >= 0 ? 'text-emerald-600' : 'text-rose-600'}`}>{stat.gainAbs > 0 ? '+' : ''}{formatCurrencyNoDecimals(stat.gainAbs)}</span>
                                                </div>
                                                {/* Flow Row */}
                                                <div className="flex justify-between items-center text-xs text-gray-500">
                                                    <span>Kapitalstrøm</span>
                                                    <span className="font-mono font-medium cursor-help border-b border-dotted border-gray-300" title={`In: ${formatCurrencyNoDecimals(stat.breakdown.in)}\nOut: ${formatCurrencyNoDecimals(stat.breakdown.out)}`}>{stat.flow > 0 ? '+' : ''}{formatCurrencyNoDecimals(stat.flow)}</span>
                                                </div>
                                            </div>
                                        ))}
                                        {calc.yearlyStats.length === 0 && (
                                            <div className="p-8 text-center text-gray-400 italic">Ingen data tilgængelig</div>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            // 4. EDITOR
            const renderEditor = () => {
                const viewRows = [...rows]
                    .map((r, i) => ({ ...r, _origIdx: i }))
                    .sort((a, b) => (parseDanishDate(a['Date']) || 0) - (parseDanishDate(b['Date']) || 0));

                let runningBalances = {};
                let runningHoldings = {};

                // Focus helpers
                const focusNext = (el) => {
                    if (!el) return;
                    const rowEl = el.closest('tr');
                    if (!rowEl) return;
                    const focusables = Array.from(rowEl.querySelectorAll('input, select'));
                    const idx = focusables.indexOf(el);
                    const next = focusables[idx + 1];
                    if (next) next.focus();
                };
                const focusPrev = (el) => {
                    if (!el) return;
                    const rowEl = el.closest('tr');
                    if (!rowEl) return;
                    const focusables = Array.from(rowEl.querySelectorAll('input, select'));
                    const idx = focusables.indexOf(el);
                    const prev = focusables[idx - 1];
                    if (prev) prev.focus();
                };

                const editorRows = viewRows.map(row => {
                    const idx = row._origIdx;
                    const acc = row['Account'] || 'Unknown';
                    const ticker = row['Ticker'];
                    // NEW: Track holdings specific to this account
                    const holdingKey = `${ticker}_${acc}`;
                    // Init trackers
                    if (!runningBalances[acc]) runningBalances[acc] = 0;
                    if (ticker && !runningHoldings[holdingKey]) runningHoldings[holdingKey] = 0;

                    // Parse Numbers
                    const qty = parseDanishNumber(row['Qty']);
                    const price = parseDanishNumber(row['Price']);
                    const comm = parseDanishNumber(row['Commission']);
                    const tax = parseDanishNumber(row['Withheld Tax']);
                    const taxRate = parseDanishNumber(row['FxRate']) || 1;

                    // Currency Logic
                    const stockCurrency = (row['Currency'] || 'DKK').toUpperCase();
                    const accCurrency = (config.currencies[acc] || 'DKK').toUpperCase();
                    const isCrossCurrency = accCurrency !== stockCurrency;
                    // If USD Account buys USD Stock, Rate is effectively 1 (no conversion needed for Balance).
                    // BUT for SKAT (Zone B), we still need the FxRate stored in the row.
                    const conversionRate = isCrossCurrency ? taxRate : 1;

                    // Type Logic
                    const effectiveType = determineType(row['Type'], row['Ticker'], row['Qty']);
                    const isTrade = ['Stock', 'ETF'].includes(effectiveType);
                    const isCash = effectiveType === 'Cash' || effectiveType === 'Dividend';
                    const isDividend = effectiveType === 'Dividend';

                    const holdingsBefore = runningHoldings[holdingKey] || 0;

                    // Update running holdings for NEXT row
                    if (effectiveType === 'Stock' || effectiveType === 'ETF') {
                        runningHoldings[holdingKey] += qty;
                    }


                    let delta = 0;
                    let calcDetail = '';

                    if (isTrade) {
                        // Formula: -((Qty * Price * Rate) + Commission)
                        const assetVal = (qty * price) * conversionRate;
                        delta = -(assetVal + comm);
                        calcDetail = `${effectiveType}: -(${formatDanishNumber(qty)} x ${formatDanishNumber(price)} x ${formatDanishNumber(conversionRate)}) - ${formatDanishNumber(comm)}`;
                    } else if (isCash) {
                        // Formula: (Qty * Price * Rate) - Tax
                        const grossVal = (qty * price) * conversionRate;
                        delta = grossVal - tax;
                        calcDetail = `Cash: (${formatDanishNumber(qty)} x ${formatDanishNumber(price)} x ${formatDanishNumber(conversionRate)}) - ${formatDanishNumber(tax)}`;
                    }
                    runningBalances[acc] += delta;

                    const meta = {
                        isTrade, isCash, isCrossCurrency, stockCurrency, isDividend,
                        holdingsSnapshot: holdingsBefore, // <--- Store for UI
                        warnFx: (stockCurrency !== 'DKK' && taxRate === 1) // <--- Warning Flag
                    };

                    return { ...row, _idx: idx, _bal: runningBalances[acc], _delta: delta, _calcDetail: calcDetail, _accCur: accCurrency, _meta: meta };
                });

                const displayRows = editorRows.filter(r => {
                    // 1. Sidebar Account Filter (Existing)
                    if (filterAccount !== 'All' && r['Account'] !== filterAccount) return false;

                    // 2. Column Header Filters (New)
                    return Object.entries(filters).every(([key, searchVal]) => {
                        if (!searchVal) return true; // No filter for this column

                        // Grab value, handle numbers safely, convert to lower case for case-insensitive search
                        const val = String(r[key] || '').toLowerCase();
                        return val.includes(searchVal.toLowerCase());
                    });
                }).slice().reverse(); // Reverse to show newest on top

                const currentAccCurrency = filterAccount !== 'All' ? (config.currencies[filterAccount] || 'DKK') : '';

                return (
                    <div className="flex flex-col h-full bg-white">
                        {/* TOP BAR */}
                        <div className="flex items-center justify-between p-2 border-b bg-gray-50 shrink-0">
                            <div className="flex gap-2">
                                <button onClick={() => {
                                    const dStr = normalizeDate(new Date().toISOString().split('T')[0]);
                                    setRows(prev => [{ 'Date': dStr, 'Type': 'Stock', 'Ticker': '', 'Qty': 0, 'Price': 0, 'FxRate': 1, 'Commission': 0, 'Withheld Tax': 0, 'Currency': 'DKK', 'Account': filterAccount !== 'All' ? filterAccount : '' }, ...prev]);
                                }} className="flex items-center gap-1 px-3 py-1 bg-white border rounded hover:bg-gray-100 text-sm font-medium text-gray-700">
                                    <i className="ph ph-plus"></i> Add Row
                                </button>
                                <button onClick={saveToGithub} className="flex items-center gap-1 px-3 py-1 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-medium shadow-sm"><i className="ph ph-cloud-arrow-up"></i> Sync</button>
                                {statusMsg && <span className="text-xs text-gray-500 self-center ml-2">{statusMsg}</span>}
                            </div>
                        </div>

                        {/* TABLE */}
                        <div className="flex-1 overflow-auto custom-scrollbar">
                            <table className="min-w-full text-xs text-left border-collapse">
                                <thead className="bg-gray-50 sticky top-0 z-10 shadow-sm">
                                    {/* Row 1: Column Titles */}
                                    <tr>
                                        <th className="p-2 border-b sticky left-0 bg-gray-50 z-20 w-8"></th>
                                        {CSV_COLUMNS.map(c => {
                                            if (filterAccount !== 'All' && c === 'Account') return null;
                                            const currentAccCurrency = filterAccount !== 'All' ? (config.currencies[filterAccount] || 'DKK') : '';
                                            const showCur = (c === 'Commission' || c === 'Withheld Tax') && currentAccCurrency;

                                            return (
                                                <th key={c} className="p-2 border-b font-semibold text-gray-600">
                                                    {c} {showCur && <span className="ml-1 text-[10px] text-gray-400">({currentAccCurrency})</span>}
                                                </th>
                                            );
                                        })}
                                        <th className="p-2 border-b font-semibold text-gray-600 text-right">Delta</th>
                                        <th className="p-2 border-b font-semibold text-gray-600 text-right">Balance</th>
                                    </tr>

                                    {/* Row 2: Filter Inputs */}
                                    <tr className="bg-gray-50">
                                        <th className="p-1 border-b sticky left-0 bg-gray-50 z-20">
                                            {/* Clear Filters Button (shows only if filters exist) */}
                                            {Object.keys(filters).some(k => filters[k]) && (
                                                <button onClick={() => setFilters({})} className="text-gray-400 hover:text-red-500" title="Clear All Filters">
                                                    <i className="ph ph-x-circle"></i>
                                                </button>
                                            )}
                                        </th>
                                        {CSV_COLUMNS.map(c => {
                                            if (filterAccount !== 'All' && c === 'Account') return null;
                                            return (
                                                <th key={c} className="p-1 border-b">
                                                    <input
                                                        className="w-full text-[10px] p-1 border border-gray-200 rounded bg-white focus:border-blue-300 outline-none"
                                                        placeholder={`Filter...`}
                                                        value={filters[c] || ''}
                                                        onChange={e => setFilters(prev => ({ ...prev, [c]: e.target.value }))}
                                                    />
                                                </th>
                                            );
                                        })}
                                        {/* Empty spacers for Delta/Balance columns (usually not filtered) */}
                                        <th className="p-1 border-b"></th>
                                        <th className="p-1 border-b"></th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-gray-100">
                                    {displayRows.map(row => (
                                        <tr key={row._idx} className="group hover:bg-blue-50/30">
                                            <td className="p-1 text-center sticky left-0 bg-white group-hover:bg-blue-50/30 border-r">
                                                <button onClick={() => confirm('Delete?') && setRows(prev => prev.filter((_, i) => i !== row._idx))} className="text-gray-300 hover:text-red-500"><i className="ph ph-trash"></i></button>
                                            </td>

                                            {/* Date */}
                                            <td className="p-1"><FlatpickrDate value={row['Date']} onChange={(v) => updateRow(row._idx, 'Date', v)} onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); focusNext(e.currentTarget); } }} /></td>

                                            {/* Type */}
                                            <td className="p-1">
                                                <select className="w-20 input-base p-1 rounded font-medium text-gray-700" value={row['Type']} onChange={e => updateRow(row._idx, 'Type', e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); focusNext(e.currentTarget); } }}>
                                                    {TYPE_OPTIONS.map(o => <option key={o} value={o}>{o}</option>)}
                                                </select>
                                            </td>

                                            {/* Ticker */}
                                            <td className="p-1"><input className="w-full input-base p-1 rounded font-medium" value={row['Ticker']} onChange={e => updateRow(row._idx, 'Ticker', e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); focusNext(e.currentTarget); } }} /></td>

                                            {/* 1. Qty */}
                                            <td className="p-1 relative group/qty">
                                                <NumberInput
                                                    row={row}
                                                    setRows={setRows}
                                                    fieldKey="Qty"
                                                    rawKey="__qty_raw"
                                                    extraClass="w-24"
                                                />

                                                {/* The Hint: Only show if Dividend and we have a ticker */}
                                                {row._meta.isDividend && row['Ticker'] && (
                                                    <div className="absolute top-0 right-0 -mr-1 -mt-3 pointer-events-none opacity-0 group-hover/qty:opacity-100 transition-opacity z-10">
                                                        <div className="bg-gray-800 text-white text-[10px] px-2 py-1 rounded shadow-lg">
                                                            Held: {formatDanishNumber(row._meta.holdingsSnapshot, 0)} pcs
                                                        </div>
                                                    </div>
                                                )}
                                            </td>

                                            {/* 2. Price */}
                                            <td className="p-1">
                                                <NumberInput
                                                    row={row}
                                                    setRows={setRows}
                                                    fieldKey="Price"
                                                    rawKey="__price_raw"
                                                    extraClass={row._meta.isCash ? 'text-gray-300' : ''}
                                                />
                                            </td>
                                            {/* Currency */}
                                            <td className="p-1">
                                                <select className="w-16 input-base p-1 rounded text-xs" value={row['Currency']} onChange={e => updateRow(row._idx, 'Currency', e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); focusNext(e.currentTarget); } }}>
                                                    {CURRENCY_OPTIONS.map(o => <option key={o} value={o}>{o}</option>)}
                                                </select>
                                            </td>

                                            {/* FxRate with Warning Tooltip */}
                                            <td className="p-1">
                                                <NumberInput
                                                    row={row}
                                                    setRows={setRows}
                                                    fieldKey="FxRate"
                                                    rawKey="__fx_raw"
                                                    extraClass={row._meta.warnFx ? 'bg-orange-50 text-orange-700 font-bold border border-orange-300' : ''}
                                                    title={row._meta.warnFx ? "Critical: Foreign currency with Rate 1.00" : "Exchange Rate"}
                                                />
                                            </td>

                                            {/* 4. Commission */}
                                            <td className="p-1">
                                                <NumberInput
                                                    row={row}
                                                    setRows={setRows}
                                                    fieldKey="Commission"
                                                    rawKey="__comm_raw"
                                                    extraClass={!row._meta.isTrade ? 'text-gray-300' : 'text-gray-700'}
                                                    title="Trading Fee"
                                                />
                                            </td>
                                            {/* 5. Withheld Tax */}
                                            <td className="p-1">
                                                {(() => {
                                                    // 1. Gather Data
                                                    const isDividend = row['Type'] === 'Dividend';
                                                    const taxVal = parseDanishNumber(row['Withheld Tax']);

                                                    // 2. Default Styling (Non-Dividend = Grey)
                                                    let css = 'text-gray-300';
                                                    let tooltip = 'Dividend Tax';

                                                    // 3. Logic for Dividends
                                                    if (isDividend) {
                                                        css = 'text-gray-700'; // Normal text

                                                        // A. Check for Zero Tax
                                                        if (taxVal === 0) {
                                                            css = 'text-orange-700 bg-orange-50 border border-orange-300 font-bold';
                                                            tooltip = 'Warning: No tax withheld on dividend';
                                                        }
                                                        // B. Check Tax Ratio (Integrity Check)
                                                        else {
                                                            const qty = parseDanishNumber(row['Qty']);
                                                            const price = parseDanishNumber(row['Price']);
                                                            const fx = parseDanishNumber(row['FxRate']) || 1;

                                                            // Determine Currency Conversion
                                                            const acc = row['Account'] || '';
                                                            const accCur = (config.currencies[acc] || 'DKK').toUpperCase();
                                                            const stockCur = (row['Currency'] || 'DKK').toUpperCase();

                                                            // If Currencies differ, apply FxRate to get Gross in Account Currency
                                                            const conversion = accCur !== stockCur ? fx : 1;
                                                            const grossAmount = qty * price * conversion;

                                                            if (grossAmount > 0) {
                                                                const pct = (taxVal / grossAmount) * 100;

                                                                // Validation Rules:
                                                                // DKK: Expect ~27%
                                                                // Foreign: Expect 15% - 28% (Standard treaty rates)
                                                                const isSuspicious = stockCur === 'DKK'
                                                                    ? (pct < 26 || pct > 28)
                                                                    : (pct < 14 || pct > 30);

                                                                if (isSuspicious) {
                                                                    css = 'text-orange-700 bg-orange-50 border border-orange-300 font-bold';
                                                                    tooltip = `Warning: Unusual Tax Rate (${pct.toFixed(1)}%). Check amounts.`;
                                                                }
                                                            }
                                                        }
                                                    }

                                                    return (
                                                        <NumberInput
                                                            row={row}
                                                            setRows={setRows}
                                                            fieldKey="Withheld Tax"
                                                            rawKey="__tax_raw"
                                                            extraClass={css}
                                                            title={tooltip}
                                                        />
                                                    );
                                                })()}
                                            </td>

                                            {/* Account */}
                                            {filterAccount === 'All' && (
                                                <td className="p-1"><input className="w-24 input-base p-1 rounded text-xs" value={row['Account']} onChange={e => updateRow(row._idx, 'Account', e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); focusNext(e.currentTarget); } }} /></td>
                                            )}

                                            {/* Note */}
                                            <td className="p-1"><input className="w-24 input-base p-1 rounded text-gray-400 text-xs" value={row['Note']} onChange={e => updateRow(row._idx, 'Note', e.target.value)} onKeyDown={(e) => { if (e.key === 'Enter') { e.preventDefault(); focusNext(e.currentTarget); } }} /></td>

                                            {/* Delta & Balance */}
                                            <td className={`p-2 text-right font-mono ${row._delta >= 0 ? 'text-green-600' : 'text-red-600'}`} title={row._calcDetail}>{formatNumber2(row._delta)}</td>
                                            <td className="p-2 text-right font-mono font-bold text-gray-700">{formatNumber2(row._bal)}</td>
                                        </tr>
                                    ))}
                                </tbody>
                            </table>
                        </div>
                    </div>
                );
            };

            // 5. SPLIT TOOL 
            const renderSplitTool = () => {
                const tickers = uniqueTickers;
                const selected = splitParams.ticker || (tickers[0] || '');

                // 1. Prepare Market Data (Blue Line) -> Convert to Timestamps { x, y }
                const md = marketData[selected];
                const hasData = md && md.history && md.history.length > 0;

                const graphData = hasData ? md.history.map(h => ({
                    x: new Date(h.date).getTime(),
                    y: h.close
                })) : [];

                // 2. Prepare User Trades (Dots)
                const userTrades = txs
                    .filter(tx => tx.ticker === selected && (tx.type === 'BUY' || tx.type === 'SELL'))
                    .map(tx => ({
                        x: tx.date.getTime(),
                        y: tx.price,
                        type: tx.type,
                        dateStr: getLocalISO(tx.date)
                    }));

                // 3. Calculate Impacted Rows based on Range
                const startIso = splitParams.startDateIso || '1900-01-01';
                const endIso = splitParams.endDateIso || '2099-12-31';

                const impactedRows = rows.filter(r => {
                    if ((r['Ticker'] || '').trim() !== selected) return false;
                    const t = determineType(r['Type'], r['Ticker'], r['Qty']);
                    if (!['Stock', 'ETF'].includes(t)) return false; // Only touch Trades

                    const rDate = displayDateToIso(r['Date']);
                    // Range Check (Inclusive)
                    return rDate >= startIso && rDate <= endIso;
                }).length;

                // 4. Graph Click Handler (Set Range)
                const handleChartClick = (e) => {
                    // Recharts sometimes returns null events or missing labels if clicked on empty space
                    if (!e || !e.activeLabel) return;

                    // activeLabel is usually the X-coordinate (timestamp) for number axes
                    // We must convert it safely to an ISO string
                    let clickedDate;
                    try {
                        clickedDate = new Date(e.activeLabel).toISOString().split('T')[0];
                    } catch (err) { return; }

                    setSplitParams(prev => {
                        const hasStart = !!prev.startDateIso;
                        const hasEnd = !!prev.endDateIso;

                        // SCENARIO 1: Fresh Start
                        // If we have (Both) OR (Neither) OR (Only End - the bug source), we reset.
                        if ((hasStart && hasEnd) || (!hasStart && !hasEnd) || (!hasStart && hasEnd)) {
                            return { ...prev, startDateIso: clickedDate, endDateIso: '' };
                        }

                        // SCENARIO 2: Completing the Range
                        // We have a Start, but no End.
                        else {
                            const d1 = prev.startDateIso;
                            const d2 = clickedDate;

                            // Auto-swap if user clicked backwards (clicked 2020 then 2018)
                            if (d2 < d1) {
                                return { ...prev, startDateIso: d2, endDateIso: d1 };
                            }
                            return { ...prev, endDateIso: d2 };
                        }
                    });
                };

                const applySplit = () => {
                    if (!selected) return;
                    const num = parseDanishNumber(splitParams.num) || 0;
                    const den = parseDanishNumber(splitParams.den) || 0;
                    if (num <= 0 || den <= 0) { alert('Invalid ratio'); return; }

                    const ratio = num / den;

                    // VERIFICATION MESSAGE
                    const confirmMsg =
                        `About to apply Split ${num}:${den} to ${selected}.

Target Range: ${startIso} to ${endIso}
Rows Affected: ${impactedRows}

VERIFICATION:
1. Quantity will be multiplied by ${formatNumber2(ratio)}
2. Price will be divided by ${formatNumber2(ratio)}
3. Commission, Tax, and Account will remain UNTOUCHED.

Proceed?`;

                    if (confirm(confirmMsg)) {
                        setRows(prev => {
                            return prev.map(r => {
                                // 1. Filter Ticker
                                if ((r['Ticker'] || '').trim() !== selected) return r;
                                // 2. Filter Type (Strictly Stocks/ETFs only)
                                const t = determineType(r['Type'], r['Ticker'], r['Qty']);
                                if (!['Stock', 'ETF'].includes(t)) return r;
                                // 3. Filter Date Range
                                const rDate = displayDateToIso(r['Date']);
                                if (rDate < startIso || rDate > endIso) return r;

                                // 4. EXECUTE SAFE UPDATE
                                // We spread ...r first to keep all original fields (Commission, etc)
                                // Then we strictly overwrite Qty and Price.
                                return {
                                    ...r,
                                    'Qty': parseDanishNumber(r['Qty']) * ratio,
                                    'Price': parseDanishNumber(r['Price']) / ratio,
                                    'Note': (r['Note'] || '') + ` [Split ${num}:${den}]`
                                };
                            });
                        });
                        alert("Success. Split applied to selected range.");
                        // Reset range to avoid double application
                        setSplitParams(s => ({ ...s, startDateIso: '', endDateIso: '' }));
                    }
                };

                // Helper to get X coordinate for ReferenceArea
                const refStart = splitParams.startDateIso ? new Date(splitParams.startDateIso).getTime() : null;
                const refEnd = splitParams.endDateIso ? new Date(splitParams.endDateIso).getTime() : null;

                return (
                    <div className="p-6 h-full flex flex-col overflow-hidden">
                        <div className="flex justify-between items-center mb-4">
                            <h3 className="font-bold text-lg flex items-center gap-2">
                                <i className="ph ph-arrows-split text-blue-600"></i> Aktiesplit-værktøj
                            </h3>
                            {!hasData && (
                                <span className="text-xs bg-red-100 text-red-700 px-3 py-1 rounded-full font-medium">
                                    Ingen markedsdata. Klik "Opdater priser".
                                </span>
                            )}
                        </div>

                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6 h-full overflow-hidden">

                            {/* LEFT COL: Configuration */}
                            <div className="space-y-6 overflow-y-auto pr-2 custom-scrollbar">

                                {/* A. Auto-Detector  */}
                                {splitCandidates.length > 0 && (
                                    <div className="bg-orange-50 border border-orange-200 rounded-xl p-4">
                                        <div className="flex items-center gap-2 mb-3 text-orange-800 font-bold text-sm uppercase tracking-wide">
                                            <i className="ph ph-warning-circle text-lg"></i> Fundne kandidater
                                        </div>
                                        <div className="space-y-2">
                                            {splitCandidates.map((c, i) => (
                                                <div key={i}
                                                    onClick={() => setSplitParams({
                                                        ticker: c.ticker,
                                                        num: c.suggestedNum,
                                                        den: c.suggestedDen,
                                                        startDateIso: '',
                                                        endDateIso: c.date
                                                    })}
                                                    className="bg-white p-3 rounded border border-orange-100 shadow-sm cursor-pointer hover:border-orange-400 transition-colors group relative">
                                                    <div className="flex justify-between items-center mb-1">
                                                        <span className="font-bold text-gray-800">{c.ticker}</span>
                                                        <span className="text-xs bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full font-bold">
                                                            Muligt {c.suggestedNum}:{c.suggestedDen}
                                                        </span>
                                                    </div>
                                                    <div className="text-xs text-gray-500">
                                                        Afvigelse på: {c.date}
                                                    </div>
                                                    <div className="absolute right-2 bottom-2 opacity-0 group-hover:opacity-100 text-blue-600 text-xs font-bold transition-opacity">
                                                        Vælg &rarr;
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    </div>
                                )}

                                {/* B. The Manual Form */}
                                <div className="card bg-gray-50 border-blue-100">
                                    <h4 className="font-bold text-gray-700 mb-3 text-sm">Split-konfiguration</h4>
                                    <div className="space-y-4">
                                        <div>
                                            <label className="text-xs font-semibold text-gray-500 uppercase">Ticker</label>
                                            <select className="w-full border border-gray-300 p-2 rounded bg-white mt-1"
                                                value={selected}
                                                onChange={e => setSplitParams(s => ({ ...s, ticker: e.target.value }))}>
                                                {tickers.map(t => <option key={t} value={t}>{t}</option>)}
                                            </select>
                                        </div>

                                        <div className="grid grid-cols-2 gap-2">
                                            <div>
                                                <label className="text-xs font-semibold text-gray-500 uppercase">Ny antal</label>
                                                <input className="w-full border p-2 rounded mt-1 font-mono" type="number" value={splitParams.num} onChange={e => setSplitParams(s => ({ ...s, num: e.target.value }))} />
                                            </div>
                                            <div>
                                                <label className="text-xs font-semibold text-gray-500 uppercase">Gammel antal</label>
                                                <input className="w-full border p-2 rounded mt-1 font-mono" type="number" value={splitParams.den} onChange={e => setSplitParams(s => ({ ...s, den: e.target.value }))} />
                                            </div>
                                        </div>

                                        {/* Date Range Inputs */}
                                        <div className="p-3 bg-blue-50 rounded border border-blue-100">
                                            <label className="text-xs font-bold text-blue-800 uppercase flex justify-between">
                                                <span>Anvend interval</span>
                                                <span className="font-normal normal-case text-blue-600 cursor-pointer" onClick={() => setSplitParams(s => ({ ...s, startDateIso: '', endDateIso: '' }))}>Ryd</span>
                                            </label>

                                            <div className="mt-2 space-y-2">
                                                <div>
                                                    <span className="text-[10px] text-gray-500 uppercase">Fra (inkluderet)</span>
                                                    <input type="date" className="w-full border p-1 rounded text-sm"
                                                        value={splitParams.startDateIso}
                                                        onChange={e => setSplitParams(s => ({ ...s, startDateIso: e.target.value }))}
                                                    />
                                                </div>
                                                <div>
                                                    <span className="text-[10px] text-gray-500 uppercase">Til (inkluderet)</span>
                                                    <input type="date" className="w-full border p-1 rounded text-sm"
                                                        value={splitParams.endDateIso}
                                                        onChange={e => setSplitParams(s => ({ ...s, endDateIso: e.target.value }))}
                                                    />
                                                </div>
                                            </div>
                                            <p className="text-[10px] text-blue-600 mt-2 italic">
                                                Tip: Klik på to punkter i grafen for at vælge interval automatisk.
                                            </p>
                                        </div>

                                        <div className="pt-2">
                                            <button onClick={applySplit}
                                                disabled={impactedRows === 0}
                                                className={`w-full py-2 text-white rounded font-medium shadow-sm transition-colors ${impactedRows > 0 ? 'bg-blue-600 hover:bg-blue-700' : 'bg-gray-300 cursor-not-allowed'}`}>
                                                Udfør split ({splitParams.num}:{splitParams.den})
                                            </button>
                                            <p className="text-center text-[10px] text-gray-400 mt-2">
                                                Vil ændre <strong>{impactedRows}</strong> transaktionsrækker.
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* RIGHT COL: The Interactive Graph */}
                            <div className="lg:col-span-2 flex flex-col h-full min-h-[400px]">
                                <div className="card flex-1 flex flex-col">
                                    <div className="flex justify-between items-center mb-4">
                                        <h4 className="font-bold text-gray-700 flex items-center gap-2">
                                            <span className="w-3 h-3 rounded-full bg-blue-500"></span> Markedshistorik
                                            <span className="text-gray-300 mx-2">vs</span>
                                            <span className="w-3 h-3 rounded-full bg-green-500"></span> Dine handler
                                        </h4>
                                    </div>

                                    <div className="flex-1 w-full min-h-0 relative">
                                        {!hasData && (
                                            <div className="absolute inset-0 flex items-center justify-center text-gray-400 z-10">
                                                Ingen markedsdata tilgængelig for {selected}
                                            </div>
                                        )}
                                        <ResponsiveContainer width="100%" height="100%">
                                            <ComposedChart
                                                margin={{ top: 20, right: 30, bottom: 20, left: 10 }}
                                                onClick={handleChartClick} // <--- CLICK TO SELECT RANGE
                                                style={{ cursor: 'crosshair' }}
                                            >
                                                <CartesianGrid strokeDasharray="3 3" vertical={false} stroke="#f0f0f0" />

                                                {/* X Axis: Time Scale */}
                                                <XAxis
                                                    dataKey="x"
                                                    type="number"
                                                    domain={['auto', 'auto']}
                                                    tick={{ fontSize: 10, fill: '#9ca3af' }}
                                                    tickFormatter={(t) => new Date(t).toLocaleDateString()}
                                                    minTickGap={50}
                                                />

                                                {/* Y Axis: Price Scale */}
                                                <YAxis
                                                    dataKey="y"
                                                    width={60}
                                                    tick={{ fontSize: 10, fill: '#9ca3af' }}
                                                    domain={['auto', 'auto']}
                                                    tickFormatter={(v) => formatNumber2(v)}
                                                />

                                                <Tooltip
                                                    contentStyle={{ fontSize: '12px', borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgb(0 0 0 / 0.1)' }}
                                                    formatter={(val, name) => [formatNumber2(val), name]}
                                                    labelFormatter={(label) => new Date(label).toLocaleDateString()}
                                                />

                                                {/* 1. Highlight Selected Range */}
                                                {refStart && refEnd && (
                                                    <ReferenceArea x1={refStart} x2={refEnd} fill="#3b82f6" fillOpacity={0.1} />
                                                )}
                                                {/* If only start is selected, show a line */}
                                                {refStart && !refEnd && (
                                                    <ReferenceLine x={refStart} stroke="#3b82f6" strokeDasharray="3 3" />
                                                )}

                                                {/* 2. Yahoo History (Area) */}
                                                <Area data={graphData} type="monotone" dataKey="y" name="Market Price" stroke="#3b82f6" strokeWidth={2} fillOpacity={0.05} fill="#3b82f6" isAnimationActive={false} />

                                                {/* 3. User BUYS (Scatter) */}
                                                <Scatter data={userTrades.filter(t => t.type === 'BUY')} name="Your Buy" fill="#10b981" shape="circle" isAnimationActive={false} />

                                                {/* 4. User SELLS (Scatter) */}
                                                <Scatter data={userTrades.filter(t => t.type === 'SELL')} name="Your Sell" fill="#ef4444" shape="triangle" isAnimationActive={false} />

                                            </ComposedChart>
                                        </ResponsiveContainer>
                                    </div>
                                    <div className="mt-4 text-xs text-gray-500 bg-blue-50/50 p-3 rounded border border-blue-100 flex gap-4 items-center">
                                        <div className="flex-1">
                                            <strong>Brug:</strong> Klik på grafen for at vælge <span className="text-blue-600 font-bold">startdato</span>. Klik igen for at vælge <span className="text-blue-600 font-bold">slutdato</span>. <br />
                                            Det blå område viser hvilke transaktioner der splittes.
                                        </div>
                                        <div className="text-right">
                                            <span className="block font-bold text-gray-700">Rækker i interval: {impactedRows}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                );
            };

            const updateRow = (idx, k, v) => setRows(prev => {
                const n = [...prev];
                let newVal = v;
                if (k === 'Type') newVal = determineType(v, n[idx]['Ticker'], n[idx]['Qty']);
                if (k === 'Currency') newVal = normalizeCurrency(v);
                n[idx] = { ...n[idx], [k]: newVal };
                return n;
            });
            const loadFromGithub = async () => {
                if (!ghConfig.token) return;
                setStatusMsg('Loading...'); // UI Feedback

                try {
                    const headers = { 'Authorization': `token ${ghConfig.token}` };
                    const repoBase = `https://api.github.com/repos/${ghConfig.owner}/${ghConfig.repo}/contents/`;

                    // 1. Fetch Both Files in Parallel
                    const [resData, resSettings] = await Promise.all([
                        fetch(`${repoBase}${ghConfig.path}`, { headers }),
                        fetch(`${repoBase}portfolio-settings.csv`, { headers }) // Assumes file is named portfolio-settings.csv
                    ]);

                    if (!resData.ok) throw new Error('Repo Error');

                    // 2. Process Data CSV
                    const dataJson = await resData.json();
                    setFileSha(dataJson.sha);
                    const dataCsv = b64_to_utf8(dataJson.content);

                    Papa.parse(dataCsv, {
                        header: true, skipEmptyLines: true,
                        complete: (r) => {
                            const normalized = normalizeAllRows(r.data);
                            setRows(normalized);
                            const errs = validateData(normalized);
                            setSchemaErrors(errs);
                        }
                    });

                    // 3. Process Settings CSV (If it exists)
                    if (resSettings.ok) {
                        const setJson = await resSettings.json();
                        const setCsv = b64_to_utf8(setJson.content);

                        Papa.parse(setCsv, {
                            header: true, skipEmptyLines: true,
                            complete: (r) => {
                                // Parse the 3-column CSV into our Config Object
                                const newConfig = { askAccount: '', currencies: {}, hidden: [] };

                                r.data.forEach(row => {
                                    const type = (row['Type'] || '').trim().toUpperCase();
                                    const key = (row['Key'] || '').trim();
                                    const val = (row['Value'] || '').trim();

                                    if (type === 'ASK') newConfig.askAccount = val;
                                    if (type === 'CURRENCY') newConfig.currencies[key] = val;
                                    if (type === 'HIDDEN') newConfig.hidden.push(key);
                                });

                                setConfig(newConfig);
                                console.log("Settings loaded:", newConfig);
                            }
                        });
                    } else {
                        console.log("No settings file found, using defaults.");
                    }

                    setStatusMsg('Loaded');
                    setTimeout(() => setStatusMsg(''), 2000);

                } catch (e) {
                    console.error(e);
                    setStatusMsg('Error Loading');
                }
            };
            const saveToGithub = async () => {
                if (!ghConfig.token) { setShowSettings(true); return; }
                setStatusMsg('Saving...');
                const sorted = [...rows].sort((a, b) => (parseDanishDate(a['Date']) || 0) - (parseDanishDate(b['Date']) || 0));
                const csv = Papa.unparse(sorted, { columns: CSV_COLUMNS });
                try {
                    const res = await fetch(`https://api.github.com/repos/${ghConfig.owner}/${ghConfig.repo}/contents/${ghConfig.path}`, {
                        method: 'PUT', headers: { 'Authorization': `token ${ghConfig.token}`, 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message: 'Update', content: utf8_to_b64(csv), sha: fileSha })
                    });
                    const d = await res.json();
                    setFileSha(d.content.sha);
                    setStatusMsg('Saved!');
                } catch (e) { setStatusMsg('Err'); }
                setTimeout(() => setStatusMsg(''), 2000);
            };

            const handleFileUpload = (e) => {
                Papa.parse(e.target.files[0], {
                    header: true,
                    skipEmptyLines: true,
                    complete: (r) => {
                        const normalized = normalizeAllRows(r.data);
                        setRows(normalized);
                        const errs = validateData(normalized);
                        setSchemaErrors(errs);
                        if (errs.length > 0) setStatusMsg('Data Warnings Found');
                    }
                });
            };

            // --- LAYOUT ---
            return (
                <div className="flex h-screen w-full bg-white relative font-sans text-gray-800">

                    {/* Anonymity Blur Overlay */}
                    {settings.anonymityBlur && blurActive && (
                        <div className="anonymity-blur-overlay">
                            <div className="anonymity-blur-icon" title="Klik for at vise" onClick={() => { setBlurActive(false); fetchMarketData(false); }}>
                                <i className="ph ph-eye-slash"></i>
                                <span>Vis indhold</span>
                            </div>
                        </div>
                    )}

                    {/* SETTINGS MODAL */}
                    {showSettings && (
                        <div className="absolute inset-0 z-50 bg-black/50 flex items-center justify-center p-4">
                            <div className="bg-white rounded-xl shadow-2xl p-6 w-96 space-y-4">
                                <h2 className="font-bold text-lg">Indstillinger</h2>
                                <input className="w-full border p-2 rounded" placeholder="Ejer (Bruger)" value={ghConfig.owner} onChange={e => setGhConfig({ ...ghConfig, owner: e.target.value })} />
                                <input className="w-full border p-2 rounded" placeholder="Repo-navn" value={ghConfig.repo} onChange={e => setGhConfig({ ...ghConfig, repo: e.target.value })} />
                                <input className="w-full border p-2 rounded" placeholder="Filsti (data.csv)" value={ghConfig.path} onChange={e => setGhConfig({ ...ghConfig, path: e.target.value })} />
                                <input className="w-full border p-2 rounded" type="password" placeholder="GitHub Token (Repo-adgang)" value={ghConfig.token} onChange={e => setGhConfig({ ...ghConfig, token: e.target.value })} />
                                {/* Import CSV moved here */}
                                <div className="flex flex-col gap-2 pt-2">
                                    <label className="flex items-center gap-2 px-3 py-2 bg-white border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 text-sm font-medium cursor-pointer">
                                        <i className="ph ph-upload-simple"></i> Importer CSV
                                        <input type="file" accept=".csv" className="hidden" onChange={handleFileUpload} />
                                    </label>
                                </div>
                                {/* Anonymity Blur Toggle */}
                                <div className="flex items-center gap-2 pt-2">
                                    <input id="anonymity-blur-toggle" type="checkbox" className="accent-blue-600" checked={!!settings.anonymityBlur} onChange={e => setSettings(s => ({ ...s, anonymityBlur: e.target.checked }))} />
                                    <label htmlFor="anonymity-blur-toggle" className="text-sm text-gray-700 cursor-pointer select-none">
                                        Slør app ved tab af fokus (anonymitet)
                                    </label>
                                </div>
                                <div className="flex gap-2">
                                    <button onClick={() => { localStorage.setItem('gh_config', JSON.stringify(ghConfig)); setShowSettings(false); loadFromGithub(); }} className="flex-1 bg-blue-600 text-white py-2 rounded font-medium">Ok</button>
                                    <button onClick={() => setShowSettings(false)} className="px-4 py-2 text-gray-500">Luk</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* SIDEBAR NAVIGATION (hidden on small screens) */}
                    <div className="hidden md:flex md:w-64 bg-gray-50 border-r border-gray-200 flex-col shrink-0">


                        <div className="flex-1 overflow-y-auto p-3 space-y-2">

                            {/* 1. Dashboard */}
                            <button type="button" onClick={() => setView('dashboard')} className={`nav-item w-full text-left ${view === 'dashboard' ? 'active' : ''}`}>
                                <i className="ph ph-chart-line-up text-lg"></i> Oversigt
                            </button>

                            {/* 2. Holdings */}
                            <button type="button" onClick={() => setView('holdings')} className={`nav-item w-full text-left ${view === 'holdings' ? 'active' : ''}`}>
                                <i className="ph ph-briefcase text-lg"></i> Beholdninger
                            </button>


                            {/* 3. Transactions Editor Section */}
                            <div>
                                <button type="button" onClick={() => { setView('editor'); setFilterAccount('All'); }} className={`nav-item w-full text-left ${view === 'editor' && filterAccount === 'All' ? 'active' : ''}`}>
                                    <i className="ph ph-list-dashes text-lg"></i> Transaktioner
                                </button>
                                {/* Account Filters */}
                                <div className="mt-1 space-y-0.5">
                                    {accounts
                                        .filter(acc => !config.hidden.includes(acc)) // 1. Filter out hidden accounts
                                        .map(acc => {
                                            // 2. Lookup currency (default to DKK)
                                            const currency = config.currencies[acc] || 'DKK';

                                            return (
                                                <button
                                                    key={acc}
                                                    onClick={() => { setView('editor'); setFilterAccount(acc); }}
                                                    className={`sub-nav-item ${view === 'editor' && filterAccount === acc ? 'active' : ''} flex justify-between items-center pr-2`}
                                                >
                                                    <span className="truncate" title={acc}>{acc}</span>
                                                    <span className="text-[10px] font-mono text-gray-400 bg-gray-100 px-1 rounded ml-2">
                                                        {currency}
                                                    </span>
                                                </button>
                                            );
                                        })}
                                </div>
                            </div>

                            {/* 4. Tax Report Section */}
                            <div>
                                <button type="button" onClick={() => setView('tax')} className={`nav-item w-full text-left ${view === 'tax' ? 'active' : ''}`}>
                                    <i className="ph ph-bank text-lg"></i> Skatterapport
                                </button>
                                {/* Year Selector */}
                                <div className="mt-1 space-y-0.5">
                                    {years.map(y => (
                                        <button type="button" key={y} onClick={() => { setView('tax'); setTaxYear(y); }} className={`sub-nav-item ${view === 'tax' && taxYear === y ? 'active' : ''}`}>
                                            {y}
                                        </button>
                                    ))}
                                </div>
                            </div>

                            {/* 5. Split Tool (moved to last) */}
                            <button type="button" onClick={() => setView('split')} className={`nav-item w-full text-left ${view === 'split' ? 'active' : ''}`}>
                                <i className="ph ph-arrows-split text-lg"></i> Split-værktøj
                            </button>

                        </div>

                        {/* Bottom Actions: Only Settings button for desktop sidebar */}
                        <div className="p-4 border-t border-gray-200 flex flex-col gap-2">
                            <button onClick={() => setShowSettings(true)} className="w-full flex items-center justify-center gap-2 px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50 text-gray-700">
                                <i className="ph ph-gear-six"></i> Indstillinger
                            </button>
                        </div>
                    </div>

                    {/* MOBILE OVERLAY NAV */}
                    {mobileNavOpen && (
                        <div className="fixed inset-0 z-50 md:hidden">
                            <div className="absolute inset-0 bg-black/40" onClick={() => setMobileNavOpen(false)}></div>
                            {/* CHANGED: right-0 -> left-0 AND border-l -> border-r */}
                            <div className="absolute top-0 left-0 w-64 h-full bg-white shadow-xl border-r border-gray-200 flex flex-col z-10">
                                <div className="p-5 border-b border-gray-200 flex justify-between items-center">
                                    <div className="font-bold text-lg flex items-center gap-2"><i className="ph ph-wallet text-blue-600"></i> Menu</div>
                                    <button onClick={() => setMobileNavOpen(false)} className="text-gray-400 hover:text-gray-700"><i className="ph ph-x"></i></button>
                                </div>

                                <div className="flex-1 overflow-y-auto p-3 space-y-2">
                                    {/* 1. Dashboard */}
                                    <button type="button" onClick={() => { setView('dashboard'); setMobileNavOpen(false); }} className={`nav-item w-full text-left ${view === 'dashboard' ? 'active' : ''}`}>
                                        <i className="ph ph-chart-line-up text-lg"></i> Oversigt
                                    </button>

                                    {/* 2. Holdings */}
                                    <button type="button" onClick={() => { setView('holdings'); setMobileNavOpen(false); }} className={`nav-item w-full text-left ${view === 'holdings' ? 'active' : ''}`}>
                                        <i className="ph ph-briefcase text-lg"></i> Beholdninger
                                    </button>

                                    {/* 3. Transactions Editor Section */}
                                    <div>
                                        <button type="button" onClick={() => { setView('editor'); setFilterAccount('All'); setMobileNavOpen(false); }} className={`nav-item w-full text-left ${view === 'editor' && filterAccount === 'All' ? 'active' : ''}`}>
                                            <i className="ph ph-list-dashes text-lg"></i> Transaktioner
                                        </button>
                                        {/* Account Filters */}
                                        <div className="mt-1 space-y-0.5">
                                            {accounts
                                                .filter(acc => !config.hidden.includes(acc))
                                                .map(acc => {
                                                    const currency = config.currencies[acc] || 'DKK';
                                                    return (
                                                        <button
                                                            key={acc}
                                                            onClick={() => { setView('editor'); setFilterAccount(acc); setMobileNavOpen(false); }}
                                                            className={`sub-nav-item ${view === 'editor' && filterAccount === acc ? 'active' : ''} flex justify-between items-center pr-2`}
                                                        >
                                                            <span className="truncate" title={acc}>{acc}</span>
                                                            <span className="text-[10px] font-mono text-gray-400 bg-gray-100 px-1 rounded ml-2">
                                                                {currency}
                                                            </span>
                                                        </button>
                                                    );
                                                })}
                                        </div>
                                    </div>

                                    {/* 4. Tax Report Section */}
                                    <div>
                                        <button type="button" onClick={() => { setView('tax'); setMobileNavOpen(false); }} className={`nav-item w-full text-left ${view === 'tax' ? 'active' : ''}`}>
                                            <i className="ph ph-bank text-lg"></i> Skatterapport
                                        </button>
                                        {/* Year Selector */}
                                        <div className="mt-1 space-y-0.5">
                                            {years.map(y => (
                                                <button type="button" key={y} onClick={() => { setView('tax'); setTaxYear(y); setMobileNavOpen(false); }} className={`sub-nav-item ${view === 'tax' && taxYear === y ? 'active' : ''}`}>
                                                    {y}
                                                </button>
                                            ))}
                                        </div>
                                    </div>

                                    {/* 5. Split Tool */}
                                    <button type="button" onClick={() => { setView('split'); setMobileNavOpen(false); }} className={`nav-item w-full text-left ${view === 'split' ? 'active' : ''}`}>
                                        <i className="ph ph-arrows-split text-lg"></i> Split-værktøj
                                    </button>
                                </div>

                                {/* Bottom Actions */}
                                <div className="p-4 border-t border-gray-200 flex flex-col gap-2">
                                    <button onClick={() => { setShowSettings(true); setMobileNavOpen(false); }} className="w-full flex items-center justify-center gap-2 px-3 py-2 bg-white border border-gray-300 rounded-lg text-sm font-medium hover:bg-gray-50 text-gray-700">
                                        <i className="ph ph-gear-six"></i> Indstillinger
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* MAIN CONTENT AREA */}
                    <div className="flex-1 flex flex-col h-full overflow-hidden bg-white">

                        {/* Context Header */}
                        <div className="h-14 border-b border-gray-100 flex items-center justify-between px-4 md:px-8 shrink-0 bg-white relative">

                            {/* 1. LEFT: Hamburger Menu (Mobile Only) - Moved here */}
                            <button
                                onClick={() => setMobileNavOpen(true)}
                                className="md:hidden p-2 -ml-2 text-gray-700 hover:text-gray-900"
                                aria-label="Open menu"
                            >
                                <i className="ph ph-list text-2xl"></i>
                            </button>

                            {/* 2. CENTER/LEFT: Title */}
                            <div className="flex-1 flex items-center justify-center md:justify-start">
                                <h1 className="text-xl font-bold text-gray-800 text-center w-full md:w-auto">
                                    {view === 'editor' && (filterAccount === 'All' ? 'Alle transaktioner' : `${filterAccount}`)}
                                    {view === 'dashboard' && 'Oversigt'}
                                    {view === 'holdings' && 'Beholdninger'}
                                    {view === 'split' && 'Split-værktøj'}
                                    {view === 'tax' && `Skatterapport: ${taxYear}`}
                                </h1>
                            </div>

                            {/* 3. RIGHT: Single Unified Update Button */}
                            <div className="flex items-center gap-2">
                                <button
                                    onClick={() => fetchMarketData(false)}
                                    className="p-2 w-10 h-10 rounded-full bg-white border border-gray-200 hover:bg-blue-50 text-blue-600 text-lg shadow-sm flex items-center justify-center"
                                    title={lastUpdate ? `Sidst opdateret: ${lastUpdate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })}` : "Opdater priser"}
                                >
                                    {loading ? <i className="ph ph-spinner animate-spin"></i> : <i className="ph ph-arrows-clockwise"></i>}
                                </button>

                                {/* Status Message Bubble */}
                                {statusMsg && <span className="text-xs bg-gray-100 text-gray-600 px-2 py-1 rounded-full animate-pulse hidden sm:inline-block">{statusMsg}</span>}
                            </div>
                        </div>

                        {/* VALIDATION WARNING BANNER */}
                        {schemaErrors.length > 0 && (
                            <div className="bg-red-50 border-b border-red-200 p-4 max-h-40 overflow-y-auto">
                                <div className="flex items-center gap-2 text-red-800 font-bold mb-2">
                                    <i className="ph ph-warning-circle text-xl"></i>
                                    <span>Dataintegritetsfejl ({schemaErrors.length})</span>
                                    <button onClick={() => setSchemaErrors([])} className="ml-auto text-xs bg-red-100 hover:bg-red-200 px-2 py-1 rounded text-red-700">Luk</button>
                                </div>
                                <ul className="list-disc list-inside text-sm text-red-700 space-y-1 font-mono">
                                    {schemaErrors.map((e, i) => <li key={i}>{e}</li>)}
                                </ul>
                            </div>
                        )}

                        {/* --- CALCULATION WARNINGS BANNER (MISSING LIMITS/RATES) --- */}
                        {calc.warnings && calc.warnings.length > 0 && (
                            <div className="bg-orange-50 border-b border-orange-200 p-4 max-h-40 overflow-y-auto animate-in slide-in-from-top-2">
                                <div className="flex items-center gap-2 text-orange-900 font-bold mb-2">
                                    <i className="ph ph-warning-octagon text-xl text-orange-600"></i>
                                    <span>Kritiske Beregningsfejl ({calc.warnings.length})</span>
                                </div>
                                <div className="text-sm text-orange-800 mb-2">
                                    Følgende mangler forhindrer korrekt skatteberegning:
                                </div>
                                <ul className="list-disc list-inside text-xs text-orange-800 space-y-1 font-mono bg-white/50 p-2 rounded border border-orange-100">
                                    {calc.warnings.map((w, i) => (
                                        <li key={i}>{w}</li>
                                    ))}
                                </ul>
                            </div>
                        )}

                        {/* View Container */}
                        <div className="flex-1 overflow-auto overflow-x-auto bg-gray-50">
                            {view === 'editor' && renderEditor()}
                            {view === 'dashboard' && renderDashboard()}
                            {view === 'holdings' && renderHoldings()}
                            {view === 'split' && renderSplitTool()}
                            {view === 'tax' && renderTaxReport()}
                        </div>
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
</body>

</html>